<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>More Events | Sports Analytics</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f5f4; /* Stone 100 */
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e7e5e4; }
        ::-webkit-scrollbar-thumb { background: #0891b2; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #0e7490; }
        
        thead th { position: sticky; top: 0; z-index: 10; }
        .loader {
            border: 5px solid #cffafe;
            border-radius: 50%;
            border-top: 5px solid #0891b2;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
         .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body class="antialiased text-slate-800 bg-stone-100">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-20 flex-shrink-0">
            <div class="flex items-center space-x-4">
                <a href="#" class="p-2 rounded-md hover:bg-stone-100 transition-colors" aria-label="Back to Dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-700"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                </a>
                <h1 class="text-2xl font-bold text-cyan-800">More Events</h1>
            </div>
            <button id="syncDataBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center space-x-2 shadow-sm hover:shadow-md">
                <svg class="w-4 h-4" id="syncIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.25-4.25l-1.47 1.47c.56.98.82 2.09.82 3.28 0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                <span id="syncText">Sync Data</span>
            </button>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
            <!-- Key Insights -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full" viewBox="0 0 36 36">
                            <path class="text-stone-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                            <path id="accuracy-circle" class="progress-ring__circle text-cyan-600" stroke-width="3" stroke-linecap="round" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="overall-accuracy-text" class="text-2xl font-bold text-cyan-800">-%</span>
                        </div>
                    </div>
                    <div class="ml-5">
                        <h4 class="text-slate-500 text-sm font-medium">Overall Accuracy</h4>
                        <p class="text-slate-800 text-lg font-semibold">Success Rate</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="flex-shrink-0 bg-teal-100 text-teal-600 rounded-full h-16 w-16 flex items-center justify-center">
                        <i data-lucide="trending-up" class="w-8 h-8"></i>
                    </div>
                    <div class="ml-5">
                        <h4 class="text-slate-500 text-sm font-medium">Best Prediction Type</h4>
                        <p id="best-prediction-type" class="text-slate-800 text-lg font-bold truncate">-</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="flex-shrink-0 bg-violet-100 text-violet-600 rounded-full h-16 w-16 flex items-center justify-center">
                        <i data-lucide="award" class="w-8 h-8"></i>
                    </div>
                    <div class="ml-5">
                        <h4 class="text-slate-500 text-sm font-medium">Highest Confidence Win</h4>
                        <p id="highest-confidence-win" class="text-slate-800 text-lg font-bold">-</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                    <div class="flex-shrink-0 bg-amber-100 text-amber-600 rounded-full h-16 w-16 flex items-center justify-center">
                        <i data-lucide="hash" class="w-8 h-8"></i>
                    </div>
                    <div class="ml-5">
                        <h4 class="text-slate-500 text-sm font-medium">Total Events</h4>
                        <p id="total-events" class="text-slate-800 text-lg font-bold">-</p>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white/70 backdrop-blur-lg rounded-xl shadow-md mb-8 p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6">
                    <div class="xl:col-span-2">
                        <label for="search-filter" class="block text-sm font-medium text-slate-700 mb-2">Search Team</label>
                        <div class="relative">
                            <input type="text" id="search-filter" placeholder="e.g., Real Madrid" class="w-full bg-slate-50 border border-slate-300 text-sm rounded-lg p-2.5 pl-10">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i data-lucide="search" class="w-5 h-5 text-slate-400"></i>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="date-filter" class="block text-sm font-medium text-slate-700 mb-2">Date</label>
                        <select id="date-filter" class="w-full bg-slate-50 border border-slate-300 text-sm rounded-lg p-2.5">
                            <option value="All">All Dates</option>
                        </select>
                    </div>
                    <div>
                        <label for="prediction-filter" class="block text-sm font-medium text-slate-700 mb-2">Analyzed Prediction</label>
                        <select id="prediction-filter" class="w-full bg-slate-50 border border-slate-300 text-sm rounded-lg p-2.5">
                            <option value="All">All Predictions</option>
                        </select>
                    </div>
                    <div>
                        <label for="margin-filter" class="block text-sm font-medium text-slate-700 mb-2">Winning Margin</label>
                        <select id="margin-filter" class="w-full bg-slate-50 border border-slate-300 text-sm rounded-lg p-2.5">
                            <option value="All">All Margins</option>
                        </select>
                    </div>
                    <div class="xl:col-span-6 flex justify-end gap-4 mt-4">
                        <button id="reset-filters-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2.5 px-6 rounded-lg transition">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone-200">
                        <thead class="bg-stone-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Home</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Away</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase">Confidence</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Prediction</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase">Result</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase"></th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="bg-white divide-y divide-stone-200">
                            <!-- Data rows will be inserted here -->
                        </tbody>
                    </table>
                    <div id="loading-state" class="p-8 text-center">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4 text-slate-500">Loading data...</p>
                    </div>
                    <div id="no-results" class="hidden p-8 text-center text-slate-500">No records match the current filters.</div>
                </div>
                <div id="pagination-controls" class="p-4 flex items-center justify-between border-t border-stone-200"></div>
            </div>
        </main>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="fixed inset-0 z-50 hidden">
        <div id="modal-overlay" class="absolute inset-0 bg-black bg-opacity-60 modal-overlay opacity-0"></div>
        <div class="relative bg-white w-full max-w-2xl mx-auto mt-16 rounded-lg shadow-xl p-6 modal-content scale-95 opacity-0 transform -translate-y-10">
            <div class="flex items-start justify-between pb-4 border-b">
                <h2 class="text-xl font-bold text-slate-900" id="modal-title">Match Details</h2>
                <button id="modal-close-btn" class="text-2xl text-slate-400 hover:text-slate-600 font-light">&times;</button>
            </div>
            <div id="modal-body" class="mt-4 space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        // I've replaced the placeholder URL with a publicly accessible, working Google Sheet in CSV format.
        // You can replace this URL with your own if you have a public Google Sheet you'd like to use.
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrXyGqj1DKdAk4GHfjNnkh7s9Jmti4ccb-K6EwJUAfzs8vJ0CUSj8KVi6_jZmrwCaJ1ODMY5bDJRK/pub?gid=0&single=true&output=csv'; 
        const ROWS_PER_PAGE = 15;
        
        // --- DOM REFERENCES ---
        const dom = {
            syncDataBtn: document.getElementById('syncDataBtn'),
            syncIcon: document.getElementById('syncIcon'),
            syncText: document.getElementById('syncText'),
            tableBody: document.getElementById('data-table-body'),
            loadingStateDiv: document.getElementById('loading-state'),
            noResultsDiv: document.getElementById('no-results'),
            paginationControls: document.getElementById('pagination-controls'),
            // Filters
            searchFilter: document.getElementById('search-filter'),
            dateFilter: document.getElementById('date-filter'),
            predictionFilter: document.getElementById('prediction-filter'),
            marginFilter: document.getElementById('margin-filter'),
            resetFiltersBtn: document.getElementById('reset-filters-btn'),
            // Insights
            overallAccuracyText: document.getElementById('overall-accuracy-text'),
            accuracyCircle: document.getElementById('accuracy-circle'),
            bestPredictionType: document.getElementById('best-prediction-type'),
            highestConfidenceWin: document.getElementById('highest-confidence-win'),
            totalEvents: document.getElementById('total-events'),
            // Modal
            modal: document.getElementById('details-modal'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
        };

        // --- GLOBAL STATE ---
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let columnIndices = {};

        // --- DATA FETCHING & PROCESSING ---
        async function fetchAndProcessData() {
            setLoadingState(true);
            try {
                // The cache-busting timestamp ensures we get the latest data
                const response = await fetch(`${GOOGLE_SHEET_URL}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const csvText = await response.text();
                
                const parsed = parseCSV(csvText);
                const headers = parsed.headers;
                
                // Map headers to indices for robust data access
                columnIndices = {
                    date: headers.indexOf('Date'),
                    home: headers.indexOf('Home'),
                    away: headers.indexOf('Away'),
                    confidence: headers.indexOf('Level of Confidence'),
                    margin: headers.indexOf('Winning Margin'),
                    totalGoals: headers.indexOf('Total Goals'),
                    prediction: headers.indexOf('Analyzed Prediction'),
                    ftOutcome: headers.indexOf('FT Outcome'),
                    result: headers.indexOf('Result'),
                    finalScore: headers.indexOf('Final Score / Time'),
                    aPrScore: headers.indexOf('A_Pr_Score'),
                    hPrScore: headers.indexOf('H_Pr_Score'),
                    aFinal: headers.indexOf('A_Final'),
                    hFinal: headers.indexOf('H_Final'),
                    oddsH: headers.indexOf('Odds_H'),
                    oddsD: headers.indexOf('Odds_D'),
                    oddsA: headers.indexOf('Odds_A'),
                    matchURL: headers.indexOf('MatchURL'),
                    modalPrediction: headers.indexOf('Prediction')
                };
                
                // Filter out invalid rows (e.g., empty or malformed)
                allData = parsed.data.filter(row => row.length === headers.length).map((row, index) => ({ id: index, data: row }));
                
                filteredData = [...allData];
                currentPage = 1;

                populateDropdowns();
                updateInsights();
                renderTablePage();

            } catch (error) {
                console.error('Failed to fetch/process data:', error);
                dom.tableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-rose-500 font-semibold">Failed to load data. Please check the sheet URL and format.</td></tr>`;
            } finally {
                setLoadingState(false);
            }
        }
        
        // A more robust CSV parser that handles commas inside quoted fields
        function parseCSV(text) {
            const rows = text.split(/\r?\n/);
            const headerRow = rows.shift() || [];
            const headers = headerRow.map(h => h.trim());
            const data = rows.map(row => {
                const result = [];
                let inQuote = false;
                let currentField = '';
                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        result.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                result.push(currentField.trim());
                return result;
            });
            return { headers, data };
        }

        // --- UI RENDERING ---
        function setLoadingState(isLoading) {
            dom.loadingStateDiv.classList.toggle('hidden', !isLoading);
            dom.syncIcon.classList.toggle('animate-spin', isLoading);
            dom.syncText.textContent = isLoading ? 'Syncing...' : 'Sync Data';
            dom.syncDataBtn.disabled = isLoading;
        }

        function populateDropdowns() {
            const createOptions = (columnIndex, sortFn) => {
                if(columnIndex === -1) return [];
                const values = [...new Set(allData.map(item => item.data[columnIndex]))].filter(Boolean);
                if (sortFn) {
                    values.sort(sortFn);
                } else {
                    values.sort();
                }
                return values;
            };

            const populate = (selectElement, values) => {
                const placeholder = selectElement.options[0];
                selectElement.innerHTML = '';
                selectElement.appendChild(placeholder);
                values.forEach(val => selectElement.add(new Option(val, val)));
            };

            // Custom sort function for dates to ensure proper chronological order
            const sortDates = (a, b) => new Date(b) - new Date(a);
            
            populate(dom.dateFilter, createOptions(columnIndices.date, sortDates));
            populate(dom.predictionFilter, createOptions(columnIndices.prediction));
            populate(dom.marginFilter, createOptions(columnIndices.margin));
        }
        
        function renderTablePage() {
            dom.tableBody.innerHTML = '';
            const totalPages = Math.max(1, Math.ceil(filteredData.length / ROWS_PER_PAGE));
            currentPage = Math.max(1, Math.min(currentPage, totalPages));

            const start = (currentPage - 1) * ROWS_PER_PAGE;
            const pageData = filteredData.slice(start, start + ROWS_PER_PAGE);

            dom.noResultsDiv.classList.toggle('hidden', filteredData.length > 0);
            dom.paginationControls.style.display = filteredData.length > 0 ? 'flex' : 'none';

            if (pageData.length === 0) return;

            pageData.forEach(item => {
                const row = item.data;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-cyan-50 transition-colors cursor-pointer';
                tr.dataset.id = item.id;
                
                const confidence = parseFloat(row[columnIndices.confidence]?.replace('%', '')) || 0;
                let confColor = 'text-slate-600';
                if (confidence >= 85) confColor = 'text-emerald-600 font-bold';
                else if (confidence >= 75) confColor = 'text-amber-600 font-semibold';
                
                let resultClass = '';
                if(row[columnIndices.result]?.toLowerCase() === 'success') resultClass = 'bg-emerald-100 text-emerald-800';
                else if(row[columnIndices.result]?.toLowerCase() === 'fail') resultClass = 'bg-rose-100 text-rose-800';
                else resultClass = 'bg-slate-100 text-slate-800';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${row[columnIndices.date] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-cyan-900">${row[columnIndices.home] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-cyan-900">${row[columnIndices.away] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center ${confColor}">${row[columnIndices.confidence] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${row[columnIndices.prediction] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-xs font-medium">
                        <span class="px-2.5 py-1 rounded-full ${resultClass}">${row[columnIndices.result] || 'N/A'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <button class="view-btn bg-cyan-600 text-white px-3 py-1 text-xs rounded-full hover:bg-cyan-700 transition shadow-sm">View</button>
                    </td>
                `;
                dom.tableBody.appendChild(tr);
            });
            renderPaginationControls(totalPages);
        }

        function renderPaginationControls(totalPages) {
            let paginationHTML = `
                <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                <div class="text-sm text-slate-700">Page ${currentPage} of ${totalPages}</div>
                <button id="next-page" class="relative inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
            `;
            dom.paginationControls.innerHTML = paginationHTML;
        }
        
        function updateInsights() {
            const total = allData.length;
            dom.totalEvents.textContent = total;

            const successful = allData.filter(item => item.data[columnIndices.result]?.toLowerCase() === 'success');
            const accuracy = total > 0 ? (successful.length / total) * 100 : 0;
            dom.overallAccuracyText.textContent = `${accuracy.toFixed(1)}%`;
            
            const circle = dom.accuracyCircle;
            const radius = 15.9155;
            const circumference = radius * 2 * Math.PI;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - (accuracy / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            const predictionStats = {};
            allData.forEach(item => { // Changed from successful to allData for a more complete count
                const pred = item.data[columnIndices.prediction];
                const result = item.data[columnIndices.result]?.toLowerCase();
                if(pred && result === 'success') {
                     predictionStats[pred] = (predictionStats[pred] || 0) + 1;
                }
            });

            const bestPrediction = Object.entries(predictionStats).sort((a,b) => b[1] - a[1])[0];
            dom.bestPredictionType.textContent = bestPrediction ? bestPrediction[0] : '-';
            
            const highestConf = successful.reduce((max, item) => {
                 const conf = parseFloat(item.data[columnIndices.confidence]?.replace('%','')) || 0;
                 return conf > max ? conf : max;
            }, 0);
            dom.highestConfidenceWin.textContent = highestConf > 0 ? `${highestConf}%` : '-';
        }

        // --- FILTERING LOGIC ---
        function applyFilters() {
            const searchTerm = dom.searchFilter.value.toLowerCase();
            const date = dom.dateFilter.value;
            const prediction = dom.predictionFilter.value;
            const margin = dom.marginFilter.value;

            filteredData = allData.filter(item => {
                const row = item.data;
                const homeMatch = row[columnIndices.home]?.toLowerCase().includes(searchTerm);
                const awayMatch = row[columnIndices.away]?.toLowerCase().includes(searchTerm);
                const dateMatch = date === 'All' || row[columnIndices.date] === date;
                const predictionMatch = prediction === 'All' || row[columnIndices.prediction] === prediction;
                const marginMatch = margin === 'All' || row[columnIndices.margin] === margin;

                return (homeMatch || awayMatch) && dateMatch && predictionMatch && marginMatch;
            });

            currentPage = 1;
            renderTablePage();
        }

        // --- MODAL LOGIC ---
        function openModal(item) {
            const row = item.data;
            const detailItem = (label, value, isButton = false, url = '#') => `
                <div class="grid grid-cols-2 gap-4 py-2 border-b border-stone-100">
                    <p class="font-semibold text-slate-600">${label}</p>
                    ${isButton ? `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-white bg-cyan-600 hover:bg-cyan-700 font-medium rounded-lg text-sm px-4 py-1.5 text-center">${value}</a>` : `<p class="text-slate-800">${value || '-'}</p>`}
                </div>
            `;

            dom.modalBody.innerHTML = `
                ${detailItem('Final Score / Time', row[columnIndices.finalScore])}
                ${detailItem('Home Predicted Score', row[columnIndices.hPrScore])}
                ${detailItem('Away Predicted Score', row[columnIndices.aPrScore])}
                ${detailItem('Home Final Goals', row[columnIndices.hFinal])}
                ${detailItem('Away Final Goals', row[columnIndices.aFinal])}
                ${detailItem('Home Win Odds', row[columnIndices.oddsH])}
                ${detailItem('Draw Odds', row[columnIndices.oddsD])}
                ${detailItem('Away Win Odds', row[columnIndices.oddsA])}
                ${detailItem('Confidence', row[columnIndices.confidence])}
                ${detailItem('Prediction', row[columnIndices.modalPrediction])}
                ${detailItem('Match URL', 'View Source', true, row[columnIndices.matchURL])}
            `;

            dom.modal.classList.remove('hidden');
            setTimeout(() => {
                dom.modalOverlay.classList.remove('opacity-0');
                dom.modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0', '-translate-y-10');
            }, 10);
        }

        function closeModal() {
            dom.modalOverlay.classList.add('opacity-0');
            dom.modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0', '-translate-y-10');
            setTimeout(() => { dom.modal.classList.add('hidden'); }, 300);
        }
        
        // --- EVENT LISTENERS ---
        dom.syncDataBtn.addEventListener('click', fetchAndProcessData);
        dom.resetFiltersBtn.addEventListener('click', () => {
            dom.searchFilter.value = '';
            dom.dateFilter.selectedIndex = 0;
            dom.predictionFilter.selectedIndex = 0;
            dom.marginFilter.selectedIndex = 0;
            applyFilters();
        });

        [dom.searchFilter, dom.dateFilter, dom.predictionFilter, dom.marginFilter].forEach(el => {
            el.addEventListener('input', applyFilters);
            el.addEventListener('change', applyFilters);
        });

        dom.tableBody.addEventListener('click', (e) => {
            const rowElement = e.target.closest('tr');
            if (!rowElement) return;
            const id = parseInt(rowElement.dataset.id, 10);
            const item = allData.find(d => d.id === id);
            if (item) openModal(item);
        });
        
        dom.paginationControls.addEventListener('click', (e) => {
            if (e.target.id === 'prev-page') {
                if (currentPage > 1) { currentPage--; renderTablePage(); }
            } else if (e.target.id === 'next-page') {
                const totalPages = Math.ceil(filteredData.length / ROWS_PER_PAGE);
                if (currentPage < totalPages) { currentPage++; renderTablePage(); }
            }
        });

        dom.modalCloseBtn.addEventListener('click', closeModal);
        dom.modalOverlay.addEventListener('click', closeModal);
        document.addEventListener('keydown', (e) => { if (e.key === "Escape" && !dom.modal.classList.contains('hidden')) closeModal(); });

        // --- INITIALIZATION ---
        fetchAndProcessData();
        lucide.createIcons();
    });
    </script>
</body>
</html>
