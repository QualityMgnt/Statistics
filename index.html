<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Data Navigator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Use the Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Style for table headers to make them sticky and sortable */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        thead th:hover {
            background-color: #e5e7eb; /* Slightly darker on hover */
        }
        /* Styles for sorting indicators */
        .sort-asc::after {
            content: ' ▲';
            font-size: 0.8em;
        }
        .sort-desc::after {
            content: ' ▼';
            font-size: 0.8em;
        }

        /* Loading Spinner Animation */
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #034694; /* Chelsea Blue */
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Disabled button style */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* Modal Styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        
        /* Tab Styles */
        .tab-btn.active {
            border-color: #034694; /* Chelsea Blue */
            color: #034694;
            background-color: #ffffff;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-6 flex items-center space-x-4">
             <img src="https://upload.wikimedia.org/wikipedia/en/c/cc/Chelsea_FC.svg" alt="Club Logo" class="h-12 w-12">
            <h1 class="text-4xl font-extrabold text-gray-900 bg-gradient-to-r from-blue-800 to-blue-500 bg-clip-text text-transparent">Sports Data Dashboard</h1>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-dashboard" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Dashboard
                </button>
                <button id="tab-statares" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Statares
                </button>
                <button id="tab-forestats" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    ForeStats
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main>
            <!-- Dashboard Content -->
            <div id="content-dashboard" class="tab-content">
                <!-- Analytics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow flex items-center">
                        <div class="bg-blue-100 rounded-full p-3 mr-4">
                            <svg class="w-6 h-6 text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Total Matches</p>
                            <p id="totalMatches" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow flex items-center">
                        <div class="bg-green-100 rounded-full p-3 mr-4">
                             <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Win Rate</p>
                            <p id="winRate" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow flex items-center">
                        <div class="bg-yellow-100 rounded-full p-3 mr-4">
                             <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Avg. Total Goals</p>
                            <p id="avgGoals" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow lg:col-span-2">
                        <div class="flex items-start">
                            <div class="bg-blue-100 rounded-full p-3 mr-4">
                                <svg class="w-6 h-6 text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Special Picks (Odds 1.3-1.5 & >80% Conf.)</p>
                                <div id="specialPicks" class="mt-2 text-sm text-gray-900">
                                     <p class="text-gray-400">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                        <div class="lg:col-span-2">
                            <label for="searchFilter" class="block text-sm font-medium text-gray-700 mb-2">Search Team</label>
                            <input type="text" id="searchFilter" placeholder="Enter team name..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition">
                        </div>
                         <div>
                             <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                             <select id="dateFilter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition">
                                <option value="All">All Dates</option>
                            </select>
                        </div>
                        <div>
                             <label for="outcomeFilter" class="block text-sm font-medium text-gray-700 mb-2">Match Outcome</label>
                             <select id="outcomeFilter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition">
                                <option value="All">All Outcomes</option>
                                <option value="Home Win">Home Win</option>
                                <option value="Away Win">Away Win</option>
                                <option value="Draw">Draw</option>
                            </select>
                        </div>
                        <div>
                            <label for="chanceFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Chance</label>
                            <select id="chanceFilter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition">
                                <option value="All">All Chances</option>
                            </select>
                        </div>
                        <div>
                            <label for="winningMarginFilter" class="block text-sm font-medium text-gray-700 mb-2">Winning Margin Met</label>
                            <select id="winningMarginFilter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition">
                                <option value="All">All</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                        <div class="col-span-full flex justify-between items-center gap-4 mt-4">
                            <button id="massFetchBtn" disabled class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:-translate-y-0.5 disabled:bg-gray-400 disabled:shadow-none disabled:transform-none">
                                Fetch Selected
                            </button>
                            <div class="flex gap-4">
                                <button id="resetFilters" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2.5 px-6 rounded-lg transition duration-300 ease-in-out">
                                    Reset
                                </button>
                                <button id="applyFilters" class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2.5 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                    Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table Section -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div id="table-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <!-- Table headers will be populated by JavaScript -->
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                                 <tr><td colspan="14" class="p-8 text-center text-gray-500"><div class="loader mx-auto"></div><p class="mt-4">Loading data...</p></td></tr>
                            </tbody>
                        </table>
                         <div id="no-results" class="hidden p-8 text-center text-gray-500">
                            No records match the current filters.
                        </div>
                    </div>
                     <!-- Pagination Controls -->
                    <div id="pagination-controls" class="p-4 flex items-center justify-between border-t border-gray-200">
                        <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Previous
                        </button>
                        <div class="text-sm text-gray-700" id="page-info">
                            Page 1 of 1
                        </div>
                        <button id="next-page" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statares Content -->
            <div id="content-statares" class="tab-content hidden">
                 <div class="bg-white p-12 rounded-xl shadow-md text-center">
                    <h2 class="text-2xl font-bold text-gray-800">Statares Tab</h2>
                    <p class="mt-2 text-gray-600">This section is under construction. Advanced statistics will be available here soon.</p>
                </div>
            </div>

            <!-- ForeStats Content -->
            <div id="content-forestats" class="tab-content hidden">
                <div class="bg-white p-12 rounded-xl shadow-md text-center">
                    <h2 class="text-2xl font-bold text-gray-800">ForeStats Tab</h2>
                    <p class="mt-2 text-gray-600">This section is under construction. Forecasting tools will be available here soon.</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Powered by Google Sheets & Tailwind CSS. Match fetching is a simulation.</p>
        </footer>
    </div>

    <!-- Modal for "View More" -->
    <div id="details-modal" class="fixed inset-0 z-50 hidden">
        <div id="modal-overlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay opacity-0"></div>
        <div class="relative bg-white w-full max-w-2xl mx-auto mt-20 rounded-lg shadow-xl p-6 modal-content scale-95">
            <div class="flex items-start justify-between">
                <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Match Details</h2>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-body" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrXyGqj1DKdAk4GHfjNnkh7s9Jmti4ccb-K6EwJUAfzs8vJ0CUSj8KVi6_jZmrwCaJ1ODMY5bDJRK/pub?gid=33741-31&single=true&output=csv';
        const ROWS_PER_PAGE = 20;
        // Columns to show in the main table
        const VISIBLE_HEADERS = ['Date', 'Home Team', 'Away Team', 'Home Odds', 'Draw Odds', 'Away Odds', 'Confidence', 'Correct Score', 'Form', 'Margin'];
        
        // --- DOM ELEMENT REFERENCES ---
        const tableBody = document.getElementById('dataTableBody');
        const tableHeader = document.querySelector('thead tr');
        const noResultsDiv = document.getElementById('no-results');
        
        // Filters
        const searchFilter = document.getElementById('searchFilter');
        const dateFilter = document.getElementById('dateFilter');
        const outcomeFilter = document.getElementById('outcomeFilter');
        const chanceFilter = document.getElementById('chanceFilter');
        const winningMarginFilter = document.getElementById('winningMarginFilter');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const massFetchBtn = document.getElementById('massFetchBtn');

        // Analytics Cards
        const totalMatchesCard = document.getElementById('totalMatches');
        const winRateCard = document.getElementById('winRate');
        const avgGoalsCard = document.getElementById('avgGoals');
        const specialPicksCard = document.getElementById('specialPicks');

        // Pagination
        const paginationControls = document.getElementById('pagination-controls');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        
        // Modal
        const modal = document.getElementById('details-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        // Tabs
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        let allData = [];
        let currentFilteredData = [];
        let originalHeaders = [];
        let visibleHeaderIndices = [];
        let sortState = { column: null, direction: 'asc' };
        let currentPage = 1;

        // --- CORE FUNCTIONS ---

        async function init() {
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                const csvText = await response.text();
                const parsed = parseCSV(csvText);
                originalHeaders = parsed.headers;
                allData = parsed.data;
                currentFilteredData = [...allData];

                visibleHeaderIndices = VISIBLE_HEADERS.map(h => originalHeaders.indexOf(h));
                
                renderHeaders();
                populateDropdowns();
                applyFilters();

            } catch (error) {
                console.error('Failed to fetch or process data:', error);
                tableBody.innerHTML = `<tr><td colspan="${VISIBLE_HEADERS.length + 4}" class="p-8 text-center text-red-500 font-semibold">Failed to load data. Please check the Google Sheet URL and ensure it's published correctly.</td></tr>`;
            }
        }

        function parseCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(','));
            const headerRow = rows.shift() || [];
            const cleanedHeaders = headerRow.map(h => h.trim());
            const data = rows.filter(row => row.length === cleanedHeaders.length && row.some(cell => cell.trim() !== ''));
            return { headers: cleanedHeaders, data };
        }

        function renderHeaders() {
            const extraHeaders = ['Accuracy', 'Match Outcome', 'Details'];
            const checkboxHeader = '<th scope="col" class="px-6 py-3"><input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"></th>';
            tableHeader.innerHTML = checkboxHeader + VISIBLE_HEADERS.map((header, index) => {
                const originalIndex = visibleHeaderIndices[index];
                let classes = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                if (sortState.column === originalIndex) {
                    classes += sortState.direction === 'asc' ? ' sort-asc' : ' sort-desc';
                }
                // The 'Form' and 'Margin' columns shouldn't be sortable
                if (header === 'Form' || header === 'Margin') {
                    return `<th scope="col" class="${classes}">${header.replace(/_/g, ' ')}</th>`;
                }
                return `<th scope="col" data-original-index="${originalIndex}" class="${classes}">${header.replace(/_/g, ' ')}</th>`;
            }).join('') + extraHeaders.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('');
            
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                tableBody.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
                updateMassFetchButtonState();
            });
        }

        function populateDropdowns() {
            const dateIndex = originalHeaders.indexOf('Date');
            const chanceIndex = originalHeaders.indexOf('Chance');
            
            if (dateIndex !== -1) {
                const dates = [...new Set(allData.map(row => row[dateIndex]).filter(Boolean))].sort();
                dates.forEach(date => dateFilter.add(new Option(date, date)));
            }
            if (chanceIndex !== -1) {
                const chances = [...new Set(allData.map(row => row[chanceIndex]).filter(Boolean))].sort();
                chances.forEach(chance => chanceFilter.add(new Option(chance, chance)));
            }
        }
        
        function applyFilters() {
            const filters = {
                date: dateFilter.value,
                outcome: outcomeFilter.value,
                chance: chanceFilter.value,
                winningMargin: winningMarginFilter.value,
                search: searchFilter.value.toLowerCase(),
            };

            const indices = {
                date: originalHeaders.indexOf('Date'),
                homeTeam: originalHeaders.indexOf('Home Team'),
                awayTeam: originalHeaders.indexOf('Away Team'),
                chance: originalHeaders.indexOf('Chance'),
                winningMargin: originalHeaders.indexOf('Winning Margin Met'),
            };
            
            let filtered = allData.filter(row => {
                const dateMatch = filters.date === 'All' || row[indices.date] === filters.date;
                const chanceMatch = filters.chance === 'All' || row[indices.chance] === filters.chance;
                const winningMarginMatch = filters.winningMargin === 'All' || row[indices.winningMargin] === filters.winningMargin;
                const searchMatch = !filters.search || row[indices.homeTeam].toLowerCase().includes(filters.search) || row[indices.awayTeam].toLowerCase().includes(filters.search);
                const outcomeMatch = filters.outcome === 'All' || getWinner(row) === filters.outcome;
                
                return dateMatch && chanceMatch && winningMarginMatch && searchMatch && outcomeMatch;
            });

            if (sortState.column !== null) {
                filtered.sort((a, b) => {
                    let valA = a[sortState.column];
                    let valB = b[sortState.column];
                    if (!isNaN(valA) && !isNaN(valB) && valA.trim() !== '' && valB.trim() !== '') {
                        return sortState.direction === 'asc' ? valA - valB : valB - valA;
                    }
                    return sortState.direction === 'asc' ? (valA || '').localeCompare(valB || '') : (valB || '').localeCompare(valA || '');
                });
            }
            
            currentFilteredData = filtered;
            currentPage = 1;
            renderPage();
            updateAnalytics(currentFilteredData);
        }

        function renderPage() {
            const totalPages = Math.max(1, Math.ceil(currentFilteredData.length / ROWS_PER_PAGE));
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            const start = (currentPage - 1) * ROWS_PER_PAGE;
            const end = start + ROWS_PER_PAGE;
            renderTable(currentFilteredData.slice(start, end));
            updatePaginationControls(totalPages);
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            noResultsDiv.classList.toggle('hidden', currentFilteredData.length > 0);
            paginationControls.classList.toggle('hidden', currentFilteredData.length === 0);

            if (data.length === 0) return;

            data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-200';
                
                const checkboxCell = `<td class="px-6 py-4"><input type="checkbox" class="row-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-row-index="${rowIndex}"></td>`;

                let cells = visibleHeaderIndices.map(index => {
                    const headerName = originalHeaders[index];
                    if (headerName === 'Form') {
                         return `<td class="px-6 py-4 whitespace-nowrap text-sm">${renderFormCell(row)}</td>`;
                    }
                    if (headerName === 'Margin') {
                         return `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${getMarginValue(row)}</td>`;
                    }
                    return `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[index] || '-'}</td>`;
                }).join('');

                const accuracyCell = `<td class="px-6 py-4 whitespace-nowrap text-lg">${getAccuracySymbol(row)}</td>`;
                const outcomeCell = `<td class="px-6 py-4 whitespace-nowrap text-sm text-center font-medium">${getMatchOutcome(row)}</td>`;
                const detailsCell = `<td class="px-6 py-4 whitespace-nowrap text-sm"><button class="view-more-btn font-medium text-blue-800 hover:text-blue-600">View More</button></td>`;
                
                tr.innerHTML = checkboxCell + cells + accuracyCell + outcomeCell + detailsCell;
                tr.querySelector('.view-more-btn').addEventListener('click', () => openModal(row));
                tableBody.appendChild(tr);
            });
            updateMassFetchButtonState();
        }
        
        function getMarginValue(row) {
            const homeOddsIndex = originalHeaders.indexOf('Home Odds');
            const drawOddsIndex = originalHeaders.indexOf('Draw Odds');
            const awayOddsIndex = originalHeaders.indexOf('Away Odds');

            const homeOdds = parseFloat(row[homeOddsIndex]);
            const drawOdds = parseFloat(row[drawOddsIndex]);
            const awayOdds = parseFloat(row[awayOddsIndex]);

            // Only proceed if all necessary odds are valid numbers
            if (!isNaN(homeOdds) && !isNaN(drawOdds) && !isNaN(awayOdds)) {
                if ((homeOdds * 2) < drawOdds && (homeOdds * 2) < awayOdds) {
                    return '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Best Margin</span>';
                }

                if ((awayOdds * 2) < drawOdds && (awayOdds * 2) < homeOdds) {
                    return '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Away Best Margin</span>';
                }
            }

            // If data is incomplete or no special margin is found, return "Normal"
            return '<span class="text-gray-600">Normal</span>';
        }

        function renderFormCell(row) {
            const homeFormIndex = originalHeaders.indexOf('Home Form');
            const awayFormIndex = originalHeaders.indexOf('Away Form');
            const homeForm = row[homeFormIndex];
            const awayForm = row[awayFormIndex];
            return `<div>
                        <div class="flex items-center mb-1">${renderFormHTML(homeForm)}</div>
                        <div class="flex items-center">${renderFormHTML(awayForm)}</div>
                    </div>`;
        }
        
        function renderFormHTML(formString) {
            if (!formString || typeof formString !== 'string') return '<span class="text-gray-400 text-xs">-</span>';
            const mapping = { 'W': 'bg-green-500', 'D': 'bg-gray-400', 'L': 'bg-red-500' };
            return [...formString.trim()].map(char => {
                const color = mapping[char.toUpperCase()] || 'bg-gray-200';
                return `<span title="${char}" class="inline-block w-3 h-3 ${color} rounded-full mr-1"></span>`;
            }).join('');
        }
        
        function getWinner(row) {
            const finalScoreIndex = originalHeaders.indexOf('Final Score / Time');
            const finalScore = row[finalScoreIndex];
            if (!finalScore || !finalScore.includes('-')) return 'pending';

            const scoreParts = finalScore.split('-').map(s => parseInt(s.trim()));
            if (scoreParts.length !== 2 || isNaN(scoreParts[0]) || isNaN(scoreParts[1])) return 'pending';

            const [homeScore, awayScore] = scoreParts;
            if (homeScore > awayScore) return 'Home Win';
            if (awayScore > homeScore) return 'Away Win';
            return 'Draw';
        }

        async function fetchMatchOutcome(buttonElement) {
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<svg class="animate-spin h-4 w-4 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            // --- REAL-WORLD API IMPLEMENTATION ---
            // In a real application, you would make a call to a sports data API here.
            // Direct scraping from sites like Flashscore is blocked by browser security (CORS).
            // Example of what a real API call would look like:
            //
            // const homeTeam = buttonElement.dataset.hometeam;
            // const awayTeam = buttonElement.dataset.awayteam;
            // const API_KEY = 'YOUR_REAL_API_KEY';
            // try {
            //   const response = await fetch(`https://api.sportsprovider.com/v1/scores?home=${homeTeam}&away=${awayTeam}&apiKey=${API_KEY}`);
            //   const data = await response.json();
            //   const result = data.score; // e.g., "2 - 1"
            //   const parentTd = buttonElement.parentElement;
            //   if (parentTd) {
            //     parentTd.innerHTML = `<span class="text-gray-800 font-bold">${result}</span>`;
            //   }
            // } catch (error) {
            //   console.error("API Error:", error);
            //   buttonElement.parentElement.innerHTML = '<span class="text-red-500 text-xs">Error</span>';
            // }

            // --- SIMULATION of the API call ---
            await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000)); // Simulate network delay
            const homeScore = Math.floor(Math.random() * 4);
            const awayScore = Math.floor(Math.random() * 4);
            const result = `${homeScore} - ${awayScore}`;
            
            const parentTd = buttonElement.parentElement;
            if (parentTd) {
                parentTd.innerHTML = `<span class="text-gray-800 font-bold">${result}</span>`;
            }
        }

        function getAccuracySymbol(row) {
            const correctScoreIndex = originalHeaders.indexOf('Correct Score');
            const finalScoreIndex = originalHeaders.indexOf('Final Score / Time');
            
            const predictedScore = row[correctScoreIndex];
            const finalScore = row[finalScoreIndex];

            if (!predictedScore || !finalScore || !finalScore.includes('-')) return '<span class="text-gray-400">-</span>';

            const parseScore = (scoreStr) => scoreStr.split('-').map(s => parseInt(s.trim()));
            const [pHome, pAway] = parseScore(predictedScore);
            const [fHome, fAway] = parseScore(finalScore);

            if (isNaN(pHome) || isNaN(pAway) || isNaN(fHome) || isNaN(fAway)) return '<span class="text-gray-400">-</span>';

            const predictedWinner = pHome > pAway ? 'home' : pAway > pHome ? 'away' : 'draw';
            const actualWinner = fHome > fAway ? 'home' : fAway > fHome ? 'away' : 'draw';

            return predictedWinner === actualWinner 
                ? '<span class="text-green-500 font-bold">✓</span>' 
                : '<span class="text-red-500 font-bold">✗</span>';
        }

        function getMatchOutcome(row) {
            const finalScoreIndex = originalHeaders.indexOf('Final Score / Time');
            const dateIndex = originalHeaders.indexOf('Date');
            const finalScore = row[finalScoreIndex];
            const dateStr = row[dateIndex];
            
            if (finalScore && finalScore.includes('-')) {
                return `<span class="text-gray-800 font-bold">${finalScore}</span>`;
            }

            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today's date
                
                // Handle MM/DD/YYYY format
                const dateParts = dateStr.split('/');
                if (dateParts.length !== 3) throw new Error("Invalid date format");
                const matchDate = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);

                if (matchDate > today) {
                    return '<span class="text-gray-400 text-xs italic">Future Match</span>';
                }
            } catch (e) {
                // If date is invalid, assume we can't fetch.
                return '<span class="text-gray-400 text-xs italic">Date Invalid</span>';
            }
            
            return `<button class="fetch-outcome-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-md text-xs transition">Fetch</button>`;
        }

        function updatePaginationControls(totalPages) {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }

        function updateAnalytics(data) {
            totalMatchesCard.textContent = data.length;
            const winningMarginIndex = originalHeaders.indexOf('Winning Margin Met');
            const totalGoalsIndex = originalHeaders.indexOf('Total Goals');

            if(data.length > 0) {
                const wins = data.filter(row => (row[winningMarginIndex] || '').toLowerCase() === 'yes').length;
                winRateCard.textContent = `${((wins / data.length) * 100).toFixed(1)}%`;
                const totalGoals = data.reduce((acc, row) => acc + (parseFloat(row[totalGoalsIndex]) || 0), 0);
                avgGoalsCard.textContent = (totalGoals / data.length).toFixed(2);
            } else {
                winRateCard.textContent = 'N/A';
                avgGoalsCard.textContent = 'N/A';
            }
            updateSpecialPicks(data);
        }

        function updateSpecialPicks(data) {
            const homeOddsIndex = originalHeaders.indexOf('Home Odds');
            const confidenceIndex = originalHeaders.indexOf('Confidence');
            const homeTeamIndex = originalHeaders.indexOf('Home Team');
            const awayTeamIndex = originalHeaders.indexOf('Away Team');
            
            if ([homeOddsIndex, confidenceIndex, homeTeamIndex, awayTeamIndex].includes(-1)) {
                specialPicksCard.innerHTML = '<p class="text-gray-400 text-xs">Required columns not found.</p>';
                return;
            }

            const picks = data.filter(row => {
                const homeOdds = parseFloat(row[homeOddsIndex]);
                const confidenceText = row[confidenceIndex] || '0';
                const confidenceMatch = confidenceText.match(/(\d+(\.\d+)?)/);
                const confidence = confidenceMatch ? parseFloat(confidenceMatch[0]) : 0;
                
                return homeOdds >= 1.3 && homeOdds <= 1.5 && confidence > 80;
            }).slice(0, 5);

            if (picks.length === 0) {
                specialPicksCard.innerHTML = '<p class="text-gray-400">No special picks match criteria.</p>';
                return;
            }

            specialPicksCard.innerHTML = `<ol class="list-decimal list-inside space-y-1">${picks.map(row => {
                 const confidenceText = row[confidenceIndex] || '0';
                 const confidenceMatch = confidenceText.match(/(\d+(\.\d+)?)/);
                 const confidence = confidenceMatch ? parseFloat(confidenceMatch[0]) : 0;
                return `<li><span class="font-semibold">${row[homeTeamIndex]}</span> vs <span class="font-semibold">${row[awayTeamIndex]}</span><span class="text-blue-800 font-bold ml-2">${confidence.toFixed(0)}%</span></li>`
            }).join('')}</ol>`;
        }

        function openModal(row) {
            const homeTeam = row[originalHeaders.indexOf('Home Team')] || 'N/A';
            const awayTeam = row[originalHeaders.indexOf('Away Team')] || 'N/A';
            modalTitle.textContent = `${homeTeam} vs ${awayTeam}`;
            
            modalBody.innerHTML = originalHeaders.map((header, index) => {
                return `<div>
                            <p class="font-semibold text-gray-800">${header}</p>
                            <p class="text-gray-600">${row[index] || '-'}</p>
                        </div>`;
            }).join('');
            
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            modalOverlay.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, 300);
        }

        function handleSort(e) {
            const target = e.target.closest('th');
            if (!target || !target.dataset.originalIndex) return;
            const originalColumnIndex = parseInt(target.dataset.originalIndex);
            if (sortState.column === originalColumnIndex) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = originalColumnIndex;
                sortState.direction = 'asc';
            }
            renderHeaders();
            applyFilters();
        }

        function resetFilters() {
            searchFilter.value = '';
            dateFilter.value = 'All';
            outcomeFilter.value = 'All';
            chanceFilter.value = 'All';
            winningMarginFilter.value = 'All';
            sortState = { column: null, direction: 'asc' };
            renderHeaders();
            applyFilters();
        }

        function switchTab(targetId) {
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
                button.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            document.getElementById(targetId).classList.remove('hidden');
            const activeTabButtonId = `tab-${targetId.split('-')[1]}`;
            document.getElementById(activeTabButtonId).classList.add('active');
        }
        
        function updateMassFetchButtonState() {
            const selectedCheckboxes = tableBody.querySelectorAll('.row-checkbox:checked');
            massFetchBtn.disabled = selectedCheckboxes.length === 0;
        }

        async function handleMassFetch() {
            const checkedBoxes = tableBody.querySelectorAll('.row-checkbox:checked');
            massFetchBtn.disabled = true;

            const fetchPromises = [];

            checkedBoxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const fetchBtn = row.querySelector('.fetch-outcome-btn');
                if (fetchBtn) {
                   fetchPromises.push(fetchMatchOutcome(fetchBtn));
                }
            });

            await Promise.all(fetchPromises);
            
            // Uncheck all after fetching
            tableBody.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllCheckbox').checked = false;
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', init);
        tableHeader.addEventListener('click', handleSort);
        resetFiltersBtn.addEventListener('click', resetFilters);
        applyFiltersBtn.addEventListener('click', applyFilters);
        massFetchBtn.addEventListener('click', handleMassFetch);
        modalCloseBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', closeModal);

        prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPage(); }});
        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(currentFilteredData.length / ROWS_PER_PAGE);
            if (currentPage < totalPages) { currentPage++; renderPage(); }
        });
        
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = `content-${e.currentTarget.id.split('-')[1]}`;
                switchTab(targetId);
            });
        });

        // Event delegation for fetch buttons and checkboxes
        tableBody.addEventListener('click', e => {
            if (e.target && e.target.classList.contains('fetch-outcome-btn')) {
                fetchMatchOutcome(e.target);
            }
            if (e.target && e.target.classList.contains('row-checkbox')) {
                updateMassFetchButtonState();
            }
        });

    </script>
</body>
</html>

