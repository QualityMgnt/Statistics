<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Compass | Sports Analytics</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%230891b2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><title>Data Compass Favicon</title><circle cx='12' cy='12' r='10'></circle><polygon points='16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76'></polygon></svg>">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Litepicker for date range selection -->
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <!-- Tom Select for multi-select dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Use the Poppins font */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f5f4; /* Stone 100 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e7e5e4; } /* Stone 200 */
        ::-webkit-scrollbar-thumb { background: #0891b2; border-radius: 10px; } /* Cyan 600 */
        ::-webkit-scrollbar-thumb:hover { background: #0e7490; } /* Cyan 700 */
        
        /* Style for table headers to make them sticky and sortable */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        /* Styles for sorting indicators */
        .sort-asc::after { content: ' ▲'; font-size: 0.8em; }
        .sort-desc::after { content: ' ▼'; font-size: 0.8em; }

        /* Loading Spinner Animation */
        .loader {
            border: 5px solid #cffafe; /* Cyan 100 */
            border-radius: 50%;
            border-top: 5px solid #0891b2; /* Cyan 600 */
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Transitions */
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }

        /* Sidebar navigation active state */
        .sidebar-link.active {
            background-color: #0891b2; /* Cyan 600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .page-content.hidden {
            display: none;
        }

        /* Custom styling for range input */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e7e5e4; /* stone-200 */
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #0891b2; /* cyan-600 */
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #0891b2;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Insight Card Progress Circle */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Drag and Drop styles for Admin panel */
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .dragging { opacity: 0.5; background: #cffafe; }
        .drag-over { border: 2px dashed #0891b2; }
        
        /* Tom Select custom styles */
        .ts-control {
            border-radius: 0.5rem !important;
            border-color: #d1d5db !important;
        }
        .ts-control:focus-within {
             border-color: #0891b2 !important;
             box-shadow: 0 0 0 1px #0891b2 !important;
        }
    </style>
</head>
<body class="antialiased text-slate-800 bg-stone-100">

    <!-- Auth Container -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen bg-stone-200">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
            
            <!-- Login Form -->
            <div id="login-view">
                <div class="text-center">
                    <div class="mx-auto h-16 w-16 mb-4 flex items-center justify-center bg-cyan-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-600">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-extrabold text-cyan-800">Data Compass</h2>
                    <p class="mt-2 text-sm text-slate-600">Precision in Prediction. Accuracy in Analytics.</p>
                </div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div class="space-y-4 rounded-md shadow-sm">
                        <div>
                            <label for="login-email" class="sr-only">Email address</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none border-slate-300 text-slate-900 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Email address">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">Password</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none border-slate-300 text-slate-900 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Password">
                        </div>
                    </div>
                    <p id="login-error" class="text-sm text-center text-rose-500"></p>
                    <div>
                        <button type="submit" class="relative flex justify-center w-full px-4 py-3 text-sm font-medium text-white bg-cyan-600 border border-transparent rounded-lg group hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                            Sign in
                        </button>
                    </div>
                </form>
                <p class="mt-6 text-sm text-center">
                    Don't have an account?
                    <a href="#" id="show-signup" class="font-medium text-cyan-600 hover:text-cyan-500">Sign up</a>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signup-view" class="hidden">
                 <div class="text-center">
                      <div class="mx-auto h-16 w-16 mb-4 flex items-center justify-center bg-cyan-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-600">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-extrabold text-cyan-800">Create an Account</h2>
                    <p class="mt-2 text-sm text-slate-600">Get started with your sports analytics journey</p>
                </div>
                <form id="signup-form" class="mt-8 space-y-6">
                    <div class="space-y-4 rounded-md shadow-sm">
                        <div>
                            <label for="signup-name" class="sr-only">Full Name</label>
                            <input id="signup-name" name="name" type="text" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none border-slate-300 text-slate-900 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Full Name">
                        </div>
                        <div>
                            <label for="signup-email" class="sr-only">Email address</label>
                            <input id="signup-email" name="email" type="email" autocomplete="email" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none border-slate-300 text-slate-900 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Email address">
                        </div>
                        <div>
                            <label for="signup-password" class="sr-only">Password</label>
                            <input id="signup-password" name="password" type="password" autocomplete="new-password" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none border-slate-300 text-slate-900 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Password">
                        </div>
                    </div>
                    <p id="signup-message" class="text-sm text-center"></p>
                    <div>
                        <button type="submit" class="relative flex justify-center w-full px-4 py-3 text-sm font-medium text-white bg-cyan-600 border border-transparent rounded-lg group hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                            Sign up
                        </button>
                    </div>
                </form>
                 <p class="mt-6 text-sm text-center">
                    Already have an account?
                    <a href="#" id="show-login" class="font-medium text-cyan-600 hover:text-cyan-500">Sign in</a>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Container (Initially Hidden) -->
    <div id="dashboard-container" class="hidden h-screen">
        <div class="flex h-screen">
            <!-- Sidebar Navigation -->
            <aside class="w-64 bg-white shadow-lg flex flex-col flex-shrink-0">
                <div class="p-6 flex items-center space-x-4 border-b border-stone-200">
                    <div class="h-10 w-10 flex items-center justify-center bg-cyan-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-600">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-cyan-800">Data Compass</h1>
                </div>
                <nav id="sidebar-nav" class="flex-1 px-4 py-6 space-y-2">
                    <a href="#" data-target="content-dashboard" class="sidebar-link active flex items-center px-4 py-2.5 text-slate-700 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                        Dashboard
                    </a>
                    <a href="#" data-target="content-high-confidence" class="sidebar-link flex items-center px-4 py-2.5 text-slate-700 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        High-Confidence
                    </a>
                    <a href="more_events.html" class="sidebar-link flex items-center px-4 py-2.5 text-slate-700 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        More Events
                    </a>
                     <a href="#" data-target="content-comparison" class="sidebar-link flex items-center px-4 py-2.5 text-slate-700 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-5M3 4h5V9m13 2l-4-4-4 4-4-4-4 4 4 4-4 4"></path></svg>
                        Team Comparison
                    </a>
                    <a href="#" data-target="content-analytics" class="sidebar-link flex items-center px-4 py-2.5 text-slate-700 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Analytics
                    </a>
                    <a href="#" data-target="content-admin" class="sidebar-link flex items-center px-4 py-2.5 text-slate-700 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Admin
                    </a>
                </nav>
                 <div class="p-4 border-t">
                     <div class="text-xs text-slate-500 mb-2">Logged in as: <span id="user-email-display" class="font-semibold"></span></div>
                    <button id="logout-btn" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center justify-center space-x-2 shadow-sm hover:shadow-md">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white shadow-sm p-4 flex justify-between items-center z-20 flex-shrink-0">
                    <h1 id="main-header-title" class="text-2xl font-bold text-cyan-800">Dashboard</h1>
                    <div class="flex space-x-2">
                        <button id="syncDataBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center space-x-2 shadow-sm hover:shadow-md">
                            <svg class="w-4 h-4" id="syncIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.25-4.25l-1.47 1.47c.56.98.82 2.09.82 3.28 0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                            <span id="syncText">Sync Data</span>
                        </button>
                    </div>
                </header>

                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-stone-100 p-4 sm:p-6 lg:p-8">
                    <div id="content-dashboard" class="page-content">
                        <!-- Filters Section -->
                        <div id="dashboard-filters" class="bg-white/70 backdrop-blur-lg rounded-xl shadow-md mb-8 p-6">
                            <h3 class="text-xl font-bold text-cyan-800 mb-4">Filter Data</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div>
                                    <label for="searchFilter" class="block text-sm font-medium text-slate-700 mb-2">Search Teams</label>
                                    <div class="relative">
                                        <input type="text" id="searchFilter" placeholder="e.g., Man United" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 pl-10 transition">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="dateFilter" class="block text-sm font-medium text-slate-700 mb-2">Date</label>
                                    <select id="dateFilter" data-filter-key="date" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Dates</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="preferenceFilter" class="block text-sm font-medium text-slate-700 mb-2">Preference</label>
                                    <select id="preferenceFilter" data-filter-key="preference" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Preferences</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="winningMarginFilter" class="block text-sm font-medium text-slate-700 mb-2">Winning Margin</label>
                                    <select id="winningMarginFilter" data-filter-key="winningMargin" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Margins</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="analyzedPredictionFilter" class="block text-sm font-medium text-slate-700 mb-2">Analyzed Prediction</label>
                                    <select id="analyzedPredictionFilter" data-filter-key="analyzedPrediction" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Predictions</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="goalsTipFilter" class="block text-sm font-medium text-slate-700 mb-2">Goals Tip</label>
                                    <select id="goalsTipFilter" data-filter-key="goalsTip" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Goal Tips</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="totalGoalsFilter" class="block text-sm font-medium text-slate-700 mb-2">Total Goals</label>
                                    <select id="totalGoalsFilter" data-filter-key="totalGoals" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Totals</option>
                                    </select>
                                </div>
                                <div class="lg:col-span-4">
                                    <label for="confidenceRangeFilter" class="block text-sm font-medium text-slate-700 mb-2">
                                        Level of Confidence: <span id="confidenceRangeValue" class="font-bold text-cyan-600">70%</span>
                                    </label>
                                    <input type="range" id="confidenceRangeFilter" data-filter-key="minConfidence" min="0" max="100" value="70" class="filter-input w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                                </div>

                                <div class="col-span-full flex justify-end gap-4 mt-4">
                                    <button id="resetFiltersBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2.5 px-6 rounded-lg transition">Reset Filters</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- All Match Data Table -->
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                             <div class="p-4 border-b">
                                 <h3 class="text-xl font-bold text-cyan-800">All Match Data</h3>
                                <p class="text-sm text-slate-500 mt-1">A comprehensive list of all matches. Use the filters above to refine the results.</p>
                            </div>
                            <div id="table-container" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-stone-200">
                                    <thead class="bg-stone-50">
                                        <tr></tr>
                                    </thead>
                                    <tbody id="dataTableBody" class="bg-white divide-y divide-stone-200">
                                         <tr><td colspan="10" class="p-8 text-center text-slate-500"><div class="loader mx-auto"></div><p class="mt-4">Loading data...</p></td></tr>
                                    </tbody>
                                </table>
                                 <div id="no-results" class="hidden p-8 text-center text-slate-500">No records match the current filters.</div>
                            </div>
                            <div id="pagination-controls" class="p-4 flex items-center justify-between border-t border-stone-200">
                                <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                                <div class="text-sm text-slate-700" id="page-info">Page 1 of 1</div>
                                <button id="next-page" class="ml-3 relative inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                            </div>
                        </div>
                    </div>
                    <!-- High Confidence Content -->
                    <div id="content-high-confidence" class="page-content hidden">
                         <!-- Filters Section (Duplicated) -->
                        <div id="high-confidence-filters" class="bg-white/70 backdrop-blur-lg rounded-xl shadow-md mb-8 p-6">
                            <h3 class="text-xl font-bold text-cyan-800 mb-4">Filter High-Confidence Picks</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div>
                                    <label for="hc-searchFilter" class="block text-sm font-medium text-slate-700 mb-2">Search Teams</label>
                                    <div class="relative">
                                        <input type="text" id="hc-searchFilter" placeholder="e.g., Man United" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 pl-10 transition">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="hc-dateFilter" class="block text-sm font-medium text-slate-700 mb-2">Date</label>
                                    <select id="hc-dateFilter" data-filter-key="date" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Dates</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="hc-preferenceFilter" class="block text-sm font-medium text-slate-700 mb-2">Preference</label>
                                    <select id="hc-preferenceFilter" data-filter-key="preference" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Preferences</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="hc-winningMarginFilter" class="block text-sm font-medium text-slate-700 mb-2">Winning Margin</label>
                                    <select id="hc-winningMarginFilter" data-filter-key="winningMargin" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Margins</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="hc-analyzedPredictionFilter" class="block text-sm font-medium text-slate-700 mb-2">Analyzed Prediction</label>
                                    <select id="hc-analyzedPredictionFilter" data-filter-key="analyzedPrediction" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Predictions</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="hc-goalsTipFilter" class="block text-sm font-medium text-slate-700 mb-2">Goals Tip</label>
                                    <select id="hc-goalsTipFilter" data-filter-key="goalsTip" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Goal Tips</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="hc-totalGoalsFilter" class="block text-sm font-medium text-slate-700 mb-2">Total Goals</label>
                                    <select id="hc-totalGoalsFilter" data-filter-key="totalGoals" class="filter-input w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Totals</option>
                                    </select>
                                </div>
                                <div class="lg:col-span-4">
                                    <label for="hc-confidenceRangeFilter" class="block text-sm font-medium text-slate-700 mb-2">
                                        Level of Confidence: <span id="hc-confidenceRangeValue" class="font-bold text-cyan-600">70%</span>
                                    </label>
                                    <input type="range" id="hc-confidenceRangeFilter" data-filter-key="minConfidence" min="0" max="100" value="70" class="filter-input w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md mb-8">
                            <div class="p-4 border-b">
                               <h3 class="text-xl font-bold text-cyan-800">High-Confidence Picks</h3>
                               <p class="text-sm text-slate-500 mt-1">Filtered for "Home Best Tip" or "Best Away Tip".</p>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-stone-200">
                                    <thead id="highConfidenceTableHead" class="bg-stone-50"></thead>
                                    <tbody id="highConfidenceTableBody" class="bg-white divide-y divide-stone-200">
                                        <tr><td colspan="8" class="p-8 text-center text-slate-500">Finding best picks...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                             <div id="high-confidence-pagination-controls" class="p-4 flex items-center justify-between border-t border-stone-200">
                                 <button id="high-confidence-prev-page" class="relative inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                                 <div class="text-sm text-slate-700" id="high-confidence-page-info">Page 1 of 1</div>
                                 <button id="high-confidence-next-page" class="ml-3 relative inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                            </div>
                        </div>
                    </div>
                    <!-- Team Comparison Content -->
                    <div id="content-comparison" class="page-content hidden">
                         <div class="bg-white/70 backdrop-blur-lg rounded-xl shadow-md mb-8 p-6">
                            <h3 class="text-xl font-bold text-cyan-800 mb-4">Team Comparison</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                                <div class="md:col-span-2">
                                    <label for="team-select" class="block text-sm font-medium text-slate-700 mb-2">Select Teams (2 or more)</label>
                                    <select id="team-select" multiple placeholder="Select teams to compare..."></select>
                                </div>
                                <div>
                                    <label for="date-range-picker" class="block text-sm font-medium text-slate-700 mb-2">Select Date Range</label>
                                    <input type="text" id="date-range-picker" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                </div>
                            </div>
                        </div>

                        <div id="comparison-results-container" class="hidden">
                             <div class="bg-white rounded-xl shadow-md overflow-hidden">
                                 <div class="p-4 border-b">
                                     <h3 class="text-xl font-bold text-cyan-800">Comparison Results</h3>
                                </div>
                                <div id="comparison-table-container" class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-stone-200">
                                        <thead id="comparison-table-head" class="bg-stone-50"></thead>
                                        <tbody id="comparison-table-body" class="bg-white divide-y divide-stone-200"></tbody>
                                    </table>
                                </div>
                             </div>
                        </div>
                         <div id="comparison-placeholder" class="text-center p-8 bg-white rounded-xl shadow-md text-slate-500">
                            <i data-lucide="users" class="mx-auto w-12 h-12 text-slate-400 mb-4"></i>
                            <h4 class="font-semibold text-lg">Ready to Compare</h4>
                            <p>Select at least two teams and a date range to see their head-to-head match data.</p>
                         </div>
                    </div>
                    <!-- Analytics Content -->
                    <div id="content-analytics" class="page-content hidden">
                         <!-- Analytics Filters -->
                        <div class="bg-white/70 backdrop-blur-lg rounded-xl shadow-md mb-8 p-6">
                            <h3 class="text-xl font-bold text-cyan-800 mb-4">Analytics Filters</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div>
                                    <label for="analyticsDateFilter" class="block text-sm font-medium text-slate-700 mb-2">Filter by Date</label>
                                    <select id="analyticsDateFilter" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Dates</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="analyticsTotalGoalsFilter" class="block text-sm font-medium text-slate-700 mb-2">Filter by Total Goals</label>
                                    <select id="analyticsTotalGoalsFilter" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Totals</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Key Insights Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                            <!-- Overall Success Rate -->
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                                <div class="relative w-24 h-24">
                                    <svg class="w-full h-full" viewBox="0 0 36 36">
                                        <path class="text-stone-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                                        <path id="progress-ring-circle" class="progress-ring__circle text-cyan-600" stroke-width="3" stroke-linecap="round" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="overall-success-rate-text" class="text-2xl font-bold text-cyan-800">-%</span>
                                    </div>
                                </div>
                                <div class="ml-5">
                                    <h4 class="text-slate-500 text-sm font-medium">Overall Success</h4>
                                    <p class="text-slate-800 text-lg font-semibold">Accuracy Rate</p>
                                </div>
                            </div>
                             <!-- Best Performing Bet -->
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                                <div class="flex-shrink-0 bg-teal-100 text-teal-600 rounded-full h-16 w-16 flex items-center justify-center">
                                    <i data-lucide="trending-up" class="w-8 h-8"></i>
                                </div>
                                <div class="ml-5">
                                    <h4 class="text-slate-500 text-sm font-medium">Best Performing Bet</h4>
                                    <p id="best-bet-type" class="text-slate-800 text-lg font-bold truncate">-</p>
                                </div>
                            </div>
                             <!-- Optimal Confidence -->
                            <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                                <div class="flex-shrink-0 bg-violet-100 text-violet-600 rounded-full h-16 w-16 flex items-center justify-center">
                                    <i data-lucide="target" class="w-8 h-8"></i>
                                </div>
                                <div class="ml-5">
                                    <h4 class="text-slate-500 text-sm font-medium">Optimal Confidence</h4>
                                    <p id="optimal-confidence" class="text-slate-800 text-lg font-bold">-</p>
                                </div>
                            </div>
                             <!-- Total Bets -->
                             <div class="bg-white p-6 rounded-xl shadow-md flex items-center">
                                <div class="flex-shrink-0 bg-amber-100 text-amber-600 rounded-full h-16 w-16 flex items-center justify-center">
                                    <i data-lucide="hash" class="w-8 h-8"></i>
                                </div>
                                <div class="ml-5">
                                    <h4 class="text-slate-500 text-sm font-medium">Total Bets Analyzed</h4>
                                    <p id="total-bets-analyzed" class="text-slate-800 text-lg font-bold">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Grid -->
                        <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
                            <div class="bg-white p-6 rounded-xl shadow-md xl:col-span-3"><canvas id="confidenceChart"></canvas></div>
                            <div class="bg-white p-6 rounded-xl shadow-md xl:col-span-2"><canvas id="predictionAccuracyChart"></canvas></div>
                            <div class="bg-white p-6 rounded-xl shadow-md xl:col-span-5"><canvas id="successOverTimeChart"></canvas></div>
                            <div class="bg-white p-6 rounded-xl shadow-md xl:col-span-3"><canvas id="analyzedPredictionChart"></canvas></div>
                            <div class="bg-white p-6 rounded-xl shadow-md xl:col-span-2"><canvas id="winningMarginChart"></canvas></div>
                            <div class="bg-white p-6 rounded-xl shadow-md xl:col-span-3"><canvas id="goalsTipChart"></canvas></div>
                            <div class="bg-white p-6 rounded-xl shadow-md xl:col-span-2"><canvas id="preferenceChart"></canvas></div>
                        </div>
                    </div>
                     <!-- Admin Content -->
                    <div id="content-admin" class="page-content hidden">
                        <div class="bg-white/70 backdrop-blur-lg rounded-xl shadow-md p-6">
                            <h3 class="text-xl font-bold text-cyan-800 mb-2">Table Column Management</h3>
                            <p class="text-sm text-slate-600 mb-6">Drag and drop to reorder columns. Check or uncheck to show or hide them.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- All Match Data Table Management -->
                                <div>
                                    <h4 class="font-bold text-slate-800 mb-4">Dashboard: All Match Data Table</h4>
                                    <div id="main-table-admin-container" class="space-y-2 p-4 bg-slate-50 rounded-lg border">
                                        <!-- Columns will be injected here by JS -->
                                    </div>
                                </div>
                                <!-- High Confidence Table Management -->
                                <div>
                                    <h4 class="font-bold text-slate-800 mb-4">High-Confidence Table</h4>
                                    <div id="high-confidence-table-admin-container" class="space-y-2 p-4 bg-slate-50 rounded-lg border">
                                        <!-- Columns will be injected here by JS -->
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end gap-4">
                                <button id="reset-columns-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2.5 px-6 rounded-lg transition">Reset to Default</button>
                                <button id="save-columns-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-6 rounded-lg transition shadow-sm hover:shadow-md">Save Changes</button>
                            </div>
                            <p id="admin-message" class="text-sm text-right mt-4 text-emerald-600"></p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="fixed inset-0 z-50 hidden">
        <div id="modal-overlay" class="absolute inset-0 bg-black bg-opacity-60 modal-overlay opacity-0"></div>
        <div class="relative bg-white w-full max-w-xl mx-auto mt-20 rounded-lg shadow-xl p-6 modal-content scale-95 opacity-0 transform -translate-y-10">
            <div class="flex items-start justify-between pb-4 border-b">
                <h2 class="text-xl font-bold text-slate-900" id="modal-title"></h2>
                <button id="modal-close-btn" class="text-2xl text-slate-400 hover:text-slate-600 font-light">&times;</button>
            </div>
            <div id="modal-body" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 text-sm max-h-[70vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrXyGqj1DKdAk4GHfjNnkh7s9Jmti4ccb-K6EwJUAfzs8vJ0CUSj8KVi6_jZmrwCaJ1ODMY5bDJRK/pub?gid=337419731&single=true&output=csv';
        const SIGNUP_URL = 'https://script.google.com/macros/s/AKfycbw1aMNk8N1ksb95v8sHTjYc3auRy-6f7AE85kXvd8Z-P9_kUMW90fINKVHo68CYc3EI/exec';
        const ROWS_PER_PAGE = 20;
        const HIGH_CONFIDENCE_ROWS_PER_PAGE = 10;
        
        // --- DEFAULT TABLE HEADERS CONFIGURATION ---
        const DEFAULT_MAIN_TABLE_HEADERS = ['Details', 'Date', 'Home Team', 'Away Team', 'Analyzed Prediction', 'Home Odds', 'Draw Odds', 'Away Odds', 'Level of Confidence', 'Match Outcome', 'Accuracy'];
        const DEFAULT_HIGH_CONFIDENCE_HEADERS = ['Home Team', 'Away Team', 'Level of Confidence', 'Preference', 'Winning Margin', 'Analyzed Prediction', 'Match Outcome', 'Accuracy'];
        let ALL_POSSIBLE_COLUMNS = [];


        // --- GLOBAL STATE ---
        let allData = [], currentFilteredData = [], originalHeaders = [];
        let sortState = { column: null, direction: 'asc' };
        let currentPage = 1;
        let highConfidenceCurrentPage = 1;
        let COLUMN_INDICES = {};
        let charts = {}; // To hold chart instances
        let mainTableHeaders = [];
        let highConfidenceTableHeaders = [];
        let globalFilters = {};
        let teamSelect, dateRangePicker;

        // --- EVENT HANDLERS (DEFINED EARLY) ---
        
        async function handleSyncClick() {
            dom.syncDataBtn.disabled = true;
            dom.syncIcon.classList.add('animate-spin');
            dom.syncText.textContent = 'Syncing...';
            dom.tableBody.innerHTML = `<tr><td colspan="${mainTableHeaders.length}" class="p-8 text-center text-slate-500"><div class="loader mx-auto"></div><p class="mt-4">Syncing data...</p></td></tr>`;
            try {
                await fetchAndProcessData();
            } catch (e) {
                // Error handled in fetch function
            } finally {
                dom.syncDataBtn.disabled = false;
                dom.syncIcon.classList.remove('animate-spin');
                dom.syncText.textContent = 'Sync Data';
            }
        }

        function handleSort(e) {
            const target = e.target.closest('th');
            if (!target || !target.dataset.originalIndex) return;
            const originalColumnIndex = parseInt(target.dataset.originalIndex);
            
            if (sortState.column === originalColumnIndex) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = originalColumnIndex;
                sortState.direction = 'asc';
            }
            renderMainTableHeaders();
            applyFiltersAndRender();
        }

        function handleFilterChange(e) {
            const input = e.target;
            let value = input.value;
            let key;

            if (input.id.includes('search')) {
                key = 'searchTerm';
            } else if (input.type === 'range') {
                key = 'minConfidence';
                value = parseInt(value, 10);
            } else {
                key = input.dataset.filterKey;
            }

            globalFilters[key] = value;

            document.querySelectorAll(`.filter-input`).forEach(el => {
                if (el !== input) {
                    if (el.dataset.filterKey === key || (key === 'searchTerm' && el.id.includes('search'))) {
                        el.value = value;
                    }
                }
            });

            dom.confidenceRangeValue.textContent = `${globalFilters.minConfidence}%`;
            if(dom.hcConfidenceRangeValue) {
                dom.hcConfidenceRangeValue.textContent = `${globalFilters.minConfidence}%`;
            }
            
            applyFiltersAndRender();
        }

        function resetFilters() {
             globalFilters = {
                searchTerm: '',
                date: 'All',
                preference: 'All',
                winningMargin: 'All',
                analyzedPrediction: 'All',
                goalsTip: 'All',
                totalGoals: 'All',
                minConfidence: 70
            };
            sortState = { column: null, direction: 'asc' };

            document.querySelectorAll('.filter-input').forEach(input => {
                if (input.id.includes('search')) input.value = '';
                else if (input.type === 'range') input.value = 70;
                else input.selectedIndex = 0;
            });
            dom.confidenceRangeValue.textContent = '70%';
            if(dom.hcConfidenceRangeValue){
                dom.hcConfidenceRangeValue.textContent = '70%';
            }

            renderMainTableHeaders();
            applyFiltersAndRender();
        }
        
        function handleHighConfidenceRowClick(e) {
            const rowElement = e.target.closest('tr');
            if (!rowElement || typeof rowElement.dataset.rowIndex === 'undefined') return;
            const rowIndex = parseInt(rowElement.dataset.rowIndex, 10);
            const rowData = allData[rowIndex];
            if (rowData) openModal(rowData);
        }
        
        function handleMainTableRowClick(e) {
            const rowElement = e.target.closest('tr');
            if (!rowElement || typeof rowElement.dataset.rowIndex === 'undefined') return;
            
            const rowIndex = parseInt(rowElement.dataset.rowIndex, 10);
            const rowData = currentFilteredData[rowIndex];

            if (rowData) {
                openModal(rowData);
            }
        }
        
        function handleSidebarClick(e) {
            e.preventDefault();
            const link = e.target.closest('.sidebar-link');
            if (!link) return;

            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            const targetId = link.dataset.target;
            document.querySelectorAll('.page-content').forEach(pane => {
                pane.classList.toggle('hidden', pane.id !== targetId);
            });
            
            dom.mainHeaderTitle.textContent = link.textContent.trim();

            if (targetId === 'content-analytics') updateAnalytics();
            if (targetId === 'content-admin') renderAdminUI();
            if (targetId === 'content-comparison') lucide.createIcons();
            
        }

        async function handleFetchOutcomeClick(e) {
            const button = e.currentTarget;
            const { homeTeam, awayTeam, date } = button.dataset;
            const scoreElement = document.getElementById('modal-final-score');

            button.disabled = true;
            button.innerHTML = `<div class="loader !w-4 !h-4 !border-2 !border-t-white/50 mx-auto"></div>`;

            try {
                const result = await fetchMatchOutcome(homeTeam, awayTeam, date);
                scoreElement.textContent = result.text.trim();
                button.style.display = 'none'; // Hide button after success
            } catch (error) {
                console.error("Fetch outcome failed:", error);
                scoreElement.textContent = "Could not fetch score.";
                button.innerHTML = `Retry`;
                button.disabled = false;
            }
        }


        // --- DOM REFERENCES ---
        const dom = {
            // Auth
            authContainer: document.getElementById('auth-container'),
            loginView: document.getElementById('login-view'),
            signupView: document.getElementById('signup-view'),
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            showSignup: document.getElementById('show-signup'),
            showLogin: document.getElementById('show-login'),
            loginError: document.getElementById('login-error'),
            signupMessage: document.getElementById('signup-message'),
            logoutBtn: document.getElementById('logout-btn'),
            userEmailDisplay: document.getElementById('user-email-display'),
            
            // Dashboard & Navigation
            dashboardContainer: document.getElementById('dashboard-container'),
            sidebarNav: document.getElementById('sidebar-nav'),
            mainHeaderTitle: document.getElementById('main-header-title'),
            tableBody: document.getElementById('dataTableBody'),
            tableHeader: document.querySelector('#table-container thead tr'),
            noResultsDiv: document.getElementById('no-results'),
            
            // Filters (from both panels)
            allFilterInputs: document.querySelectorAll('.filter-input'),
            confidenceRangeValue: document.getElementById('confidenceRangeValue'),
            hcConfidenceRangeValue: document.getElementById('hc-confidenceRangeValue'),
            resetFiltersBtn: document.getElementById('resetFiltersBtn'),

            // Analytics
            analyticsDateFilter: document.getElementById('analyticsDateFilter'),
            analyticsTotalGoalsFilter: document.getElementById('analyticsTotalGoalsFilter'),
            overallSuccessRateText: document.getElementById('overall-success-rate-text'),
            progressRingCircle: document.getElementById('progress-ring-circle'),
            bestBetType: document.getElementById('best-bet-type'),
            optimalConfidence: document.getElementById('optimal-confidence'),
            totalBetsAnalyzed: document.getElementById('total-bets-analyzed'),

            // High Confidence Table
            highConfidenceTableHead: document.getElementById('highConfidenceTableHead'),
            highConfidenceTableBody: document.getElementById('highConfidenceTableBody'),
            highConfidencePaginationControls: document.getElementById('high-confidence-pagination-controls'),
            highConfidencePrevPageBtn: document.getElementById('high-confidence-prev-page'),
            highConfidenceNextPageBtn: document.getElementById('high-confidence-next-page'),
            highConfidencePageInfo: document.getElementById('high-confidence-page-info'),
            
            // Team Comparison
            comparisonResultsContainer: document.getElementById('comparison-results-container'),
            comparisonPlaceholder: document.getElementById('comparison-placeholder'),
            comparisonTableHead: document.getElementById('comparison-table-head'),
            comparisonTableBody: document.getElementById('comparison-table-body'),

            // Pagination
            paginationControls: document.getElementById('pagination-controls'),
            prevPageBtn: document.getElementById('prev-page'),
            nextPageBtn: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            
            // Modal
            modal: document.getElementById('details-modal'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),

            // Admin
            adminMessage: document.getElementById('admin-message'),
            saveColumnsBtn: document.getElementById('save-columns-btn'),
            resetColumnsBtn: document.getElementById('reset-columns-btn'),
            mainTableAdminContainer: document.getElementById('main-table-admin-container'),
            highConfidenceTableAdminContainer: document.getElementById('high-confidence-table-admin-container'),

            // General
            syncDataBtn: document.getElementById('syncDataBtn'),
            syncIcon: document.getElementById('syncIcon'),
            syncText: document.getElementById('syncText'),
        };

        // --- AUTHENTICATION LOGIC ---
        
        function switchView(view) {
            if (view === 'signup') {
                dom.loginView.classList.add('hidden');
                dom.signupView.classList.remove('hidden');
            } else {
                dom.signupView.classList.add('hidden');
                dom.loginView.classList.remove('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const loginBtn = dom.loginForm.querySelector('button[type="submit"]');
            const originalBtnText = 'Sign in';
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<div class="loader !w-5 !h-5 !border-2 !border-t-white/50 mx-auto"></div>`;
            dom.loginError.textContent = '';
            
            try {
                const email = dom.loginForm.email.value.trim().toLowerCase();
                const password = dom.loginForm.password.value;

                const response = await fetch(SIGNUP_URL);
                if (!response.ok) throw new Error('Network response was not ok.');
                const result = await response.json();
                
                if (!result || !Array.isArray(result.users)) {
                    console.error("Invalid data structure received from login API:", result);
                    throw new Error("Could not retrieve valid user data from the server.");
                }
                const users = result.users;

                const user = users.find(u => u.Email.trim().toLowerCase() === email && String(u.Password).trim() === password);

                if (user) {
                    if (String(user.Status).trim().toLowerCase() === 'active') {
                        localStorage.setItem('loggedInUser', JSON.stringify({ email: user.Email }));
                        showDashboard();
                    } else {
                        dom.loginError.textContent = 'Your account is inactive. Please contact admin.';
                    }
                } else {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    dom.loginError.textContent = 'Invalid email or password.';
                }
            } catch (error) {
                console.error('Login error:', error);
                dom.loginError.textContent = 'An error occurred during login. Please try again.';
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = originalBtnText;
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const form = e.target;
            dom.signupMessage.textContent = 'Submitting...';
            dom.signupMessage.className = 'text-sm text-center text-slate-500';

            try {
                const formData = new FormData(form);
                
                const response = await fetch(SIGNUP_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok || response.status === 200 || response.type === 'opaque') {
                    dom.signupMessage.textContent = 'Signup successful! You can now log in.';
                    dom.signupMessage.className = 'text-sm text-center text-emerald-500';
                    form.reset();
                    setTimeout(() => switchView('login'), 2000);
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || `Server responded with an error (status: ${response.status})`);
                }
            } catch (error) {
                console.error('Signup error:', error);
                dom.signupMessage.textContent = `Signup failed. Please try again later.`;
                dom.signupMessage.className = 'text-sm text-center text-rose-500';
            }
        }


        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            showAuth();
        }
        
        function showDashboard() {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            if (!user) {
                showAuth();
                return;
            }
            dom.userEmailDisplay.textContent = user.email;
            dom.authContainer.classList.add('hidden');
            dom.dashboardContainer.classList.remove('hidden');
            handleSyncClick();
        }

        function showAuth() {
            dom.dashboardContainer.classList.add('hidden');
            dom.authContainer.classList.remove('hidden');
            switchView('login');
        }

        // --- CORE DASHBOARD FUNCTIONS ---
        
        async function fetchAndProcessData() {
            try {
                const response = await fetch(`${GOOGLE_SHEET_URL}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const csvText = await response.text();
                
                const parsed = parseCSV(csvText);
                
                originalHeaders = parsed.headers;
                ALL_POSSIBLE_COLUMNS = [...originalHeaders];
                COLUMN_INDICES = {};
                originalHeaders.forEach((header, index) => {
                    COLUMN_INDICES[header.trim()] = index;
                });
                
                allData = parsed.data;
                 // Sort all data by date descending once, to easily find recent matches
                allData.sort((a, b) => {
                    const dateA = new Date(a[COLUMN_INDICES['Date']]);
                    const dateB = new Date(b[COLUMN_INDICES['Date']]);
                    return dateB - dateA;
                });
                
                currentFilteredData = [...allData];

                loadColumnConfiguration();
                renderAdminUI();
                renderMainTableHeaders();
                renderHighConfidenceHeaders();
                populateDropdowns();
                initializeComparisonTools();
                resetFilters();

                updateAnalytics();

            } catch (error) {
                console.error('Failed to fetch/process data:', error);
                dom.tableBody.innerHTML = `<tr><td colspan="${mainTableHeaders.length}" class="p-8 text-center text-rose-500 font-semibold">Failed to load data. Please try syncing again.</td></tr>`;
                throw error;
            }
        }
        
        function parseCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(','));
            const headerRow = rows.shift() || [];
            const cleanedHeaders = headerRow.map(h => h.trim());
            const data = rows.filter(row => row.length === cleanedHeaders.length && row.some(cell => cell.trim() !== ''));
            return { headers: cleanedHeaders, data };
        }
        
        function populateDropdowns() {
             const filtersToPopulate = [
                { id: 'dateFilter', column: 'Date' },
                { id: 'hc-dateFilter', column: 'Date' },
                { id: 'preferenceFilter', column: 'Preference' },
                { id: 'hc-preferenceFilter', column: 'Preference' },
                { id: 'winningMarginFilter', column: 'Winning Margin' },
                { id: 'hc-winningMarginFilter', column: 'Winning Margin' },
                { id: 'analyzedPredictionFilter', column: 'Analyzed Prediction' },
                { id: 'hc-analyzedPredictionFilter', column: 'Analyzed Prediction' },
                { id: 'goalsTipFilter', column: 'Goals Tip' },
                { id: 'hc-goalsTipFilter', column: 'Goals Tip' },
                { id: 'totalGoalsFilter', column: 'Total Goals' },
                { id: 'hc-totalGoalsFilter', column: 'Total Goals' },
                { id: 'analyticsDateFilter', column: 'Date' },
                { id: 'analyticsTotalGoalsFilter', column: 'Total Goals' },
            ];

            filtersToPopulate.forEach(config => {
                const selectElement = document.getElementById(config.id);
                if (!selectElement) return;

                const columnIndex = COLUMN_INDICES[config.column];
                if (typeof columnIndex === 'undefined') return;

                const firstOption = selectElement.options[0];
                selectElement.innerHTML = '';
                selectElement.add(firstOption);

                const uniqueValues = [...new Set(allData.map(row => row[columnIndex]).filter(Boolean))];
                
                if (config.column === 'Date') {
                    uniqueValues.sort((a, b) => new Date(b) - new Date(a));
                } else {
                    uniqueValues.sort();
                }

                uniqueValues.forEach(val => selectElement.add(new Option(val, val)));
            });
        }
        
        function applyFiltersAndRender() {
            let filtered = allData.filter(row => {
                const confidenceText = row[COLUMN_INDICES['Level of Confidence']] || '0%';
                const confidenceValue = parseInt(confidenceText.replace('%', ''), 10);
                const homeTeam = (row[COLUMN_INDICES['Home Team']] || '').toLowerCase();
                const awayTeam = (row[COLUMN_INDICES['Away Team']] || '').toLowerCase();
                const searchTerm = (globalFilters.searchTerm || '').toLowerCase();
                const searchMatch = searchTerm === '' || homeTeam.includes(searchTerm) || awayTeam.includes(searchTerm);

                return (globalFilters.date === 'All' || row[COLUMN_INDICES['Date']] === globalFilters.date) &&
                       (globalFilters.preference === 'All' || row[COLUMN_INDICES['Preference']] === globalFilters.preference) &&
                       (globalFilters.winningMargin === 'All' || row[COLUMN_INDICES['Winning Margin']] === globalFilters.winningMargin) &&
                       (globalFilters.analyzedPrediction === 'All' || row[COLUMN_INDICES['Analyzed Prediction']] === globalFilters.analyzedPrediction) &&
                       (globalFilters.goalsTip === 'All' || row[COLUMN_INDICES['Goals Tip']] === globalFilters.goalsTip) &&
                       (globalFilters.totalGoals === 'All' || row[COLUMN_INDICES['Total Goals']] === globalFilters.totalGoals) &&
                       (confidenceValue >= globalFilters.minConfidence) &&
                       searchMatch;
            });
            
            if (sortState.column !== null) {
                filtered.sort((a, b) => {
                    let valA = a[sortState.column], valB = b[sortState.column];
                    if (!isNaN(valA) && !isNaN(valB) && String(valA).trim() !== '' && String(valB).trim() !== '') return sortState.direction === 'asc' ? valA - valB : valB - valA;
                    return sortState.direction === 'asc' ? (valA || '').localeCompare(valB || '') : (valB || '').localeCompare(valA || '');
                });
            }

            currentFilteredData = filtered;
            currentPage = 1;
            highConfidenceCurrentPage = 1;
            renderMainTablePage();
            renderHighConfidencePicksTable();
        }

        // --- TABLE RENDERING ---

        function renderMainTableHeaders() {
            dom.tableHeader.innerHTML = mainTableHeaders.map(header => {
                const isSortable = !['Details'].includes(header);
                let classes = 'px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider';
                const originalIndex = COLUMN_INDICES[header];

                if (header === 'Details') return `<th scope="col" class="${classes}"></th>`;
                
                if (isSortable && originalIndex !== undefined) {
                    if (sortState.column === originalIndex) classes += sortState.direction === 'asc' ? ' sort-asc' : ' sort-desc';
                    return `<th scope="col" data-original-index="${originalIndex}" class="${classes}">${header}</th>`;
                }
                return `<th scope="col" class="${classes}">${header}</th>`;
            }).join('');
        }
        
        function renderMainTablePage() {
            const totalPages = Math.max(1, Math.ceil(currentFilteredData.length / ROWS_PER_PAGE));
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            const start = (currentPage - 1) * ROWS_PER_PAGE;
            const pageData = currentFilteredData.slice(start, start + ROWS_PER_PAGE);
            
            dom.tableBody.innerHTML = '';
            dom.noResultsDiv.classList.toggle('hidden', pageData.length > 0 || allData.length === 0);
            dom.paginationControls.style.display = pageData.length > 0 ? 'flex' : 'none';

            if (pageData.length === 0 && allData.length > 0) return;
            if(allData.length === 0) return;

            pageData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-cyan-50 transition-colors cursor-pointer';
                tr.dataset.rowIndex = currentFilteredData.indexOf(row);
                
                let cellsHTML = '';
                mainTableHeaders.forEach(headerName => {
                    const colIndex = COLUMN_INDICES[headerName];
                    const cellValue = colIndex !== undefined ? row[colIndex] : '';
                    let cellClass = 'px-6 py-4 whitespace-nowrap text-sm text-slate-700 align-middle';
                    let cellContent = cellValue || '-';

                    switch(headerName) {
                        case 'Home Team': case 'Away Team':
                            cellClass += ' font-semibold text-cyan-900';
                            break;
                        case 'Level of Confidence':
                            const numericConf = parseFloat(cellValue.replace('%','').trim());
                            let confColor = 'text-slate-800';
                            if (!isNaN(numericConf)) {
                                if (numericConf >= 80) confColor = 'text-emerald-600';
                                else if (numericConf >= 70) confColor = 'text-amber-600';
                                else confColor = 'text-rose-600';
                            }
                            cellContent = `<span class="font-bold ${confColor}">${cellValue}</span>`;
                            break;
                        case 'Analyzed Prediction':
                            cellContent = getStyledPredictionBadge(cellValue);
                            break;
                        case 'Accuracy':
                            if ((cellValue || '').toLowerCase() === 'success') {
                                cellContent = `<span class="bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Success</span>`;
                            } else if ((cellValue || '').toLowerCase() === 'unsuccessful') {
                                cellContent = `<span class="bg-rose-100 text-rose-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Unsuccessful</span>`;
                            } else {
                                cellContent = `<span class="text-slate-400">-</span>`;
                            }
                            break;
                        case 'Details':
                            cellContent = `<button class="view-more-btn bg-cyan-600 text-white px-3 py-1 text-xs rounded-full hover:bg-cyan-700 transition shadow">View</button>`;
                            break;
                    }
                    cellsHTML += `<td class="${cellClass}">${cellContent}</td>`;
                });
                
                tr.innerHTML = cellsHTML;
                dom.tableBody.appendChild(tr);
            });
            updatePaginationControls(totalPages);
        }

        function getStyledPredictionBadge(prediction) {
            let bgColor = 'bg-slate-200';
            let textColor = 'text-slate-800';
            switch(prediction) {
                case 'Home Best Tip':
                case 'Home Good Tip':
                    bgColor = 'bg-emerald-100'; textColor = 'text-emerald-800'; break;
                case 'Home Tip':
                    bgColor = 'bg-lime-100'; textColor = 'text-lime-800'; break;
                case 'Best Away Tip':
                case 'Good Away Tip':
                    bgColor = 'bg-sky-100'; textColor = 'text-sky-800'; break;
                case 'Over 1.5 Tip': case 'Over 2.5 Tip':
                    bgColor = 'bg-amber-100'; textColor = 'text-amber-800'; break;
            }
            return `<span class="${bgColor} ${textColor} text-xs font-medium px-2.5 py-1 rounded-full">${prediction}</span>`;
        }
        
        function renderHighConfidenceHeaders() {
            dom.highConfidenceTableHead.innerHTML = `<tr>${highConfidenceTableHeaders.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
        }
        
        function renderHighConfidencePicksTable() {
            const picks = currentFilteredData.filter(row => {
                const analyzedPrediction = row[COLUMN_INDICES['Analyzed Prediction']];
                return analyzedPrediction === 'Home Best Tip' || analyzedPrediction === 'Best Away Tip';
            });

            dom.highConfidencePaginationControls.style.display = picks.length > 0 ? 'flex' : 'none';

            if (picks.length === 0) {
                dom.highConfidenceTableBody.innerHTML = `<tr><td colspan="${highConfidenceTableHeaders.length}" class="p-8 text-center text-slate-500">No high-confidence picks match the current filters.</td></tr>`;
                return;
            }

            const totalPages = Math.max(1, Math.ceil(picks.length / HIGH_CONFIDENCE_ROWS_PER_PAGE));
            highConfidenceCurrentPage = Math.max(1, Math.min(highConfidenceCurrentPage, totalPages));
            const start = (highConfidenceCurrentPage - 1) * HIGH_CONFIDENCE_ROWS_PER_PAGE;
            const pageData = picks.slice(start, start + HIGH_CONFIDENCE_ROWS_PER_PAGE);
            
            dom.highConfidenceTableBody.innerHTML = pageData.map((row) => {
                const originalIndex = allData.indexOf(row);
                const cellsHTML = highConfidenceTableHeaders.map(header => {
                    const value = row[COLUMN_INDICES[header]] || '-';
                    let cellContent = value;
                    let cellClass = 'px-6 py-4 whitespace-nowrap text-sm text-slate-700 align-middle';

                    switch(header) {
                        case 'Home Team': case 'Away Team':
                            cellClass += ' font-semibold text-cyan-900';
                            break;
                        case 'Level of Confidence':
                            const numericConf = parseFloat(value.replace('%','').trim());
                             let confColor = 'text-slate-800';
                            if (!isNaN(numericConf)) {
                                if (numericConf >= 80) confColor = 'text-emerald-600';
                                else if (numericConf >= 70) confColor = 'text-amber-600';
                                else confColor = 'text-rose-600';
                            }
                            cellContent = `<span class="font-bold ${confColor}">${value}</span>`;
                            break;
                        case 'Analyzed Prediction':
                             cellContent = getStyledPredictionBadge(value);
                             break;
                        case 'Accuracy':
                            if ((value || '').toLowerCase() === 'success') {
                                cellContent = `<span class="bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Success</span>`;
                            } else if ((value || '').toLowerCase() === 'unsuccessful') {
                                cellContent = `<span class="bg-rose-100 text-rose-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Unsuccessful</span>`;
                            } else {
                                cellContent = `<span class="text-slate-400">-</span>`;
                            }
                            break;
                    }
                    return `<td class="${cellClass}">${cellContent}</td>`;
                }).join('');
                return `<tr class="hover:bg-cyan-50 transition-colors cursor-pointer" data-row-index="${originalIndex}">${cellsHTML}</tr>`;
            }).join('');

            updateHighConfidencePaginationControls(totalPages);
        }

        // --- ANALYTICS & CHARTING FUNCTIONS ---

        function updateAnalytics() {
            if (allData.length === 0) return;

             const dateFilter = dom.analyticsDateFilter.value;
            const totalGoalsFilter = dom.analyticsTotalGoalsFilter.value;

            const filteredChartData = allData.filter(row => {
                const dateMatch = dateFilter === 'All' || row[COLUMN_INDICES['Date']] === dateFilter;
                const goalsMatch = totalGoalsFilter === 'All' || row[COLUMN_INDICES['Total Goals']] === totalGoalsFilter;
                return dateMatch && goalsMatch;
            });
            renderKeyInsights(filteredChartData);
            renderAnalyticsCharts(filteredChartData);
        }
        
        function renderKeyInsights(data) {
            const accuracyIndex = COLUMN_INDICES['Accuracy'];
            if(accuracyIndex === undefined) return;

            let totalSuccess = 0;
            data.forEach(row => {
                if (String(row[accuracyIndex]).trim().toLowerCase() === 'success') {
                    totalSuccess++;
                }
            });

            // Overall Success Rate
            const overallSuccessRate = data.length > 0 ? (totalSuccess / data.length) * 100 : 0;
            dom.overallSuccessRateText.textContent = `${overallSuccessRate.toFixed(1)}%`;
            const circle = dom.progressRingCircle;
            const radius = 15.9155;
            const circumference = radius * 2 * Math.PI;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - (overallSuccessRate / 100) * circumference;
            circle.style.strokeDashoffset = offset;

            // Best Bet & Optimal Confidence
            const betStats = processChartData(data, 'Analyzed Prediction');
            const confidenceStats = processChartData(data, 'Level of Confidence');

            const bestBet = betStats.labels.reduce((best, label, index) => {
                if (betStats.values[index] > best.value) {
                    return { label, value: betStats.values[index] };
                }
                return best;
            }, { label: '-', value: 0 });

            const bestConfidence = confidenceStats.labels.reduce((best, label, index) => {
                if (confidenceStats.values[index] > best.value) {
                    return { label, value: confidenceStats.values[index] };
                }
                return best;
            }, { label: '-', value: 0 });

            dom.bestBetType.textContent = bestBet.label;
            dom.optimalConfidence.textContent = bestConfidence.label;
            dom.totalBetsAnalyzed.textContent = data.length;
        }


        function processChartData(data, columnName) {
            const accuracyIndex = COLUMN_INDICES['Accuracy'];
            const colIndex = COLUMN_INDICES[columnName];
            if (accuracyIndex === undefined || colIndex === undefined) return { labels: [], values: [] };

            const stats = {};

            data.forEach(row => {
                let category = row[colIndex];
                if (!category) return;

                if (columnName === 'Level of Confidence') {
                    const value = parseInt(category.replace('%', ''));
                    if (isNaN(value)) return;
                    if (value >= 90) category = '90-100%';
                    else if (value >= 80) category = '80-89%';
                    else if (value >= 70) category = '70-79%';
                    else if (value >= 60) category = '60-69%';
                    else if (value >= 50) category = '50-59%';
                    else category = '0-49%';
                }

                if (!stats[category]) {
                    stats[category] = { total: 0, success: 0 };
                }
                stats[category].total++;
                if (String(row[accuracyIndex]).trim().toLowerCase() === 'success') {
                    stats[category].success++;
                }
            });
            
            const sortedLabels = Object.keys(stats).sort();

            const labels = [];
            const values = [];

            sortedLabels.forEach(label => {
                const { total, success } = stats[label];
                labels.push(label);
                values.push(total > 0 ? (success / total) * 100 : 0);
            });

            return { labels, values };
        }

        function renderAnalyticsCharts(filteredChartData) {
            
            const CHART_PALETTE = ['#0891b2', '#0d9488', '#6d28d9', '#f59e0b', '#ec4899', '#3b82f6', '#8b5cf6'];
            
            const chartConfigs = {
                'preferenceChart': { type: 'bar', columnName: 'Preference', title: 'Success Rate by Preference' },
                'winningMarginChart': { type: 'bar', columnName: 'Winning Margin', title: 'Success Rate by Winning Margin' },
                'analyzedPredictionChart': { type: 'bar', columnName: 'Analyzed Prediction', title: 'Success Rate by Prediction Type' },
                'goalsTipChart': { type: 'bar', columnName: 'Goals Tip', title: 'Success Rate by Goals Tip' },
                'confidenceChart': { type: 'bar', columnName: 'Level of Confidence', title: 'Success Rate by Confidence Level' },
            };
            
            Object.entries(chartConfigs).forEach(([canvasId, config]) => {
                const { labels, values } = processChartData(filteredChartData, config.columnName);
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                if (charts[canvasId]) charts[canvasId].destroy();

                charts[canvasId] = new Chart(ctx, {
                    type: config.type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Success Rate',
                            data: values,
                            backgroundColor: CHART_PALETTE,
                            borderColor: CHART_PALETTE,
                            borderWidth: 1,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: { display: true, text: config.title, font: { size: 16, weight: 'bold' }, color: '#1e293b', padding: { bottom: 20 } },
                            legend: { display: false },
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Success Rate: ${context.parsed.y.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } }
                    }
                });
            });

            // Special chart: Prediction Accuracy (Doughnut)
            const accuracyIndex = COLUMN_INDICES['Accuracy'];
            let successCount = 0, unsuccessCount = 0;
            if(accuracyIndex !== undefined) {
                filteredChartData.forEach(row => {
                    const accuracy = String(row[accuracyIndex]).trim().toLowerCase();
                    if (accuracy === 'success') successCount++;
                    else if (accuracy === 'unsuccessful') unsuccessCount++;
                });
            }
            if (charts['predictionAccuracyChart']) charts['predictionAccuracyChart'].destroy();
            charts['predictionAccuracyChart'] = new Chart(document.getElementById('predictionAccuracyChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Unsuccessful'],
                    datasets: [{ data: [successCount, unsuccessCount], backgroundColor: ['#10b981', '#f43f5e'], borderColor: '#fff', borderWidth: 4 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    plugins: { 
                        title: { display: true, text: 'Prediction Accuracy Overview', font: { size: 16, weight: 'bold' }, color: '#1e293b', padding: { bottom: 20 } },
                        legend: { position: 'bottom' }
                    }
                }
            });

            const timeData = {};
            const dateIndex = COLUMN_INDICES['Date'];
            if(dateIndex !== undefined && accuracyIndex !== undefined) {
                filteredChartData.forEach(row => {
                    const date = row[dateIndex];
                    if(!date) return;
                    if(!timeData[date]) timeData[date] = { total: 0, success: 0 };
                    timeData[date].total++;
                    if(String(row[accuracyIndex]).trim().toLowerCase() === 'success') timeData[date].success++;
                });
            }
            const sortedDates = Object.keys(timeData).sort((a,b) => new Date(a) - new Date(b));
            const timeLabels = sortedDates;
            const timeValues = sortedDates.map(date => (timeData[date].success / timeData[date].total) * 100);

            if (charts['successOverTimeChart']) charts['successOverTimeChart'].destroy();
            charts['successOverTimeChart'] = new Chart(document.getElementById('successOverTimeChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Success Rate',
                        data: timeValues,
                        borderColor: '#0891b2',
                        backgroundColor: 'rgba(8, 145, 178, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#0891b2',
                        pointRadius: 4
                    }]
                },
                 options: {
                    responsive: true, maintainAspectRatio: true,
                    plugins: { 
                        title: { display: true, text: 'Success Rate Over Time', font: { size: 16, weight: 'bold' }, color: '#1e293b', padding: { bottom: 20 } },
                        legend: { display: false },
                        tooltip: { callbacks: { label: context => `Success Rate: ${context.parsed.y.toFixed(1)}%` } }
                    },
                    scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } }
                }
            });
             lucide.createIcons();
        }

        // --- TEAM FORM INSIGHT FEATURE ---
        function getTeamForm(teamName, matchDateStr) {
            const matchDate = new Date(matchDateStr);
            // Data is already sorted by date descending
            const teamMatches = allData.filter(pastMatch => {
                const pastMatchDate = new Date(pastMatch[COLUMN_INDICES['Date']]);
                const isParticipant = pastMatch[COLUMN_INDICES['Home Team']] === teamName || pastMatch[COLUMN_INDICES['Away Team']] === teamName;
                return isParticipant && pastMatchDate < matchDate;
            }).slice(0, 5);

            return teamMatches.map(match => {
                const outcome = match[COLUMN_INDICES['Match Outcome']];
                const wasHome = match[COLUMN_INDICES['Home Team']] === teamName;
                
                if (outcome === 'Home Win') return wasHome ? 'W' : 'L';
                if (outcome === 'Away Win') return wasHome ? 'L' : 'W';
                if (outcome === 'Draw') return 'D';
                return '-';
            });
        }


        // --- UI & MODAL FUNCTIONS ---

        function updatePaginationControls(totalPages) {
            dom.pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            dom.prevPageBtn.disabled = currentPage === 1;
            dom.nextPageBtn.disabled = currentPage === totalPages;
        }

        function updateHighConfidencePaginationControls(totalPages) {
            dom.highConfidencePageInfo.textContent = `Page ${highConfidenceCurrentPage} of ${totalPages}`;
            dom.highConfidencePrevPageBtn.disabled = highConfidenceCurrentPage === 1;
            dom.highConfidenceNextPageBtn.disabled = highConfidenceCurrentPage === totalPages;
        }

        function openModal(row) {
            const homeTeam = row[COLUMN_INDICES['Home Team']] || 'N/A';
            const awayTeam = row[COLUMN_INDICES['Away Team']] || 'N/A';
            dom.modalTitle.textContent = `Match Details`; 

            const confidenceText = row[COLUMN_INDICES['Level of Confidence']] || '0%';
            const confidenceValue = parseInt(confidenceText.replace('%', ''), 10) || 0;
            const urlSource = row[COLUMN_INDICES['SourceURL']];
            const finalScore = row[COLUMN_INDICES['Final Score / Time']] || '-';
            const scoreIsMissing = finalScore === '-' || finalScore.includes(':');

            // Determine confidence bar color
            let confidenceBarColor = 'bg-rose-500';
            if (confidenceValue >= 70) confidenceBarColor = 'bg-amber-500';
            if (confidenceValue >= 80) confidenceBarColor = 'bg-emerald-500';
            
            const homeTeamForm = getTeamForm(homeTeam, row[COLUMN_INDICES['Date']]);
            const awayTeamForm = getTeamForm(awayTeam, row[COLUMN_INDICES['Date']]);
            const getFormHtml = (formArray) => {
                if (!formArray || formArray.length === 0) return '<span class="text-xs text-slate-400">No recent data</span>';
                return formArray.map(result => {
                    let bgColor = 'bg-slate-400'; // Draw
                    if (result === 'W') bgColor = 'bg-emerald-500';
                    if (result === 'L') bgColor = 'bg-rose-500';
                    return `<span class="w-6 h-6 flex items-center justify-center text-xs font-bold text-white ${bgColor} rounded-full">${result}</span>`;
                }).join('');
            };
            const formHTML = `
                <div class="md:col-span-3 mt-4 pt-4 border-t">
                    <h4 class="font-bold text-slate-700 mb-3 text-base">Recent Form (Last 5 Games)</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-semibold text-slate-800">${homeTeam}</span>
                            <div class="flex items-center gap-2">${getFormHtml(homeTeamForm)}</div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-semibold text-slate-800">${awayTeam}</span>
                            <div class="flex items-center gap-2">${getFormHtml(awayTeamForm)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            let modalBodyContent = ``;
             originalHeaders.forEach(header => {
                let cellValue = row[COLUMN_INDICES[header]];
                // Add the fetch button right after the Final Score
                if(header === 'Final Score / Time') {
                     modalBodyContent += `
                        <div>
                            <p class="font-semibold text-slate-600">${header}</p>
                            <div class="flex items-center">
                                <p class="text-slate-800" id="modal-final-score">${cellValue || '-'}</p>
                                ${scoreIsMissing ? `
                                <button id="fetchOutcomeBtn"
                                    data-home-team="${homeTeam}"
                                    data-away-team="${awayTeam}"
                                    data-date="${row[COLUMN_INDICES['Date']]}"
                                    class="ml-2 bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold py-1 px-2 rounded-lg transition">
                                        Fetch
                                </button>` : ''}
                            </div>
                        </div>`;
                } else if(header && cellValue) {
                    modalBodyContent += `<div>
                        <p class="font-semibold text-slate-600">${header}</p>
                        <p class="text-slate-800">${cellValue}</p>
                    </div>`;
                }
            });


            dom.modalBody.innerHTML = `
                <div class="md:col-span-3 grid grid-cols-2 gap-4">
                    ${modalBodyContent}
                </div>
                ${formHTML}
                <div class="md:col-span-3 mt-4 pt-4 border-t">
                    <div class="mt-3">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-700">Level of Confidence</span>
                            <span class="text-sm font-bold text-cyan-600">${confidenceText}</span>
                        </div>
                        <div class="w-full bg-stone-200 rounded-full h-2.5">
                            <div class="${confidenceBarColor} h-2.5 rounded-full" style="width: ${confidenceValue}%"></div>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-3 mt-4 pt-4 border-t">
                     <button id="getExternalAnalysisBtn" data-home-team="${homeTeam}" data-away-team="${awayTeam}" class="flex items-center justify-center w-full text-center bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-4 rounded-lg transition">
                         <i data-lucide="search" class="w-4 h-4 mr-2"></i> Fetch Other Predictions
                     </button>
                     <textarea id="external-analysis-container" class="mt-4 w-full p-3 h-32 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 hidden" readonly></textarea>
                </div>
                ${(urlSource && urlSource.startsWith('http')) ? `
                <div class="md:col-span-3 mt-6"><a href="${urlSource}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center w-full text-center bg-slate-600 hover:bg-slate-700 text-white font-bold py-2.5 px-4 rounded-lg transition">
                    View Original Source
                    <i data-lucide="external-link" class="w-4 h-4 ml-2"></i>
                </a></div>` : ''}
            `;
            
            lucide.createIcons();
            dom.modal.classList.remove('hidden');
            setTimeout(() => {
                dom.modalOverlay.classList.remove('opacity-0');
                dom.modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0', '-translate-y-10');
            }, 10);

            document.getElementById('getExternalAnalysisBtn').addEventListener('click', handleExternalAnalysisClick);
            document.getElementById('fetchOutcomeBtn')?.addEventListener('click', handleFetchOutcomeClick);
        }

        function closeModal() {
            dom.modalOverlay.classList.add('opacity-0');
            dom.modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0', '-translate-y-10');
            setTimeout(() => { dom.modal.classList.add('hidden'); }, 300);
        }

        // --- GEMINI API & EXTERNAL ANALYSIS ---
        async function handleExternalAnalysisClick(e) {
            const button = e.currentTarget;
            const { homeTeam, awayTeam } = button.dataset;
            const textbox = document.getElementById('external-analysis-container');

            button.disabled = true;
            button.innerHTML = `<div class="loader !w-5 !h-5 !border-2 !border-t-white/50 mx-auto"></div>`;
            textbox.value = 'Searching for external analysis...';
            textbox.classList.remove('hidden');

            try {
                const result = await fetchExternalAnalysis(homeTeam, awayTeam);
                let resultText = `Analysis Summary:\n${result.text}`;

                if (result.sources && result.sources.length > 0) {
                    resultText += `\n\nSources:\n`;
                    result.sources.forEach(source => {
                         resultText += `- ${source.title}: ${source.uri}\n`;
                    });
                }
                textbox.value = resultText;

            } catch (error) {
                console.error("External analysis failed:", error);
                textbox.value = "Sorry, could not retrieve external analysis at this time.";
            } finally {
                button.disabled = false;
                 button.innerHTML = `<i data-lucide="search" class="w-4 h-4 mr-2"></i> Fetch Other Predictions`;
                 lucide.createIcons();
            }
        }

        async function fetchExternalAnalysis(homeTeam, awayTeam, retries = 3, delay = 1000) {
            const apiKey = ""; // Canvas provides this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are a sports analytics assistant. Based on the provided search results, provide a concise, one-paragraph summary of the match prediction. Focus on the most likely outcome, key stats, or expert opinions found. Mention the source if possible.";
            const userQuery = `"${homeTeam}" vs "${awayTeam}" match prediction statarea.com`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                 if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchExternalAnalysis(homeTeam, awayTeam, retries - 1, delay * 2);
                    }
                    let errorDetail = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.error?.message || JSON.stringify(errorData);
                    } catch (e) { /* Ignore if parsing fails */ }
                    throw new Error(`API Error (${response.status}): ${errorDetail}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };
                } else {
                    throw new Error("No content generated in the response.");
                }
            } catch (error) {
                console.error("Fetch failed:", error);
                throw error;
            }
        }
        
        async function fetchMatchOutcome(homeTeam, awayTeam, date, retries = 3, delay = 1000) {
            const apiKey = ""; // Canvas provides this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = `You are a sports data API. Your task is to find the final score of a specific football match. Respond ONLY with the score in the format "HomeScore - AwayScore" (e.g., "2 - 1"). If the match has not been played yet, respond with "TBD". If you cannot find the definitive score, respond with "Not Found". Do not add any extra words, explanations, or punctuation.`;
            const userQuery = `final score for football match ${homeTeam} vs ${awayTeam} on ${date}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchMatchOutcome(homeTeam, awayTeam, date, retries - 1, delay * 2);
                    }
                    let errorDetail = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.error?.message || JSON.stringify(errorData);
                    } catch (e) { /* Ignore if parsing fails */ }
                    throw new Error(`API Error (${response.status}): ${errorDetail}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return { text: candidate.content.parts[0].text };
                } else {
                    throw new Error("No content generated in the response.");
                }
            } catch (error) {
                console.error("Fetch failed:", error);
                throw error;
            }
        }

        // --- ADMIN & COLUMN MANAGEMENT ---
        function loadColumnConfiguration() {
            const savedMain = localStorage.getItem('mainTableHeaders');
            const savedHighConf = localStorage.getItem('highConfidenceTableHeaders');

            mainTableHeaders = savedMain ? JSON.parse(savedMain) : [...DEFAULT_MAIN_TABLE_HEADERS];
            highConfidenceTableHeaders = savedHighConf ? JSON.parse(savedHighConf) : [...DEFAULT_HIGH_CONFIDENCE_HEADERS];
        }

        function saveColumnConfiguration() {
            const mainContainer = dom.mainTableAdminContainer;
            const newMainHeaders = Array.from(mainContainer.querySelectorAll('li'))
                .filter(li => li.querySelector('input[type="checkbox"]').checked)
                .map(li => li.dataset.column);

            const highConfContainer = dom.highConfidenceTableAdminContainer;
            const newHighConfHeaders = Array.from(highConfContainer.querySelectorAll('li'))
                .filter(li => li.querySelector('input[type="checkbox"]').checked)
                .map(li => li.dataset.column);
            
            mainTableHeaders = newMainHeaders;
            highConfidenceTableHeaders = newHighConfHeaders;

            localStorage.setItem('mainTableHeaders', JSON.stringify(mainTableHeaders));
            localStorage.setItem('highConfidenceTableHeaders', JSON.stringify(highConfidenceTableHeaders));

            renderMainTableHeaders();
            renderHighConfidenceHeaders();
            applyFiltersAndRender();

            dom.adminMessage.textContent = 'Settings saved successfully!';
            setTimeout(() => { dom.adminMessage.textContent = ''; }, 3000);
        }

        function resetColumnConfiguration() {
            mainTableHeaders = [...DEFAULT_MAIN_TABLE_HEADERS];
            highConfidenceTableHeaders = [...DEFAULT_HIGH_CONFIDENCE_HEADERS];
            localStorage.removeItem('mainTableHeaders');
            localStorage.removeItem('highConfidenceTableHeaders');
            
            renderAdminUI();
            renderMainTableHeaders();
            renderHighConfidenceHeaders();
            applyFiltersAndRender();
            
            dom.adminMessage.textContent = 'Settings reset to default.';
            setTimeout(() => { dom.adminMessage.textContent = ''; }, 3000);
        }
        
        function renderAdminUI() {
            const createColumnItem = (columnName, isVisible) => `
                <li data-column="${columnName}" class="draggable-item flex items-center justify-between p-2 bg-white rounded-md shadow-sm border" draggable="true">
                    <div class="flex items-center">
                        <i data-lucide="grip-vertical" class="w-5 h-5 text-slate-400 mr-2"></i>
                        <label for="check-${columnName.replace(/\s+/g, '-')}" class="text-sm font-medium text-slate-700">${columnName}</label>
                    </div>
                    <input type="checkbox" id="check-${columnName.replace(/\s+/g, '-')}" ${isVisible ? 'checked' : ''} class="h-4 w-4 rounded border-slate-300 text-cyan-600 focus:ring-cyan-500">
                </li>
            `;
            
            dom.mainTableAdminContainer.innerHTML = ALL_POSSIBLE_COLUMNS
                .map(col => createColumnItem(col, mainTableHeaders.includes(col)))
                .join('');
            
            dom.highConfidenceTableAdminContainer.innerHTML = ALL_POSSIBLE_COLUMNS
                .map(col => createColumnItem(col, highConfidenceTableHeaders.includes(col)))
                .join('');
            
            lucide.createIcons();
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const containers = [dom.mainTableAdminContainer, dom.highConfidenceTableAdminContainer];
            containers.forEach(container => {
                let draggingElement = null;
                container.addEventListener('dragstart', e => {
                    draggingElement = e.target;
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                });

                container.addEventListener('dragend', e => {
                    e.target.classList.remove('dragging');
                });

                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    const target = e.target.closest('.draggable-item');
                    if (target && target !== draggingElement) {
                        const rect = target.getBoundingClientRect();
                        const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > .5;
                        if (next) {
                            container.insertBefore(draggingElement, target.nextSibling);
                        } else {
                            container.insertBefore(draggingElement, target);
                        }
                    }
                });
            });
        }
        
        // --- TEAM COMPARISON FUNCTIONS ---
        function initializeComparisonTools() {
             const allTeams = [...new Set(allData.flatMap(row => [row[COLUMN_INDICES['Home Team']], row[COLUMN_INDICES['Away Team']]]))].filter(Boolean).sort();
             if (teamSelect) teamSelect.destroy();
             teamSelect = new TomSelect('#team-select', {
                options: allTeams.map(team => ({value: team, text: team})),
                plugins: ['remove_button'],
                onChange: runComparison,
             });
             
             if(dateRangePicker) dateRangePicker.destroy();
             dateRangePicker = new Litepicker({
                element: document.getElementById('date-range-picker'),
                singleMode: false,
                format: 'YYYY-MM-DD',
                setup: (picker) => {
                    picker.on('selected', (date1, date2) => {
                        runComparison();
                    });
                },
             });
        }
        
        function runComparison() {
            const selectedTeams = teamSelect.getValue();
            const startDateObj = dateRangePicker.getStartDate();
            const endDateObj = dateRangePicker.getEndDate();

            if (selectedTeams.length < 2 || !startDateObj || !endDateObj) {
                dom.comparisonResultsContainer.classList.add('hidden');
                dom.comparisonPlaceholder.classList.remove('hidden');
                return;
            }

            const startDate = startDateObj.dateInstance;
            const endDate = endDateObj.dateInstance;

            const comparisonData = allData.filter(row => {
                const matchDateStr = row[COLUMN_INDICES['Date']];
                if (!matchDateStr) return false;

                const matchDate = new Date(matchDateStr);
                if (isNaN(matchDate.getTime())) return false;

                const homeTeam = row[COLUMN_INDICES['Home Team']];
                const awayTeam = row[COLUMN_INDICES['Away Team']];
                
                const isWithinDateRange = matchDate >= startDate && matchDate <= endDate;
                const involvesSelectedTeams = selectedTeams.some(team => team === homeTeam || team === awayTeam);

                return isWithinDateRange && involvesSelectedTeams;
            });

            renderComparisonTable(comparisonData);
            dom.comparisonResultsContainer.classList.remove('hidden');
            dom.comparisonPlaceholder.classList.add('hidden');
        }

        function renderComparisonTable(data) {
            const headers = ['Date', 'Home Team', 'Away Team', 'Final Score / Time', 'Analyzed Prediction', 'Level of Confidence', 'Accuracy'];
            dom.comparisonTableHead.innerHTML = `<tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;

            if(data.length === 0){
                dom.comparisonTableBody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center p-8 text-slate-500">No matches found for the selected teams in this period.</td></tr>`;
                return;
            }
            
            dom.comparisonTableBody.innerHTML = data.map(row => {
                return `
                    <tr class="hover:bg-cyan-50">
                        ${headers.map(header => {
                            let value = row[COLUMN_INDICES[header]] || '-';
                            let classes = 'px-6 py-4 whitespace-nowrap text-sm text-slate-700';
                            
                            if(header === 'Home Team' || header === 'Away Team') {
                                classes += ' font-bold text-cyan-900';
                            }
                            if(header === 'Analyzed Prediction') {
                                value = getStyledPredictionBadge(value);
                            }
                            if(header === 'Accuracy') {
                                if ((value || '').toLowerCase() === 'success') {
                                    value = `<span class="bg-emerald-100 text-emerald-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Success</span>`;
                                } else if ((value || '').toLowerCase() === 'unsuccessful') {
                                    value = `<span class="bg-rose-100 text-rose-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Unsuccessful</span>`;
                                } else {
                                    value = `<span class="text-slate-400">-</span>`;
                                }
                            }
                            return `<td class="${classes}">${value}</td>`
                        }).join('')}
                    </tr>
                `;
            }).join('');
        }


        // --- EVENT LISTENERS ---

        dom.showSignup.addEventListener('click', (e) => { e.preventDefault(); switchView('signup'); });
        dom.showLogin.addEventListener('click', (e) => { e.preventDefault(); switchView('login'); });
        dom.loginForm.addEventListener('submit', handleLogin);
        dom.signupForm.addEventListener('submit', handleSignup);
        dom.logoutBtn.addEventListener('click', handleLogout);
        dom.sidebarNav.addEventListener('click', handleSidebarClick);
        dom.allFilterInputs.forEach(input => {
            input.addEventListener('input', handleFilterChange);
            input.addEventListener('change', handleFilterChange); // for selects
        });
        dom.resetFiltersBtn.addEventListener('click', resetFilters);
        dom.analyticsDateFilter.addEventListener('change', updateAnalytics);
        dom.analyticsTotalGoalsFilter.addEventListener('change', updateAnalytics);
        dom.tableHeader.addEventListener('click', handleSort);
        dom.tableBody.addEventListener('click', handleMainTableRowClick);
        dom.prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderMainTablePage(); }});
        dom.nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(currentFilteredData.length / ROWS_PER_PAGE);
            if (currentPage < totalPages) { currentPage++; renderMainTablePage(); }
        });

        dom.highConfidenceTableBody.addEventListener('click', handleHighConfidenceRowClick);
        dom.highConfidencePrevPageBtn.addEventListener('click', () => { 
            if (highConfidenceCurrentPage > 1) { 
                highConfidenceCurrentPage--; 
                renderHighConfidencePicksTable(); 
            }
        });
        dom.highConfidenceNextPageBtn.addEventListener('click', () => {
            const picks = currentFilteredData.filter(row => {
                const analyzedPrediction = row[COLUMN_INDICES['Analyzed Prediction']];
                return analyzedPrediction === 'Home Best Tip' || analyzedPrediction === 'Best Away Tip';
            });
            const totalPages = Math.ceil(picks.length / HIGH_CONFIDENCE_ROWS_PER_PAGE);
            if (highConfidenceCurrentPage < totalPages) { 
                highConfidenceCurrentPage++; 
                renderHighConfidencePicksTable(); 
            }
        });
        
        dom.modalCloseBtn.addEventListener('click', closeModal);
        dom.modalOverlay.addEventListener('click', closeModal);
        document.addEventListener('keydown', (e) => { if (e.key === "Escape" && !dom.modal.classList.contains('hidden')) closeModal(); });
        dom.saveColumnsBtn.addEventListener('click', saveColumnConfiguration);
        dom.resetColumnsBtn.addEventListener('click', resetColumnConfiguration);
        dom.syncDataBtn.addEventListener('click', handleSyncClick);

        // --- INITIALIZATION ---
        if (localStorage.getItem('loggedInUser')) {
            showDashboard();
        } else {
            showAuth();
        }
    });
    </script>
</body>
</html>
