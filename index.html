<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Compass | Sports Analytics</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%230891b2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><title>Data Compass Favicon</title><circle cx='12' cy='12' r='10'></circle><polygon points='16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76'></polygon></svg>">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Litepicker for date range selection -->
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <!-- Tom Select for multi-select dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Use the Poppins font */
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Custom scrollbar for better aesthetics in dark mode */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; } /* slate-800 */
        ::-webkit-scrollbar-thumb { background: #0891b2; border-radius: 10px; } /* Cyan 600 */
        ::-webkit-scrollbar-thumb:hover { background: #0e7490; } /* Cyan 700 */
        
        /* Style for table headers to make them sticky and sortable */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        /* Styles for sorting indicators */
        .sort-asc::after { content: ' ▲'; font-size: 0.8em; }
        .sort-desc::after { content: ' ▼'; font-size: 0.8em; }

        /* Loading Spinner Animation */
        .loader {
            border: 5px solid #1e293b; 
            border-radius: 50%;
            border-top: 5px solid #0891b2; /* Cyan 600 */
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Transitions */
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }

        /* All Events & Best Analysis Modal styles */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .scrollable-table {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Sidebar navigation active state */
        .sidebar-link.active {
            background-color: #0891b2; /* Cyan 600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .page-content.hidden {
            display: none;
        }

        /* Custom styling for range input */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #334155; /* slate-700 */
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #0891b2; /* cyan-600 */
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #0891b2;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Insight Card Progress Circle */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Drag and Drop styles for Admin panel */
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .dragging { opacity: 0.5; background: #0f172a; }
        .drag-over { border: 2px dashed #0891b2; }
        
        /* Tom Select custom dark styles */
        .ts-control {
            border-radius: 0.5rem !important;
            background-color: #334155 !important;
            border-color: #475569 !important;
            color: #e2e8f0;
        }
        .ts-control:focus-within {
             border-color: #0891b2 !important;
             box-shadow: 0 0 0 1px #0891b2 !important;
        }
        .ts-dropdown {
            background: #1e293b !important;
            border-color: #475569 !important;
        }
        .ts-dropdown .ts-option {
            color: #cbd5e1;
        }
        .ts-dropdown .ts-option.active, .ts-dropdown .ts-option:hover {
            background-color: #0891b2 !important;
            color: white !important;
        }
        .ts-control .item {
            background: #0891b2 !important;
            color: white !important;
        }
    </style>
</head>
<body class="antialiased text-slate-300 bg-slate-900">

    <!-- Auth Container -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen bg-slate-900">
        <div class="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
            
            <!-- Login Form -->
            <div id="login-view">
                <div class="text-center">
                    <div class="mx-auto h-16 w-16 mb-4 flex items-center justify-center bg-cyan-900/50 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-extrabold text-cyan-400">Data Compass</h2>
                    <p class="mt-2 text-sm text-slate-400">Precision in Prediction. Accuracy in Analytics.</p>
                </div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div class="space-y-4 rounded-md shadow-sm">
                        <div>
                            <label for="login-email" class="sr-only">Email address</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none bg-slate-700 border-slate-600 text-slate-200 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Email address">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">Password</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none bg-slate-700 border-slate-600 text-slate-200 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Password">
                        </div>
                    </div>
                    <p id="login-error" class="text-sm text-center text-rose-500"></p>
                    <div>
                        <button type="submit" class="relative flex justify-center w-full px-4 py-3 text-sm font-medium text-white bg-cyan-600 border border-transparent rounded-lg group hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                            Sign in
                        </button>
                    </div>
                </form>
                <p class="mt-6 text-sm text-center">
                    Don't have an account?
                    <a href="#" id="show-signup" class="font-medium text-cyan-500 hover:text-cyan-400">Sign up</a>
                </p>
            </div>

            <!-- Signup Form -->
            <div id="signup-view" class="hidden">
                 <div class="text-center">
                     <div class="mx-auto h-16 w-16 mb-4 flex items-center justify-center bg-cyan-900/50 rounded-lg">
                         <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400">
                             <circle cx="12" cy="12" r="10"></circle>
                             <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
                             <circle cx="12" cy="12" r="3"></circle>
                         </svg>
                    </div>
                    <h2 class="text-3xl font-extrabold text-cyan-400">Create an Account</h2>
                    <p class="mt-2 text-sm text-slate-400">Get started with your sports analytics journey</p>
                </div>
                <form id="signup-form" class="mt-8 space-y-6">
                    <div class="space-y-4 rounded-md shadow-sm">
                        <div>
                            <label for="signup-name" class="sr-only">Full Name</label>
                            <input id="signup-name" name="name" type="text" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none bg-slate-700 border-slate-600 text-slate-200 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Full Name">
                        </div>
                        <div>
                            <label for="signup-email" class="sr-only">Email address</label>
                            <input id="signup-email" name="email" type="email" autocomplete="email" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none bg-slate-700 border-slate-600 text-slate-200 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Email address">
                        </div>
                        <div>
                            <label for="signup-password" class="sr-only">Password</label>
                            <input id="signup-password" name="password" type="password" autocomplete="new-password" required class="relative block w-full px-3 py-3 text-sm placeholder-slate-400 border rounded-lg appearance-none bg-slate-700 border-slate-600 text-slate-200 focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10" placeholder="Password">
                        </div>
                    </div>
                    <p id="signup-message" class="text-sm text-center"></p>
                    <div>
                        <button type="submit" class="relative flex justify-center w-full px-4 py-3 text-sm font-medium text-white bg-cyan-600 border border-transparent rounded-lg group hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                            Sign up
                        </button>
                    </div>
                </form>
                 <p class="mt-6 text-sm text-center">
                    Already have an account?
                    <a href="#" id="show-login" class="font-medium text-cyan-500 hover:text-cyan-400">Sign in</a>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Container (Initially Hidden) -->
    <div id="dashboard-container" class="hidden h-screen">
        <div class="flex h-screen">
            <!-- Sidebar Navigation -->
            <aside class="w-64 bg-slate-800 shadow-lg flex flex-col flex-shrink-0 border-r border-slate-700">
                <div class="p-6 flex items-center space-x-4 border-b border-slate-700">
                    <div class="h-10 w-10 flex items-center justify-center bg-cyan-900/50 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-cyan-400">Data Compass</h1>
                </div>
                <nav id="sidebar-nav" class="flex-1 px-4 py-6 space-y-2">
                     <a href="#" data-target="content-best-analysis" class="sidebar-link active flex items-center px-4 py-2.5 text-slate-300 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                         <i data-lucide="bar-chart-big" class="w-5 h-5 mr-3"></i>
                         Best Analysis
                     </a>
                    <a href="#" data-target="content-dashboard" class="sidebar-link flex items-center px-4 py-2.5 text-slate-300 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                         <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                        Matches
                    </a>
                    <a href="#" data-target="content-all-events" class="sidebar-link flex items-center px-4 py-2.5 text-slate-300 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        All Events
                    </a>
                    <a href="#" data-target="content-analytics" class="sidebar-link flex items-center px-4 py-2.5 text-slate-300 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Analytics
                    </a>
                    <a href="#" data-target="content-admin" class="sidebar-link flex items-center px-4 py-2.5 text-slate-300 rounded-lg hover:bg-cyan-600 hover:text-white transition-colors">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Admin
                    </a>
                </nav>
                 <div class="p-4 border-t border-slate-700">
                     <div class="text-xs text-slate-400 mb-2">Logged in as: <span id="user-email-display" class="font-semibold"></span></div>
                    <button id="logout-btn" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center justify-center space-x-2 shadow-sm hover:shadow-md">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-slate-800 shadow-sm p-4 flex justify-between items-center z-20 flex-shrink-0 border-b border-slate-700">
                    <h1 id="main-header-title" class="text-2xl font-bold text-cyan-400">Best Analysis</h1>
                    <div class="flex space-x-2">
                        <button id="syncDataBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center space-x-2 shadow-sm hover:shadow-md">
                            <svg class="w-4 h-4" id="syncIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.25-4.25l-1.47 1.47c.56.98.82 2.09.82 3.28 0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                            <span id="syncText">Sync Data</span>
                        </button>
                    </div>
                </header>

                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-900 p-4 sm:p-6 lg:p-8">
                    <div id="content-dashboard" class="page-content hidden">
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6 mb-8" id="dashboard-stats-cards">
                             <div class="bg-slate-800 p-6 rounded-xl shadow-md flex items-center border border-slate-700 col-span-1 xl:col-span-1">
                                 <div class="flex-shrink-0 bg-cyan-500/10 text-cyan-400 rounded-full h-16 w-16 flex items-center justify-center">
                                     <i data-lucide="hash" class="w-8 h-8"></i>
                                 </div>
                                 <div class="ml-5">
                                     <h4 class="text-slate-400 text-sm font-medium">Filtered Events</h4>
                                     <p id="dashboard-total-events" class="text-slate-200 text-2xl font-bold">-</p>
                                 </div>
                             </div>
                            <div class="grid grid-cols-2 md:grid-cols-2 xl:grid-cols-4 gap-6 col-span-1 md:col-span-1 xl:col-span-4" id="dashboard-prediction-counts">
                                <!-- Prediction counts will be injected here -->
                            </div>
                        </div>

                        <!-- Filters Section -->
                        <div id="dashboard-filters" class="bg-slate-800/70 backdrop-blur-lg rounded-xl shadow-md mb-8 p-6 border border-slate-700">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">Filter Data</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div>
                                    <label for="searchFilter" class="block text-sm font-medium text-slate-300 mb-2">Search Teams</label>
                                    <div class="relative">
                                        <input type="text" id="searchFilter" placeholder="e.g., Man United" class="filter-input w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 pl-10 transition">
                                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="dateFilter" class="block text-sm font-medium text-slate-300 mb-2">Date</label>
                                    <select id="dateFilter" data-filter-key="date" class="filter-input w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Dates</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="preferenceFilter" class="block text-sm font-medium text-slate-300 mb-2">Preference</label>
                                    <select id="preferenceFilter" data-filter-key="preference" class="filter-input w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Preferences</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="winningMarginFilter" class="block text-sm font-medium text-slate-300 mb-2">Winning Margin</label>
                                    <select id="winningMarginFilter" data-filter-key="winningMargin" class="filter-input w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Margins</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="analyzedPredictionFilter" class="block text-sm font-medium text-slate-300 mb-2">Analyzed Prediction</label>
                                    <select id="analyzedPredictionFilter" data-filter-key="analyzedPrediction" class="filter-input w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Predictions</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="goalsTipFilter" class="block text-sm font-medium text-slate-300 mb-2">Goals Tip</label>
                                    <select id="goalsTipFilter" data-filter-key="goalsTip" class="filter-input w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Goal Tips</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="totalGoalsFilter" class="block text-sm font-medium text-slate-300 mb-2">Total Goals</label>
                                    <select id="totalGoalsFilter" data-filter-key="totalGoals" class="filter-input w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Totals</option>
                                    </select>
                                </div>
                                <div class="lg:col-span-4">
                                    <label for="confidenceRangeFilter" class="block text-sm font-medium text-slate-300 mb-2">
                                        Level of Confidence: <span id="confidenceRangeValue" class="font-bold text-cyan-400">70%</span>
                                    </label>
                                    <input type="range" id="confidenceRangeFilter" data-filter-key="minConfidence" min="0" max="100" value="70" class="filter-input w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                </div>

                                <div class="col-span-full flex justify-end gap-4 mt-4">
                                    <button id="resetFiltersBtn" class="bg-slate-600 hover:bg-slate-500 text-slate-200 font-bold py-2.5 px-6 rounded-lg transition">Reset Filters</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- All Match Data Table -->
                        <div class="bg-slate-800 rounded-xl shadow-md overflow-hidden border border-slate-700">
                             <div class="p-4 border-b border-slate-700">
                                 <h3 class="text-xl font-bold text-cyan-400">All Match Data</h3>
                                <p class="text-sm text-slate-400 mt-1">A comprehensive list of all matches. Use the filters above to refine the results.</p>
                            </div>
                            <div id="table-container" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-700">
                                    <thead class="bg-slate-700/50">
                                        <tr></tr>
                                    </thead>
                                    <tbody id="dataTableBody" class="divide-y divide-slate-700">
                                         <tr><td colspan="10" class="p-8 text-center text-slate-400"><div class="loader mx-auto"></div><p class="mt-4">Loading data...</p></td></tr>
                                    </tbody>
                                </table>
                                 <div id="no-results" class="hidden p-8 text-center text-slate-400">No records match the current filters.</div>
                            </div>
                            <div id="pagination-controls" class="p-4 flex items-center justify-between border-t border-slate-700">
                                <button id="prev-page" class="relative inline-flex items-center px-4 py-2 border border-slate-600 text-sm font-medium rounded-md text-slate-300 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                                <div class="text-sm text-slate-400" id="page-info">Page 1 of 1</div>
                                <button id="next-page" class="ml-3 relative inline-flex items-center px-4 py-2 border border-slate-600 text-sm font-medium rounded-md text-slate-300 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                            </div>
                        </div>
                    </div>
                     <!-- All Events Content -->
                    <div id="content-all-events" class="page-content hidden">
                        <!-- Stats Cards -->
                         <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6 mb-8" id="ae-stats-cards">
                             <div class="bg-slate-800 p-6 rounded-xl shadow-md flex items-center border border-slate-700 col-span-1 xl:col-span-1">
                                 <div class="flex-shrink-0 bg-cyan-500/10 text-cyan-400 rounded-full h-16 w-16 flex items-center justify-center">
                                     <i data-lucide="hash" class="w-8 h-8"></i>
                                 </div>
                                 <div class="ml-5">
                                     <h4 class="text-slate-400 text-sm font-medium">Filtered Events</h4>
                                     <p id="ae-total-events" class="text-slate-200 text-2xl font-bold">-</p>
                                 </div>
                             </div>
                            <div class="grid grid-cols-2 md:grid-cols-2 xl:grid-cols-4 gap-6 col-span-1 md:col-span-1 xl:col-span-4" id="ae-prediction-counts">
                                <!-- Prediction counts will be injected here -->
                            </div>
                        </div>

                        <div class="max-w-7xl mx-auto bg-slate-800 rounded-3xl shadow-xl p-6 md:p-10 border border-slate-700">
                            <h2 class="text-xl font-bold text-cyan-400 mb-4">Filter All Events</h2>
                        
                            <!-- Filter and Search Section -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4 mb-6">
                                <div class="col-span-1">
                                    <label for="ae-dateFilter" class="block text-sm font-medium text-slate-300 mb-1">Date</label>
                                    <select id="ae-dateFilter" class="w-full rounded-lg bg-slate-700 border-slate-600 text-slate-200 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 transition-all duration-200">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="ae-goalsTipFilter" class="block text-sm font-medium text-slate-300 mb-1">Goals Tip</label>
                                    <select id="ae-goalsTipFilter" class="w-full rounded-lg bg-slate-700 border-slate-600 text-slate-200 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 transition-all duration-200">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="ae-accuracyFilter" class="block text-sm font-medium text-slate-300 mb-1">Accuracy</label>
                                    <select id="ae-accuracyFilter" class="w-full rounded-lg bg-slate-700 border-slate-600 text-slate-200 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 transition-all duration-200">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="ae-predictionFilter" class="block text-sm font-medium text-slate-300 mb-1">Prediction</label>
                                    <select id="ae-predictionFilter" class="w-full rounded-lg bg-slate-700 border-slate-600 text-slate-200 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 transition-all duration-200">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="ae-analyzedPredictionFilter" class="block text-sm font-medium text-slate-300 mb-1">Analyzed Prediction</label>
                                    <select id="ae-analyzedPredictionFilter" class="w-full rounded-lg bg-slate-700 border-slate-600 text-slate-200 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 transition-all duration-200">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="ae-winningMarginFilter" class="block text-sm font-medium text-slate-300 mb-1">Winning Margin</label>
                                    <select id="ae-winningMarginFilter" class="w-full rounded-lg bg-slate-700 border-slate-600 text-slate-200 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 transition-all duration-200">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="ae-teamSearch" class="block text-sm font-medium text-slate-300 mb-1">Search Team</label>
                                    <input type="text" id="ae-teamSearch" placeholder="e.g., Man Utd" class="w-full rounded-lg bg-slate-700 border-slate-600 text-slate-200 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 transition-all duration-200">
                                </div>
                            </div>
                            <div class="flex justify-end mb-6">
                                <button id="ae-resetFiltersBtn" class="px-4 py-2 bg-slate-600 text-slate-200 rounded-lg shadow-sm hover:bg-slate-500 transition-colors duration-200">
                                    Reset Filters
                                </button>
                            </div>
                        
                            <!-- Data Table -->
                            <div class="rounded-2xl shadow-lg scrollable-table-container">
                                <table class="min-w-full divide-y divide-slate-700">
                                    <thead class="bg-slate-700/50 sticky top-0 z-10">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Home</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Away</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider hidden md:table-cell">Confidence</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider hidden md:table-cell">Winning Margin</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider hidden md:table-cell">Total Goals</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider hidden lg:table-cell">Prediction</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider hidden lg:table-cell">FT Outcome</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Result</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ae-dataTableBody" class="divide-y divide-slate-700">
                                        <tr><td colspan="10" class="text-center py-4 text-slate-400">Loading data...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        
                            <!-- Pagination Controls -->
                            <div class="flex justify-between items-center mt-6">
                                <button id="ae-prevBtn" class="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg shadow-sm hover:bg-slate-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Previous
                                </button>
                                <span id="ae-pageInfo" class="text-sm text-slate-400"></span>
                                <button id="ae-nextBtn" class="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg shadow-sm hover:bg-slate-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Next
                                </button>
                            </div>
                        
                        </div>
                    
                        <!-- Pop-up Modal -->
                        <div id="ae-popupModal" class="custom-modal">
                            <div class="bg-slate-800 rounded-3xl p-8 max-w-xl w-full shadow-2xl relative border border-slate-700">
                                <button id="ae-closeModalBtn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-100 transition-transform transform hover:scale-110">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <h2 class="text-3xl font-bold mb-6 text-center text-slate-200">Match Details</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6 text-slate-300">
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Final Score / Time</span>
                                        <span id="ae-modalFinalScore" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Analyzed Prediction Score (A)</span>
                                        <span id="ae-modalAPrScore" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Analyzed Prediction Score (H)</span>
                                        <span id="ae-modalHPrScore" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Away Final Score</span>
                                        <span id="ae-modalAFinal" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Home Final Score</span>
                                        <span id="ae-modalHFinal" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Odds (Home)</span>
                                        <span id="ae-modalOddsH" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Odds (Draw)</span>
                                        <span id="ae-modalOddsD" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Odds (Away)</span>
                                        <span id="ae-modalOddsA" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium text-slate-400">Confidence</span>
                                        <span id="ae-modalConfidence" class="text-lg font-semibold"></span>
                                    </div>
                                    <div class="flex flex-col col-span-1 md:col-span-2">
                                        <span class="text-sm font-medium text-slate-400">Prediction</span>
                                        <span id="ae-modalPrediction" class="text-lg font-semibold"></span>
                                    </div>
                                </div>
                                <div class="mt-8 flex justify-center">
                                    <a id="ae-modalMatchURL" target="_blank" class="px-6 py-3 bg-cyan-600 text-white font-medium rounded-lg hover:bg-cyan-700 transition-colors duration-200 shadow-md">
                                        View Match
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Best Analysis Content -->
                    <div id="content-best-analysis" class="page-content">
                         <div class="max-w-7xl mx-auto space-y-8">

                            <!-- Header and Filters -->
                            <header class="bg-slate-800 rounded-xl shadow-lg p-6 flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4 border border-slate-700">
                                <div class="flex-grow">
                                    <h1 class="text-3xl font-bold text-cyan-400">Data Compass Analysis</h1>
                                    <p class="text-xl text-slate-400 mt-1">Accuracy and Precision</p>
                                </div>
                                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 w-full md:w-auto shadow-md p-4 rounded-lg">
                                    <select id="ba-dateFilter" class="p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full sm:w-auto text-sm">
                                        <option value="">All Dates</option>
                                    </select>
                                    <select id="ba-leagueFilter" class="p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full sm:w-auto text-sm">
                                        <option value="">All Leagues</option>
                                    </select>
                                    <select id="ba-analyzedPredictionFilter" class="p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full sm:w-auto text-sm">
                                        <option value="">All Predictions</option>
                                    </select>
                                    <select id="ba-goalTipFilter" class="p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full sm:w-auto text-sm">
                                        <option value="">All Goal Tips</option>
                                    </select>
                                    <button id="ba-refreshButton" class="p-3 rounded-lg bg-indigo-500 text-white hover:bg-indigo-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 w-full sm:w-auto text-sm">Refresh</button>
                                </div>
                            </header>

                            <!-- Summary Cards -->
                            <div id="ba-dashboardCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                                    <h3 class="text-lg font-semibold text-slate-400">Total Matches</h3>
                                    <p id="ba-totalMatches" class="text-3xl font-bold text-slate-200 mt-2">0</p>
                                    <p class="text-sm text-slate-500 mt-1">Today / Upcoming</p>
                                </div>
                                <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                                    <h3 class="text-lg font-semibold text-slate-400">Prediction Status</h3>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <span id="ba-wonStatus" class="text-xl font-bold text-green-500">0</span>
                                        <span class="text-sm text-slate-400">Won</span>
                                        <span id="ba-lostStatus" class="text-xl font-bold text-red-500">0</span>
                                        <span class="text-sm text-slate-400">Lost</span>
                                        <span id="ba-pendingStatus" class="text-xl font-bold text-slate-400">0</span>
                                        <span class="text-sm text-slate-400">Pending</span>
                                    </div>
                                    <p id="ba-wonPercentage" class="text-sm text-green-500 font-medium mt-1">0% Won</p>
                                </div>
                                <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                                    <h3 class="text-lg font-semibold text-slate-400">Tips Distribution on Odds</h3>
                                    <div id="ba-tipsDistribution" class="flex items-center space-x-4 mt-2">
                                    </div>
                                    <p class="text-sm text-slate-500 mt-1">Home vs Away vs Draw Tips</p>
                                </div>
                                <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                                    <h3 class="text-lg font-semibold text-slate-400">Average Confidence</h3>
                                    <p id="ba-avgConfidence" class="text-3xl font-bold text-blue-500 mt-2">0%</p>
                                    <p class="text-sm text-slate-500 mt-1">Goals Tip</p>
                                </div>
                            </div>

                            <!-- Main Content Section: Tabs -->
                            <div class="bg-slate-800 rounded-xl shadow-lg p-6 border border-slate-700">
                                <div class="flex border-b border-slate-700">
                                    <button id="ba-bestTipsTabBtn" class="py-2 px-4 font-semibold text-sm rounded-t-lg border-b-2 border-transparent hover:text-slate-300 transition-colors duration-200 focus:outline-none bg-green-600 text-white">Best Tips</button>
                                    <button id="ba-tableTabBtn" class="py-2 px-4 font-semibold text-sm rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-300 transition-colors duration-200 focus:outline-none">Data Table</button>
                                    <button id="ba-analyticsTabBtn" class="py-2 px-4 font-semibold text-sm rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-300 transition-colors duration-200 focus:outline-none">Match Analytics</button>
                                </div>

                                <!-- Tab Content: Best Tips -->
                                <div id="ba-bestTipsContent" class="mt-4">
                                    <div class="overflow-x-auto scrollable-table">
                                        <table id="ba-bestTipsTable" class="min-w-full divide-y divide-slate-700">
                                            <thead class="bg-slate-700/50 sticky top-0">
                                                <tr>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer sort-header" data-sort-key="Date">Date</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="HomeTeam">Home Team</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="HomeFormRate">H. Form %</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="AwayTeam">Away Team</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="AwayFormRate">A. Form %</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="OddsH">Home Odds</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="OddsD">Draw Odds</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="OddsA">Away Odds</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer sort-header" data-sort-key="Confidence">Conf. %</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="AnalyzedPrediction">Analyzed Pred.</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="MatchResult">Match Result</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="PredictionStatus">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ba-bestTipsTableBody" class="divide-y divide-slate-700"></tbody>
                                        </table>
                                    </div>
                                    <div id="ba-bestTipsPagination" class="flex justify-between items-center mt-4"></div>
                                </div>
                                
                                <!-- Tab Content: Match Table -->
                                <div id="ba-tableContent" class="mt-4 hidden">
                                    <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                                        <h2 class="text-2xl font-semibold text-slate-200">Match Predictions Table</h2>
                                        <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                                            <input type="text" id="ba-teamSearch" placeholder="Search team names..." class="p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full text-sm">
                                            <select id="ba-statusFilter" class="p-3 rounded-lg bg-slate-700 border border-slate-600 text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 w-full text-sm">
                                                <option value="">All Statuses</option>
                                                <option value="Won">Won</option>
                                                <option value="Lost">Lost</option>
                                                <option value="Awaiting Results">Awaiting Results</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="overflow-x-auto scrollable-table">
                                        <table id="ba-matchTable" class="min-w-full divide-y divide-slate-700">
                                            <thead class="bg-slate-700/50 sticky top-0">
                                                <tr>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer sort-header" data-sort-key="Date">Date</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="HomeTeam">Home Team</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="HomeFormRate">H. Form %</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="AwayTeam">Away Team</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="AwayFormRate">A. Form %</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="OddsH">Home Odds</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="OddsD">Draw Odds</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="OddsA">Away Odds</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider cursor-pointer sort-header" data-sort-key="Confidence">Conf. %</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="AnalyzedPrediction">Analyzed Pred.</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="MatchResult">Match Result</th>
                                                    <th class="px-6 py-3 text-xs font-medium text-slate-400 uppercase tracking-wider sort-header" data-sort-key="PredictionStatus">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ba-matchTableBody" class="divide-y divide-slate-700"></tbody>
                                        </table>
                                    </div>
                                    <div id="ba-tablePagination" class="flex justify-between items-center mt-4"></div>
                                </div>
                                
                                <!-- Tab Content: Analytics -->
                                <div id="ba-analyticsContent" class="mt-4 hidden">
                                    <h2 class="text-2xl font-semibold text-slate-200 mb-4">Analytics</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <div class="bg-slate-800 rounded-xl shadow-lg p-4 border border-slate-700">
                                            <h3 class="text-lg font-medium text-slate-300 text-center">Prediction Accuracy</h3>
                                            <div class="w-full h-48 flex justify-center items-center"><canvas id="ba-accuracyPieChart"></canvas></div>
                                        </div>
                                        <div class="bg-slate-800 rounded-xl shadow-lg p-4 border border-slate-700">
                                            <h3 class="text-lg font-medium text-slate-300 text-center">Confidence Ranges</h3>
                                            <div class="w-full h-48 flex justify-center items-center"><canvas id="ba-confidenceBarChart"></canvas></div>
                                        </div>
                                        <div class="bg-slate-800 rounded-xl shadow-lg p-4 col-span-1 md:col-span-2 border border-slate-700">
                                            <h3 class="text-lg font-medium text-slate-300 text-center">Accuracy Trend Over Time</h3>
                                            <div class="w-full h-48 flex justify-center items-center"><canvas id="ba-accuracyLineChart"></canvas></div>
                                        </div>
                                        <div class="bg-slate-800 rounded-xl shadow-lg p-4 col-span-1 md:col-span-2 lg:col-span-2 border border-slate-700">
                                            <h3 class="text-lg font-medium text-slate-300 text-center">Prediction Analysis</h3>
                                            <div class="w-full h-48 flex justify-center items-center"><canvas id="ba-analyzedPredictionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Match Details Modal -->
                        <div id="ba-matchModal" class="custom-modal">
                            <div class="modal-content p-8 w-11/12 md:w-3/4 lg:w-2/3 bg-slate-800 border border-slate-700 text-slate-300">
                                <div class="flex justify-between items-start mb-4">
                                    <h2 id="ba-modalTitle" class="text-2xl font-bold text-slate-200">Match Details</h2>
                                    <button id="ba-closeModal" class="text-slate-400 hover:text-slate-200 transition-colors duration-200 text-3xl font-light leading-none">&times;</button>
                                </div>
                                <div id="ba-modalContent" class="space-y-6"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Analytics Content -->
                    <div id="content-analytics" class="page-content hidden">
                         <!-- Analytics Filters -->
                        <div class="bg-slate-800/70 backdrop-blur-lg rounded-xl shadow-md mb-8 p-6 border border-slate-700">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">Analytics Filters</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div>
                                    <label for="analyticsDateFilter" class="block text-sm font-medium text-slate-300 mb-2">Filter by Date</label>
                                    <select id="analyticsDateFilter" class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Dates</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="analyticsTotalGoalsFilter" class="block text-sm font-medium text-slate-300 mb-2">Filter by Total Goals</label>
                                    <select id="analyticsTotalGoalsFilter" class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-2.5 transition">
                                        <option value="All">All Totals</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Key Insights Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                            <!-- Overall Success Rate -->
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md flex items-center border border-slate-700">
                                <div class="relative w-24 h-24">
                                    <svg class="w-full h-full" viewBox="0 0 36 36">
                                        <path class="text-slate-700" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                                        <path id="progress-ring-circle" class="progress-ring__circle text-cyan-500" stroke-width="3" stroke-linecap="round" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span id="overall-success-rate-text" class="text-2xl font-bold text-cyan-400">-%</span>
                                    </div>
                                </div>
                                <div class="ml-5">
                                    <h4 class="text-slate-400 text-sm font-medium">Overall Success</h4>
                                    <p class="text-slate-200 text-lg font-semibold">Accuracy Rate</p>
                                </div>
                            </div>
                             <!-- Best Performing Bet -->
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md flex items-center border border-slate-700">
                                <div class="flex-shrink-0 bg-teal-500/10 text-teal-400 rounded-full h-16 w-16 flex items-center justify-center">
                                    <i data-lucide="trending-up" class="w-8 h-8"></i>
                                </div>
                                <div class="ml-5">
                                    <h4 class="text-slate-400 text-sm font-medium">Best Performing Bet</h4>
                                    <p id="best-bet-type" class="text-slate-200 text-lg font-bold truncate">-</p>
                                </div>
                            </div>
                             <!-- Optimal Confidence -->
                            <div class="bg-slate-800 p-6 rounded-xl shadow-lg p-6 border border-slate-700">
                                <div class="flex-shrink-0 bg-violet-500/10 text-violet-400 rounded-full h-16 w-16 flex items-center justify-center">
                                    <i data-lucide="target" class="w-8 h-8"></i>
                                </div>
                                <div class="ml-5">
                                    <h4 class="text-slate-400 text-sm font-medium">Optimal Confidence</h4>
                                    <p id="optimal-confidence" class="text-slate-200 text-lg font-bold">-</p>
                                </div>
                            </div>
                             <!-- Total Bets -->
                             <div class="bg-slate-800 p-6 rounded-xl shadow-lg p-6 border border-slate-700">
                                <div class="flex-shrink-0 bg-amber-500/10 text-amber-400 rounded-full h-16 w-16 flex items-center justify-center">
                                    <i data-lucide="hash" class="w-8 h-8"></i>
                                </div>
                                <div class="ml-5">
                                    <h4 class="text-slate-400 text-sm font-medium">Total Bets Analyzed</h4>
                                    <p id="total-bets-analyzed" class="text-slate-200 text-lg font-bold">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Grid -->
                        <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md xl:col-span-3 border border-slate-700"><canvas id="confidenceChart"></canvas></div>
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md xl:col-span-2 border border-slate-700"><canvas id="predictionAccuracyChart"></canvas></div>
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md xl:col-span-5 border border-slate-700"><canvas id="successOverTimeChart"></canvas></div>
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md xl:col-span-3 border border-slate-700"><canvas id="analyzedPredictionChart"></canvas></div>
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md xl:col-span-2 border border-slate-700"><canvas id="winningMarginChart"></canvas></div>
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md xl:col-span-3 border border-slate-700"><canvas id="goalsTipChart"></canvas></div>
                            <div class="bg-slate-800 p-6 rounded-xl shadow-md xl:col-span-2 border border-slate-700"><canvas id="preferenceChart"></canvas></div>
                        </div>
                    </div>
                     <!-- Admin Content -->
                    <div id="content-admin" class="page-content hidden">
                        <div class="bg-slate-800/70 backdrop-blur-lg rounded-xl shadow-md p-6 border border-slate-700">
                            <h3 class="text-xl font-bold text-cyan-400 mb-2">Table Column Management</h3>
                            <p class="text-sm text-slate-400 mb-6">Drag and drop to reorder columns. Check or uncheck to show or hide them.</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- All Match Data Table Management -->
                                <div>
                                    <h4 class="font-bold text-slate-200 mb-4">Dashboard: All Match Data Table</h4>
                                    <div id="main-table-admin-container" class="space-y-2 p-4 bg-slate-900 rounded-lg border border-slate-700">
                                        <!-- Columns will be injected here by JS -->
                                    </div>
                                </div>
                                <!-- High Confidence Table Management -->
                                <div>
                                    <h4 class="font-bold text-slate-200 mb-4">High-Confidence Table</h4>
                                    <div id="high-confidence-table-admin-container" class="space-y-2 p-4 bg-slate-900 rounded-lg border border-slate-700">
                                        <!-- Columns will be injected here by JS -->
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end gap-4">
                                <button id="reset-columns-btn" class="bg-slate-600 hover:bg-slate-500 text-slate-200 font-bold py-2.5 px-6 rounded-lg transition">Reset to Default</button>
                                <button id="save-columns-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-6 rounded-lg transition shadow-sm hover:shadow-md">Save Changes</button>
                            </div>
                            <p id="admin-message" class="text-sm text-right mt-4 text-emerald-500"></p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="fixed inset-0 z-50 hidden">
        <div id="modal-overlay" class="absolute inset-0 bg-black bg-opacity-60 modal-overlay opacity-0"></div>
        <div class="relative bg-slate-800 w-full max-w-xl mx-auto mt-20 rounded-lg shadow-xl p-6 modal-content scale-95 opacity-0 transform -translate-y-10 border border-slate-700">
            <div class="flex items-start justify-between pb-4 border-b border-slate-700">
                <h2 class="text-xl font-bold text-slate-200" id="modal-title"></h2>
                <button id="modal-close-btn" class="text-2xl text-slate-500 hover:text-slate-300 font-light">&times;</button>
            </div>
            <div id="modal-body" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 text-sm max-h-[70vh] overflow-y-auto"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrXyGqj1DKdAk4GHfjNnkh7s9Jmti4ccb-K6EwJUAfzs8vJ0CUSj8KVi6_jZmrwCaJ1ODMY5bDJRK/pub?gid=337419731&single=true&output=csv';
        const SIGNUP_URL = 'https://script.google.com/macros/s/AKfycbw1aMNk8N1ksb95v8sHTjYc3auRy-6f7AE85kXvd8Z-P9_kUMW90fINKVHo68CYc3EI/exec';
        const ROWS_PER_PAGE = 20;
        
        // --- DEFAULT TABLE HEADERS CONFIGURATION ---
        // MODIFIED: Replaced 'Match Outcome' and 'Accuracy'
        const DEFAULT_MAIN_TABLE_HEADERS = ['Details', 'Date', 'Home Team', 'Away Team', 'Analyzed Prediction', 'Home Odds', 'Draw Odds', 'Away Odds', 'Level of Confidence', 'Prediction Status', 'Match Result'];
        let ALL_POSSIBLE_COLUMNS = [];


        // --- GLOBAL STATE ---
        let allData = [], originalHeaders = [];
        let dashboardFilteredData = [];
        let sortState = { column: null, direction: 'asc' };
        let currentPage = 1;
        let COLUMN_INDICES = {};
        let charts = {}; // To hold chart instances
        let mainTableHeaders = [];
        let allEventsInitialized = false;
        let bestAnalysisInitialized = false;

        const initialFilterState = () => ({
            searchTerm: '',
            date: 'All',
            preference: 'All',
            winningMargin: 'All',
            analyzedPrediction: 'All',
            goalsTip: 'All',
            totalGoals: 'All',
            minConfidence: 70
        });

        let dashboardFilters = initialFilterState();


        // --- EVENT HANDLERS (DEFINED EARLY) ---
        
        async function handleSyncClick() {
            dom.syncDataBtn.disabled = true;
            dom.syncIcon.classList.add('animate-spin');
            dom.syncText.textContent = 'Syncing...';
            dom.tableBody.innerHTML = `<tr><td colspan="${mainTableHeaders.length}" class="p-8 text-center text-slate-400"><div class="loader mx-auto"></div><p class="mt-4">Syncing data...</p></td></tr>`;
            try {
                await fetchAndProcessData();
                if (allEventsInitialized) {
                    initializeAppEvents();
                }
                 if (bestAnalysisInitialized) {
                    initializeBestAnalysis();
                }
            } catch (e) {
                // Error handled in fetch function
            } finally {
                dom.syncDataBtn.disabled = false;
                dom.syncIcon.classList.remove('animate-spin');
                dom.syncText.textContent = 'Sync Data';
            }
        }

        function handleDashboardSort(e) {
            const target = e.target.closest('th');
            if (!target || !target.dataset.originalIndex) return;
            const originalColumnIndex = parseInt(target.dataset.originalIndex);
            
            if (sortState.column === originalColumnIndex) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = originalColumnIndex;
                sortState.direction = 'asc';
            }
            renderMainTableHeaders();
            applyDashboardFilters();
        }

        function handleDashboardFilterChange(e) {
            const input = e.target;
            let value = input.value;
            let key;

            if (input.id.includes('search')) {
                key = 'searchTerm';
            } else if (input.type === 'range') {
                key = 'minConfidence';
                value = parseInt(value, 10);
                dom.confidenceRangeValue.textContent = `${value}%`;
            } else {
                key = input.dataset.filterKey;
            }

            dashboardFilters[key] = value;
            applyDashboardFilters();
        }
        

        function resetDashboardFilters() {
             dashboardFilters = initialFilterState();
             sortState = { column: null, direction: 'asc' };
             document.querySelectorAll('#dashboard-filters .filter-input').forEach(input => {
                if (input.id.includes('search')) input.value = '';
                else if (input.type === 'range') input.value = 70;
                else input.selectedIndex = 0;
            });
            dom.confidenceRangeValue.textContent = '70%';
            renderMainTableHeaders();
            applyDashboardFilters();
        }
        
        
        function handleMainTableRowClick(e) {
            const rowElement = e.target.closest('tr');
             if (e.target.closest('.view-more-btn')) {
                const rowIndex = parseInt(rowElement.dataset.rowIndex, 10);
                const rowData = dashboardFilteredData[rowIndex];
                if (rowData) openModal(rowData);
            }
        }
        
        function handleSidebarClick(e) {
            const link = e.target.closest('.sidebar-link');
            if (!link) return;
            
            e.preventDefault(); 

            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            const targetId = link.dataset.target;
            document.querySelectorAll('.page-content').forEach(pane => {
                 pane.classList.toggle('hidden', pane.id !== targetId);
            });
            
            dom.mainHeaderTitle.textContent = link.textContent.trim();
            
            if (targetId === 'content-all-events' && !allEventsInitialized) {
                initializeAppEvents();
            }
            if (targetId === 'content-best-analysis' && !bestAnalysisInitialized) {
                initializeBestAnalysis();
            }
            if (targetId === 'content-analytics') updateAnalytics();
            if (targetId === 'content-admin') renderAdminUI();
        }

        async function handleFetchOutcomeClick(e) {
            const button = e.currentTarget;
            const { homeTeam, awayTeam, date } = button.dataset;
            const scoreElement = document.getElementById('modal-final-score');

            button.disabled = true;
            button.innerHTML = `<div class="loader !w-4 !h-4 !border-2 !border-t-white/50 mx-auto"></div>`;

            try {
                const result = await fetchMatchOutcome(homeTeam, awayTeam, date);
                scoreElement.textContent = result.text.trim();
                button.style.display = 'none'; // Hide button after success
            } catch (error) {
                console.error("Fetch outcome failed:", error);
                scoreElement.textContent = "Could not fetch score.";
                button.innerHTML = `Retry`;
                button.disabled = false;
            }
        }


        // --- DOM REFERENCES ---
        const dom = {
            // Auth
            authContainer: document.getElementById('auth-container'),
            loginView: document.getElementById('login-view'),
            signupView: document.getElementById('signup-view'),
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            showSignup: document.getElementById('show-signup'),
            showLogin: document.getElementById('show-login'),
            loginError: document.getElementById('login-error'),
            signupMessage: document.getElementById('signup-message'),
            logoutBtn: document.getElementById('logout-btn'),
            userEmailDisplay: document.getElementById('user-email-display'),
            
            // Dashboard & Navigation
            dashboardContainer: document.getElementById('dashboard-container'),
            sidebarNav: document.getElementById('sidebar-nav'),
            mainHeaderTitle: document.getElementById('main-header-title'),
            tableBody: document.getElementById('dataTableBody'),
            tableHeader: document.querySelector('#table-container thead tr'),
            noResultsDiv: document.getElementById('no-results'),
            
            // Filters
            dashboardFilterInputs: document.querySelectorAll('.filter-input'),
            confidenceRangeValue: document.getElementById('confidenceRangeValue'),
            resetFiltersBtn: document.getElementById('resetFiltersBtn'),

            // Analytics
            analyticsDateFilter: document.getElementById('analyticsDateFilter'),
            analyticsTotalGoalsFilter: document.getElementById('analyticsTotalGoalsFilter'),
            overallSuccessRateText: document.getElementById('overall-success-rate-text'),
            progressRingCircle: document.getElementById('progress-ring-circle'),
            bestBetType: document.getElementById('best-bet-type'),
            optimalConfidence: document.getElementById('optimal-confidence'),
            totalBetsAnalyzed: document.getElementById('total-bets-analyzed'),

            // Pagination
            paginationControls: document.getElementById('pagination-controls'),
            prevPageBtn: document.getElementById('prev-page'),
            nextPageBtn: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            
            // Modal
            modal: document.getElementById('details-modal'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),

            // Admin
            adminMessage: document.getElementById('admin-message'),
            saveColumnsBtn: document.getElementById('save-columns-btn'),
            resetColumnsBtn: document.getElementById('reset-columns-btn'),
            mainTableAdminContainer: document.getElementById('main-table-admin-container'),
            highConfidenceTableAdminContainer: document.getElementById('high-confidence-table-admin-container'),

            // General
            syncDataBtn: document.getElementById('syncDataBtn'),
            syncIcon: document.getElementById('syncIcon'),
            syncText: document.getElementById('syncText'),
        };

        // --- AUTHENTICATION LOGIC ---
        
        function switchView(view) {
            if (view === 'signup') {
                dom.loginView.classList.add('hidden');
                dom.signupView.classList.remove('hidden');
            } else {
                dom.signupView.classList.add('hidden');
                dom.loginView.classList.remove('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const loginBtn = dom.loginForm.querySelector('button[type="submit"]');
            const originalBtnText = 'Sign in';
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<div class="loader !w-5 !h-5 !border-2 !border-t-white/50 mx-auto"></div>`;
            dom.loginError.textContent = '';
            
            try {
                const email = dom.loginForm.email.value.trim().toLowerCase();
                const password = dom.loginForm.password.value;

                const response = await fetch(SIGNUP_URL);
                if (!response.ok) throw new Error('Network response was not ok.');
                const result = await response.json();
                
                if (!result || !Array.isArray(result.users)) {
                    console.error("Invalid data structure received from login API:", result);
                    throw new Error("Could not retrieve valid user data from the server.");
                }
                const users = result.users;

                const user = users.find(u => u.Email.trim().toLowerCase() === email && String(u.Password).trim() === password);

                if (user) {
                    if (String(user.Status).trim().toLowerCase() === 'active') {
                        localStorage.setItem('loggedInUser', JSON.stringify({ email: user.Email }));
                        showDashboard();
                    } else {
                        dom.loginError.textContent = 'Your account is inactive. Please contact admin.';
                    }
                } else {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    dom.loginError.textContent = 'Invalid email or password.';
                }
            } catch (error) {
                console.error('Login error:', error);
                dom.loginError.textContent = 'An error occurred during login. Please try again.';
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = originalBtnText;
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const form = e.target;
            dom.signupMessage.textContent = 'Submitting...';
            dom.signupMessage.className = 'text-sm text-center text-slate-400';

            try {
                const formData = new FormData(form);
                
                const response = await fetch(SIGNUP_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok || response.status === 200 || response.type === 'opaque') {
                    dom.signupMessage.textContent = 'Signup successful! You can now log in.';
                    dom.signupMessage.className = 'text-sm text-center text-emerald-500';
                    form.reset();
                    setTimeout(() => switchView('login'), 2000);
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || `Server responded with an error (status: ${response.status})`);
                }
            } catch (error) {
                console.error('Signup error:', error);
                dom.signupMessage.textContent = `Signup failed. Please try again later.`;
                dom.signupMessage.className = 'text-sm text-center text-rose-500';
            }
        }


        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            showAuth();
        }
        
        function showDashboard() {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            if (!user) {
                showAuth();
                return;
            }
            dom.userEmailDisplay.textContent = user.email;
            dom.authContainer.classList.add('hidden');
            dom.dashboardContainer.classList.remove('hidden');
            handleSyncClick();
        }

        function showAuth() {
            dom.dashboardContainer.classList.add('hidden');
            dom.authContainer.classList.remove('hidden');
            switchView('login');
        }

        // --- CORE DASHBOARD FUNCTIONS ---
        
        async function fetchAndProcessData() {
            try {
                const response = await fetch(`${GOOGLE_SHEET_URL}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const csvText = await response.text();
                
                const parsed = parseCSV(csvText);
                
                originalHeaders = parsed.headers;
                ALL_POSSIBLE_COLUMNS = [...originalHeaders];
                COLUMN_INDICES = {};
                originalHeaders.forEach((header, index) => {
                    COLUMN_INDICES[header.trim()] = index;
                });
                
                allData = parsed.data;
                allData.sort((a, b) => new Date(b[COLUMN_INDICES['Date']]) - new Date(a[COLUMN_INDICES['Date']]));
                
                dashboardFilteredData = [...allData];

                loadColumnConfiguration();
                renderAdminUI();
                renderMainTableHeaders();
                populateDropdowns();
                
                applyDashboardFilters(); 

                updateAnalytics();

            } catch (error) {
                console.error('Failed to fetch/process data:', error);
                dom.tableBody.innerHTML = `<tr><td colspan="${mainTableHeaders.length}" class="p-8 text-center text-rose-500 font-semibold">Failed to load data. Please try syncing again.</td></tr>`;
                throw error;
            }
        }
        
        function parseCSV(text) {
            const rows = text.split(/\r?\n/).map(row => row.split(','));
            const headerRow = rows.shift() || [];
            const cleanedHeaders = headerRow.map(h => h.trim());
            const data = rows.filter(row => row.length === cleanedHeaders.length && row.some(cell => cell.trim() !== ''));
            return { headers: cleanedHeaders, data };
        }
        
        function populateDropdowns() {
             const filtersToPopulate = [
                { id: 'dateFilter', column: 'Date' },
                { id: 'preferenceFilter', column: 'Preference' },
                { id: 'winningMarginFilter', column: 'Winning Margin' },
                { id: 'analyzedPredictionFilter', column: 'Analyzed Prediction' },
                { id: 'goalsTipFilter', column: 'Goals Tip' },
                { id: 'totalGoalsFilter', column: 'Total Goals' },
                { id: 'analyticsDateFilter', column: 'Date' },
                { id: 'analyticsTotalGoalsFilter', column: 'Total Goals' },
            ];

            filtersToPopulate.forEach(config => {
                const selectElement = document.getElementById(config.id);
                if (!selectElement) return;

                const columnIndex = COLUMN_INDICES[config.column];
                if (typeof columnIndex === 'undefined') return;

                const firstOption = selectElement.options[0];
                selectElement.innerHTML = '';
                selectElement.add(firstOption);

                const uniqueValues = [...new Set(allData.map(row => row[columnIndex]).filter(Boolean))];
                
                if (config.column === 'Date') {
                    uniqueValues.sort((a, b) => new Date(b) - new Date(a));
                } else {
                    uniqueValues.sort();
                }

                uniqueValues.forEach(val => selectElement.add(new Option(val, val)));
            });
        }

        // --- FILTERING LOGIC ---

        function applyDashboardFilters() {
            let filtered = allData.filter(row => {
                const confidenceText = row[COLUMN_INDICES['Level of Confidence']] || '0%';
                const confidenceValue = parseInt(confidenceText.replace('%', ''), 10);
                const homeTeam = (row[COLUMN_INDICES['Home Team']] || '').toLowerCase();
                const awayTeam = (row[COLUMN_INDICES['Away Team']] || '').toLowerCase();
                const searchTerm = (dashboardFilters.searchTerm || '').toLowerCase();
                const searchMatch = searchTerm === '' || homeTeam.includes(searchTerm) || awayTeam.includes(searchTerm);

                return (dashboardFilters.date === 'All' || row[COLUMN_INDICES['Date']] === dashboardFilters.date) &&
                       (dashboardFilters.preference === 'All' || row[COLUMN_INDICES['Preference']] === dashboardFilters.preference) &&
                       (dashboardFilters.winningMargin === 'All' || row[COLUMN_INDICES['Winning Margin']] === dashboardFilters.winningMargin) &&
                       (dashboardFilters.analyzedPrediction === 'All' || row[COLUMN_INDICES['Analyzed Prediction']] === dashboardFilters.analyzedPrediction) &&
                       (dashboardFilters.goalsTip === 'All' || row[COLUMN_INDICES['Goals Tip']] === dashboardFilters.goalsTip) &&
                       (dashboardFilters.totalGoals === 'All' || row[COLUMN_INDICES['Total Goals']] === dashboardFilters.totalGoals) &&
                       (confidenceValue >= dashboardFilters.minConfidence) &&
                       searchMatch;
            });
            
            if (sortState.column !== null) {
                filtered.sort((a, b) => {
                    let valA = a[sortState.column], valB = b[sortState.column];
                    if (!isNaN(valA) && !isNaN(valB) && String(valA).trim() !== '' && String(valB).trim() !== '') return sortState.direction === 'asc' ? valA - valB : valB - valA;
                    return sortState.direction === 'asc' ? (valA || '').localeCompare(valB || '') : (valB || '').localeCompare(valA || '');
                });
            }

            dashboardFilteredData = filtered;
            currentPage = 1;
            updateDashboardCards(dashboardFilteredData);
            renderMainTablePage();
        }

        // --- CARD & TABLE RENDERING ---

        function updateCardCounts(totalElId, containerElId, data, predictionColumnName) {
            document.getElementById(totalElId).textContent = data.length;

            const predictionCounts = {};
            const predictionIndex = COLUMN_INDICES[predictionColumnName];
            if (predictionIndex === undefined) return;
            
            data.forEach(row => {
                const prediction = row[predictionIndex] || 'N/A';
                predictionCounts[prediction] = (predictionCounts[prediction] || 0) + 1;
            });

            const container = document.getElementById(containerElId);
            container.innerHTML = ''; 

            const colorMap = {
                'Home Best Tip': 'border-emerald-500', 'Best Away Tip': 'border-sky-500',
                'Home Good Tip': 'border-emerald-400', 'Good Away Tip': 'border-sky-400',
                'Home Tip': 'border-lime-500', 'Over 2.5 Tip': 'border-amber-500',
                'Draw Tip': 'border-yellow-500'
            };
            const defaultColor = 'border-slate-500';

            const sortedPredictions = Object.entries(predictionCounts).sort((a,b) => b[1] - a[1]);

            for (const [prediction, count] of sortedPredictions) {
                const color = colorMap[prediction] || defaultColor;
                const cardHTML = `
                    <div class="bg-slate-800 p-4 rounded-xl shadow-md border-t-4 ${color} flex flex-col justify-center">
                        <p class="text-slate-400 text-xs font-medium truncate">${prediction}</p>
                        <p class="text-slate-200 text-xl font-bold">${count}</p>
                    </div>`;
                container.innerHTML += cardHTML;
            }
        }

        const updateDashboardCards = (data) => updateCardCounts('dashboard-total-events', 'dashboard-prediction-counts', data, 'Analyzed Prediction');

        function renderMainTableHeaders() {
            dom.tableHeader.innerHTML = mainTableHeaders.map(header => {
                const isSortable = !['Details'].includes(header);
                let classes = 'px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider';
                const originalIndex = COLUMN_INDICES[header];

                if (header === 'Details') return `<th scope="col" class="${classes}"></th>`;
                
                if (isSortable && originalIndex !== undefined) {
                    if (sortState.column === originalIndex) classes += sortState.direction === 'asc' ? ' sort-asc' : ' sort-desc';
                    return `<th scope="col" data-original-index="${originalIndex}" class="${classes}">${header}</th>`;
                }
                return `<th scope="col" class="${classes}">${header}</th>`;
            }).join('');
        }
        
        function renderMainTablePage() {
            const totalPages = Math.max(1, Math.ceil(dashboardFilteredData.length / ROWS_PER_PAGE));
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            const start = (currentPage - 1) * ROWS_PER_PAGE;
            const pageData = dashboardFilteredData.slice(start, start + ROWS_PER_PAGE);
            
            dom.tableBody.innerHTML = '';
            dom.noResultsDiv.classList.toggle('hidden', pageData.length > 0 || allData.length === 0);
            dom.paginationControls.style.display = pageData.length > 0 ? 'flex' : 'none';

            if (pageData.length === 0 && allData.length > 0) return;
            if(allData.length === 0) return;

            pageData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-700 transition-colors';
                tr.dataset.rowIndex = allData.indexOf(row);
                
                let cellsHTML = '';
                mainTableHeaders.forEach(headerName => {
                    const colIndex = COLUMN_INDICES[headerName];
                    const cellValue = colIndex !== undefined ? row[colIndex] : '';
                    let cellClass = 'px-6 py-4 whitespace-nowrap text-sm text-slate-300 align-middle';
                    let cellContent = cellValue || '-';

                    switch(headerName) {
                        case 'Home Team': case 'Away Team':
                            cellClass += ' font-semibold text-cyan-400';
                            break;
                        case 'Level of Confidence':
                            const numericConf = parseFloat(cellValue.replace('%','').trim());
                            let confColor = 'text-slate-200';
                            if (!isNaN(numericConf)) {
                                if (numericConf >= 80) confColor = 'text-emerald-400';
                                else if (numericConf >= 70) confColor = 'text-amber-400';
                                else confColor = 'text-rose-400';
                            }
                            cellContent = `<span class="font-bold ${confColor}">${cellValue}</span>`;
                            break;
                        case 'Analyzed Prediction':
                            cellContent = getStyledPredictionBadge(cellValue);
                            break;
                        // MODIFIED: Replaced 'Accuracy' case with 'Prediction Status'
                        case 'Prediction Status':
                            let statusClass = 'bg-slate-700 text-slate-300';
                            const lowerCellValue = (cellValue || '').toLowerCase();
                            if (lowerCellValue === 'won' || lowerCellValue === 'success') {
                                statusClass = 'bg-emerald-500/10 text-emerald-400';
                            } else if (lowerCellValue === 'lost' || lowerCellValue === 'unsuccessful') {
                                statusClass = 'bg-rose-500/10 text-rose-400';
                            }
                            cellContent = `<span class="${statusClass} text-xs font-medium px-2.5 py-0.5 rounded-full">${cellValue || 'N/A'}</span>`;
                            break;
                        case 'Details':
                            cellContent = `<button class="view-more-btn bg-cyan-600 text-white px-3 py-1 text-xs rounded-full hover:bg-cyan-700 transition shadow">View</button>`;
                            break;
                    }
                    cellsHTML += `<td class="${cellClass}">${cellContent}</td>`;
                });
                
                tr.innerHTML = cellsHTML;
                dom.tableBody.appendChild(tr);
            });
            updatePaginationControls(totalPages);
        }

        function getStyledPredictionBadge(prediction) {
            let bgColor = 'bg-slate-700';
            let textColor = 'text-slate-300';
            switch(prediction) {
                case 'Home Best Tip':
                case 'Home Good Tip':
                    bgColor = 'bg-emerald-500/10'; textColor = 'text-emerald-400'; break;
                case 'Home Tip':
                    bgColor = 'bg-lime-500/10'; textColor = 'text-lime-400'; break;
                case 'Best Away Tip':
                case 'Good Away Tip':
                    bgColor = 'bg-sky-500/10'; textColor = 'text-sky-400'; break;
                case 'Over 1.5 Tip': case 'Over 2.5 Tip':
                    bgColor = 'bg-amber-500/10'; textColor = 'text-amber-400'; break;
            }
            return `<span class="${bgColor} ${textColor} text-xs font-medium px-2.5 py-1 rounded-full">${prediction || 'N/A'}</span>`;
        }
        
        
        // --- ANALYTICS & CHARTING FUNCTIONS ---

        function updateAnalytics() {
            if (allData.length === 0) return;

             const dateFilter = dom.analyticsDateFilter.value;
            const totalGoalsFilter = dom.analyticsTotalGoalsFilter.value;

            const filteredChartData = allData.filter(row => {
                const dateMatch = dateFilter === 'All' || row[COLUMN_INDICES['Date']] === dateFilter;
                const goalsMatch = totalGoalsFilter === 'All' || row[COLUMN_INDICES['Total Goals']] === totalGoalsFilter;
                return dateMatch && goalsMatch;
            });
            renderKeyInsights(filteredChartData);
            renderAnalyticsCharts(filteredChartData);
        }
        
        function renderKeyInsights(data) {
            const accuracyIndex = COLUMN_INDICES['Accuracy'];
            if(accuracyIndex === undefined) return;

            let totalSuccess = 0;
            data.forEach(row => {
                if (String(row[accuracyIndex]).trim().toLowerCase() === 'success') {
                    totalSuccess++;
                }
            });

            // Overall Success Rate
            const overallSuccessRate = data.length > 0 ? (totalSuccess / data.length) * 100 : 0;
            dom.overallSuccessRateText.textContent = `${overallSuccessRate.toFixed(1)}%`;
            const circle = dom.progressRingCircle;
            const radius = 15.9155;
            const circumference = radius * 2 * Math.PI;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - (overallSuccessRate / 100) * circumference;
            circle.style.strokeDashoffset = offset;

            // Best Bet & Optimal Confidence
            const betStats = processChartData(data, 'Analyzed Prediction');
            const confidenceStats = processChartData(data, 'Level of Confidence');

            const bestBet = betStats.labels.reduce((best, label, index) => {
                if (betStats.values[index] > best.value) {
                    return { label, value: betStats.values[index] };
                }
                return best;
            }, { label: '-', value: 0 });

            const bestConfidence = confidenceStats.labels.reduce((best, label, index) => {
                if (confidenceStats.values[index] > best.value) {
                    return { label, value: confidenceStats.values[index] };
                }
                return best;
            }, { label: '-', value: 0 });

            dom.bestBetType.textContent = bestBet.label;
            dom.optimalConfidence.textContent = bestConfidence.label;
            dom.totalBetsAnalyzed.textContent = data.length;
        }


        function processChartData(data, columnName) {
            const accuracyIndex = COLUMN_INDICES['Accuracy'];
            const colIndex = COLUMN_INDICES[columnName];
            if (accuracyIndex === undefined || colIndex === undefined) return { labels: [], values: [] };

            const stats = {};

            data.forEach(row => {
                let category = row[colIndex];
                if (!category) return;

                if (columnName === 'Level of Confidence') {
                    const value = parseInt(category.replace('%', ''));
                    if (isNaN(value)) return;
                    if (value >= 90) category = '90-100%';
                    else if (value >= 80) category = '80-89%';
                    else if (value >= 70) category = '70-79%';
                    else if (value >= 60) category = '60-69%';
                    else if (value >= 50) category = '50-59%';
                    else category = '0-49%';
                }

                if (!stats[category]) {
                    stats[category] = { total: 0, success: 0 };
                }
                stats[category].total++;
                if (String(row[accuracyIndex]).trim().toLowerCase() === 'success') {
                    stats[category].success++;
                }
            });
            
            const sortedLabels = Object.keys(stats).sort();

            const labels = [];
            const values = [];

            sortedLabels.forEach(label => {
                const { total, success } = stats[label];
                labels.push(label);
                values.push(total > 0 ? (success / total) * 100 : 0);
            });

            return { labels, values };
        }

        function renderAnalyticsCharts(filteredChartData) {
            
            const CHART_PALETTE = ['#0891b2', '#0d9488', '#6d28d9', '#f59e0b', '#ec4899', '#3b82f6', '#8b5cf6'];
             // Chart.js dark mode defaults
            Chart.defaults.color = '#94a3b8'; // slate-400
            Chart.defaults.borderColor = '#334155'; // slate-700
            
            const chartConfigs = {
                'preferenceChart': { type: 'bar', columnName: 'Preference', title: 'Success Rate by Preference' },
                'winningMarginChart': { type: 'bar', columnName: 'Winning Margin', title: 'Success Rate by Winning Margin' },
                'analyzedPredictionChart': { type: 'bar', columnName: 'Analyzed Prediction', title: 'Success Rate by Prediction Type' },
                'goalsTipChart': { type: 'bar', columnName: 'Goals Tip', title: 'Success Rate by Goals Tip' },
                'confidenceChart': { type: 'bar', columnName: 'Level of Confidence', title: 'Success Rate by Confidence Level' },
            };
            
            Object.entries(chartConfigs).forEach(([canvasId, config]) => {
                const { labels, values } = processChartData(filteredChartData, config.columnName);
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                if (charts[canvasId]) charts[canvasId].destroy();

                charts[canvasId] = new Chart(ctx, {
                    type: config.type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Success Rate',
                            data: values,
                            backgroundColor: CHART_PALETTE,
                            borderColor: CHART_PALETTE,
                            borderWidth: 1,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: { display: true, text: config.title, font: { size: 16, weight: 'bold' }, color: '#e2e8f0', padding: { bottom: 20 } },
                            legend: { display: false },
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Success Rate: ${context.parsed.y.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                max: 100, 
                                ticks: { callback: value => value + '%' },
                                grid: { color: '#334155' } 
                            },
                            x: {
                                grid: { color: '#334155' }
                            }
                        }
                    }
                });
            });

            // Special chart: Prediction Accuracy (Doughnut)
            const accuracyIndex = COLUMN_INDICES['Accuracy'];
            let successCount = 0, unsuccessCount = 0;
            if(accuracyIndex !== undefined) {
                filteredChartData.forEach(row => {
                    const accuracy = String(row[accuracyIndex]).trim().toLowerCase();
                    if (accuracy === 'success') successCount++;
                    else if (accuracy === 'unsuccessful') unsuccessCount++;
                });
            }
            if (charts['predictionAccuracyChart']) charts['predictionAccuracyChart'].destroy();
            charts['predictionAccuracyChart'] = new Chart(document.getElementById('predictionAccuracyChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Unsuccessful'],
                    datasets: [{ data: [successCount, unsuccessCount], backgroundColor: ['#10b981', '#f43f5e'], borderColor: '#1e293b', borderWidth: 4 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    plugins: { 
                        title: { display: true, text: 'Prediction Accuracy Overview', font: { size: 16, weight: 'bold' }, color: '#e2e8f0', padding: { bottom: 20 } },
                        legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                    }
                }
            });

            const timeData = {};
            const dateIndex = COLUMN_INDICES['Date'];
            if(dateIndex !== undefined && accuracyIndex !== undefined) {
                filteredChartData.forEach(row => {
                    const date = row[dateIndex];
                    if(!date) return;
                    if(!timeData[date]) timeData[date] = { total: 0, success: 0 };
                    timeData[date].total++;
                    if(String(row[accuracyIndex]).trim().toLowerCase() === 'success') timeData[date].success++;
                });
            }
            const sortedDates = Object.keys(timeData).sort((a,b) => new Date(a) - new Date(b));
            const timeLabels = sortedDates;
            const timeValues = sortedDates.map(date => (timeData[date].success / timeData[date].total) * 100);

            if (charts['successOverTimeChart']) charts['successOverTimeChart'].destroy();
            charts['successOverTimeChart'] = new Chart(document.getElementById('successOverTimeChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Success Rate',
                        data: timeValues,
                        borderColor: '#0891b2',
                        backgroundColor: 'rgba(8, 145, 178, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#0891b2',
                        pointRadius: 4
                    }]
                },
                 options: {
                    responsive: true, maintainAspectRatio: true,
                    plugins: { 
                        title: { display: true, text: 'Success Rate Over Time', font: { size: 16, weight: 'bold' }, color: '#e2e8f0', padding: { bottom: 20 } },
                        legend: { display: false },
                        tooltip: { callbacks: { label: context => `Success Rate: ${context.parsed.y.toFixed(1)}%` } }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100, 
                            ticks: { callback: value => value + '%' },
                            grid: { color: '#334155' }
                        },
                        x: {
                           grid: { color: '#334155' }
                        }
                    }
                }
            });
             lucide.createIcons();
        }

        // --- TEAM FORM INSIGHT FEATURE ---
        function getTeamForm(teamName, matchDateStr) {
            const matchDate = new Date(matchDateStr);
            // Data is already sorted by date descending
            const teamMatches = allData.filter(pastMatch => {
                const pastMatchDate = new Date(pastMatch[COLUMN_INDICES['Date']]);
                const isParticipant = pastMatch[COLUMN_INDICES['Home Team']] === teamName || pastMatch[COLUMN_INDICES['Away Team']] === teamName;
                return isParticipant && pastMatchDate < matchDate;
            }).slice(0, 5);

            return teamMatches.map(match => {
                const outcome = match[COLUMN_INDICES['Match Outcome']];
                const wasHome = match[COLUMN_INDICES['Home Team']] === teamName;
                
                if (outcome === 'Home Win') return wasHome ? 'W' : 'L';
                if (outcome === 'Away Win') return wasHome ? 'L' : 'W';
                if (outcome === 'Draw') return 'D';
                return '-';
            });
        }


        // --- UI & MODAL FUNCTIONS ---

        function updatePaginationControls(totalPages) {
            dom.pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            dom.prevPageBtn.disabled = currentPage === 1;
            dom.nextPageBtn.disabled = currentPage === totalPages;
        }

        function openModal(row) {
            const homeTeam = row[COLUMN_INDICES['Home Team']] || 'N/A';
            const awayTeam = row[COLUMN_INDICES['Away Team']] || 'N/A';
            dom.modalTitle.textContent = `Match Details`; 

            const confidenceText = row[COLUMN_INDICES['Level of Confidence']] || '0%';
            const confidenceValue = parseInt(confidenceText.replace('%', ''), 10) || 0;
            const urlSource = row[COLUMN_INDICES['SourceURL']];
            const finalScore = row[COLUMN_INDICES['Final Score / Time']] || '-';
            const scoreIsMissing = finalScore === '-' || finalScore.includes(':');

            // Determine confidence bar color
            let confidenceBarColor = 'bg-rose-500';
            if (confidenceValue >= 70) confidenceBarColor = 'bg-amber-500';
            if (confidenceValue >= 80) confidenceBarColor = 'bg-emerald-500';
            
            const homeTeamForm = getTeamForm(homeTeam, row[COLUMN_INDICES['Date']]);
            const awayTeamForm = getTeamForm(awayTeam, row[COLUMN_INDICES['Date']]);
            const getFormHtml = (formArray) => {
                if (!formArray || formArray.length === 0) return '<span class="text-xs text-slate-400">No recent data</span>';
                return formArray.map(result => {
                    let bgColor = 'bg-slate-400'; // Draw
                    if (result === 'W') bgColor = 'bg-emerald-500';
                    if (result === 'L') bgColor = 'bg-rose-500';
                    return `<span class="w-6 h-6 flex items-center justify-center text-xs font-bold text-white ${bgColor} rounded-full">${result}</span>`;
                }).join('');
            };
            const formHTML = `
                <div class="md:col-span-3 mt-4 pt-4 border-t border-slate-700">
                    <h4 class="font-bold text-slate-300 mb-3 text-base">Recent Form (Last 5 Games)</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-semibold text-slate-200">${homeTeam}</span>
                            <div class="flex items-center gap-2">${getFormHtml(homeTeamForm)}</div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-semibold text-slate-200">${awayTeam}</span>
                            <div class="flex items-center gap-2">${getFormHtml(awayTeamForm)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            let modalBodyContent = ``;
             originalHeaders.forEach(header => {
                let cellValue = row[COLUMN_INDICES[header]];
                // Add the fetch button right after the Final Score
                if(header === 'Final Score / Time') {
                     modalBodyContent += `
                         <div>
                             <p class="font-semibold text-slate-400">${header}</p>
                             <div class="flex items-center">
                                 <p class="text-slate-200" id="modal-final-score">${cellValue || '-'}</p>
                                 ${scoreIsMissing ? `
                                 <button id="fetchOutcomeBtn"
                                     data-home-team="${homeTeam}"
                                     data-away-team="${awayTeam}"
                                     data-date="${row[COLUMN_INDICES['Date']]}"
                                     class="ml-2 bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold py-1 px-2 rounded-lg transition">
                                         Fetch
                                 </button>` : ''}
                             </div>
                         </div>`;
                } else if(header && cellValue) {
                    modalBodyContent += `<div>
                        <p class="font-semibold text-slate-400">${header}</p>
                        <p class="text-slate-200">${cellValue}</p>
                    </div>`;
                }
            });


            dom.modalBody.innerHTML = `
                <div class="md:col-span-3 grid grid-cols-2 gap-4">
                    ${modalBodyContent}
                </div>
                ${formHTML}
                <div class="md:col-span-3 mt-4 pt-4 border-t border-slate-700">
                    <div class="mt-3">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-300">Level of Confidence</span>
                            <span class="text-sm font-bold text-cyan-400">${confidenceText}</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2.5">
                            <div class="${confidenceBarColor} h-2.5 rounded-full" style="width: ${confidenceValue}%"></div>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-3 mt-4 pt-4 border-t border-slate-700">
                     <button id="getExternalAnalysisBtn" data-home-team="${homeTeam}" data-away-team="${awayTeam}" class="flex items-center justify-center w-full text-center bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-4 rounded-lg transition">
                         <i data-lucide="search" class="w-4 h-4 mr-2"></i> Fetch Other Predictions
                     </button>
                     <textarea id="external-analysis-container" class="mt-4 w-full p-3 h-32 bg-slate-700 border border-slate-600 rounded-lg text-sm text-slate-300 hidden" readonly></textarea>
                </div>
                ${(urlSource && urlSource.startsWith('http')) ? `
                <div class="md:col-span-3 mt-6"><a href="${urlSource}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center w-full text-center bg-slate-600 hover:bg-slate-700 text-white font-bold py-2.5 px-4 rounded-lg transition">
                    View Original Source
                    <i data-lucide="external-link" class="w-4 h-4 ml-2"></i>
                </a></div>` : ''}
            `;
            
            lucide.createIcons();
            dom.modal.classList.remove('hidden');
            setTimeout(() => {
                dom.modalOverlay.classList.remove('opacity-0');
                dom.modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0', '-translate-y-10');
            }, 10);

            document.getElementById('getExternalAnalysisBtn').addEventListener('click', handleExternalAnalysisClick);
            document.getElementById('fetchOutcomeBtn')?.addEventListener('click', handleFetchOutcomeClick);
        }

        function closeModal() {
            dom.modalOverlay.classList.add('opacity-0');
            dom.modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0', '-translate-y-10');
            setTimeout(() => { dom.modal.classList.add('hidden'); }, 300);
        }

        // --- GEMINI API & EXTERNAL ANALYSIS ---
        async function handleExternalAnalysisClick(e) {
            const button = e.currentTarget;
            const { homeTeam, awayTeam } = button.dataset;
            const textbox = document.getElementById('external-analysis-container');

            button.disabled = true;
            button.innerHTML = `<div class="loader !w-5 !h-5 !border-2 !border-t-white/50 mx-auto"></div>`;
            textbox.value = 'Searching for external analysis...';
            textbox.classList.remove('hidden');

            try {
                const result = await fetchExternalAnalysis(homeTeam, awayTeam);
                let resultText = `Analysis Summary:\n${result.text}`;

                if (result.sources && result.sources.length > 0) {
                    resultText += `\n\nSources:\n`;
                    result.sources.forEach(source => {
                         resultText += `- ${source.title}: ${source.uri}\n`;
                    });
                }
                textbox.value = resultText;

            } catch (error) {
                console.error("External analysis failed:", error);
                textbox.value = "Sorry, could not retrieve external analysis at this time.";
            } finally {
                button.disabled = false;
                 button.innerHTML = `<i data-lucide="search" class="w-4 h-4 mr-2"></i> Fetch Other Predictions`;
                 lucide.createIcons();
            }
        }

        async function fetchExternalAnalysis(homeTeam, awayTeam, retries = 3, delay = 1000) {
            const apiKey = ""; // Canvas provides this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are a sports analytics assistant. Based on the provided search results, provide a concise, one-paragraph summary of the match prediction. Focus on the most likely outcome, key stats, or expert opinions found. Mention the source if possible.";
            const userQuery = `"${homeTeam}" vs "${awayTeam}" match prediction statarea.com`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                 if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchExternalAnalysis(homeTeam, awayTeam, retries - 1, delay * 2);
                    }
                    let errorDetail = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.error?.message || JSON.stringify(errorData);
                    } catch (e) { /* Ignore if parsing fails */ }
                    throw new Error(`API Error (${response.status}): ${errorDetail}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                            .filter(source => source.uri && source.title);
                    }
                    return { text, sources };
                } else {
                    throw new Error("No content generated in the response.");
                }
            } catch (error) {
                console.error("Fetch failed:", error);
                throw error;
            }
        }
        
        async function fetchMatchOutcome(homeTeam, awayTeam, date, retries = 3, delay = 1000) {
            const apiKey = ""; // Canvas provides this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = `You are a sports data API. Your task is to find the final score of a specific football match. Respond ONLY with the score in the format "HomeScore - AwayScore" (e.g., "2 - 1"). If the match has not been played yet, respond with "TBD". If you cannot find the definitive score, respond with "Not Found". Do not add any extra words, explanations, or punctuation.`;
            const userQuery = `final score for football match ${homeTeam} vs ${awayTeam} on ${date}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchMatchOutcome(homeTeam, awayTeam, date, retries - 1, delay * 2);
                    }
                    let errorDetail = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.error?.message || JSON.stringify(errorData);
                    } catch (e) { /* Ignore if parsing fails */ }
                    throw new Error(`API Error (${response.status}): ${errorDetail}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return { text: candidate.content.parts[0].text };
                } else {
                    throw new Error("No content generated in the response.");
                }
            } catch (error) {
                console.error("Fetch failed:", error);
                throw error;
            }
        }

        // --- ADMIN & COLUMN MANAGEMENT ---
        function loadColumnConfiguration() {
            const savedMain = localStorage.getItem('mainTableHeaders');
            mainTableHeaders = savedMain ? JSON.parse(savedMain) : [...DEFAULT_MAIN_TABLE_HEADERS];
        }

        function saveColumnConfiguration() {
            const mainContainer = dom.mainTableAdminContainer;
            const newMainHeaders = Array.from(mainContainer.querySelectorAll('li'))
                .filter(li => li.querySelector('input[type="checkbox"]').checked)
                .map(li => li.dataset.column);
            
            mainTableHeaders = newMainHeaders;

            localStorage.setItem('mainTableHeaders', JSON.stringify(mainTableHeaders));

            renderMainTableHeaders();
            applyDashboardFilters();

            dom.adminMessage.textContent = 'Settings saved successfully!';
            setTimeout(() => { dom.adminMessage.textContent = ''; }, 3000);
        }

        function resetColumnConfiguration() {
            mainTableHeaders = [...DEFAULT_MAIN_TABLE_HEADERS];
            localStorage.removeItem('mainTableHeaders');
            
            renderAdminUI();
            renderMainTableHeaders();
            applyDashboardFilters();
            
            dom.adminMessage.textContent = 'Settings reset to default.';
            setTimeout(() => { dom.adminMessage.textContent = ''; }, 3000);
        }
        
        function renderAdminUI() {
            const createColumnItem = (columnName, isVisible) => `
                <li data-column="${columnName}" class="draggable-item flex items-center justify-between p-2 bg-slate-800 rounded-md shadow-sm border border-slate-700" draggable="true">
                    <div class="flex items-center">
                        <i data-lucide="grip-vertical" class="w-5 h-5 text-slate-400 mr-2"></i>
                        <label for="check-${columnName.replace(/\s+/g, '-')}" class="text-sm font-medium text-slate-300">${columnName}</label>
                    </div>
                    <input type="checkbox" id="check-${columnName.replace(/\s+/g, '-')}" ${isVisible ? 'checked' : ''} class="h-4 w-4 rounded border-slate-500 bg-slate-700 text-cyan-600 focus:ring-cyan-500">
                </li>
            `;
            
            dom.mainTableAdminContainer.innerHTML = ALL_POSSIBLE_COLUMNS
                .map(col => createColumnItem(col, mainTableHeaders.includes(col)))
                .join('');
            
            dom.highConfidenceTableAdminContainer.innerHTML = `<p class="text-slate-400 text-sm">This section has been removed.</p>`;
            
            lucide.createIcons();
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const containers = [dom.mainTableAdminContainer];
            containers.forEach(container => {
                let draggingElement = null;
                container.addEventListener('dragstart', e => {
                    draggingElement = e.target;
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                });

                container.addEventListener('dragend', e => {
                    e.target.classList.remove('dragging');
                });

                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    const target = e.target.closest('.draggable-item');
                    if (target && target !== draggingElement) {
                        const rect = target.getBoundingClientRect();
                        const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > .5;
                        if (next) {
                            container.insertBefore(draggingElement, target.nextSibling);
                        } else {
                            container.insertBefore(draggingElement, target);
                        }
                    }
                });
            });
        }
        

        // --- ALL EVENTS TAB FUNCTIONS (NEWLY INTEGRATED) ---
        function initializeAppEvents() {
            let ae_allEvents = [];
            let ae_filteredEvents = [];
            let ae_currentPage = 1;
            const ae_eventsPerPage = 20;

            const ae_dom = {
                dateFilter: document.getElementById('ae-dateFilter'),
                goalsTipFilter: document.getElementById('ae-goalsTipFilter'),
                accuracyFilter: document.getElementById('ae-accuracyFilter'),
                predictionFilter: document.getElementById('ae-predictionFilter'),
                analyzedPredictionFilter: document.getElementById('ae-analyzedPredictionFilter'),
                winningMarginFilter: document.getElementById('ae-winningMarginFilter'),
                teamSearch: document.getElementById('ae-teamSearch'),
                resetBtn: document.getElementById('ae-resetFiltersBtn'),
                dataTableBody: document.getElementById('ae-dataTableBody'),
                prevBtn: document.getElementById('ae-prevBtn'),
                nextBtn: document.getElementById('ae-nextBtn'),
                pageInfo: document.getElementById('ae-pageInfo'),
                modal: document.getElementById('ae-popupModal'),
                closeModalBtn: document.getElementById('ae-closeModalBtn'),
                modalFinalScore: document.getElementById('ae-modalFinalScore'),
                modalAPrScore: document.getElementById('ae-modalAPrScore'),
                modalHPrScore: document.getElementById('ae-modalHPrScore'),
                modalAFinal: document.getElementById('ae-modalAFinal'),
                modalHFinal: document.getElementById('ae-modalHFinal'),
                modalOddsH: document.getElementById('ae-modalOddsH'),
                modalOddsD: document.getElementById('ae-modalOddsD'),
                modalOddsA: document.getElementById('ae-modalOddsA'),
                modalConfidence: document.getElementById('ae-modalConfidence'),
                modalPrediction: document.getElementById('ae-modalPrediction'),
                modalMatchURL: document.getElementById('ae-modalMatchURL')
            };
            
            const ae_updateCards = (data) => {
                 const cardData = data.map(obj => {
                    const newRow = [];
                    // This mapping needs to be correct based on the object keys from the CSV
                    originalHeaders.forEach(header => newRow.push(obj[header] || ''));
                    return newRow;
                });
                updateCardCounts('ae-total-events', 'ae-prediction-counts', cardData, 'Analyzed Prediction');
            }


            const ae_populateFilters = () => {
                const filtersToPopulate = [
                    { id: 'ae-dateFilter', column: 'Date' },
                    { id: 'ae-goalsTipFilter', column: 'Goals Tip' },
                    { id: 'ae-predictionFilter', column: 'Prediction' },
                    { id: 'ae-winningMarginFilter', column: 'Winning Margin' },
                    { id: 'ae-analyzedPredictionFilter', column: 'Analyzed Prediction' }
                ];
                
                filtersToPopulate.forEach(config => {
                    const selectElement = document.getElementById(config.id);
                    if (!selectElement) return;

                    const uniqueValues = [...new Set(ae_allEvents.map(item => item[config.column]).filter(Boolean))];
                    
                    while (selectElement.options.length > 1) {
                        selectElement.remove(1);
                    }
                    
                    if (config.column === 'Date') {
                        uniqueValues.sort((a, b) => new Date(b) - new Date(a));
                    } else {
                        uniqueValues.sort();
                    }

                    uniqueValues.forEach(val => {
                        selectElement.add(new Option(val, val));
                    });
                });

                const accuracyFilter = ae_dom.accuracyFilter;
                while (accuracyFilter.options.length > 1) {
                    accuracyFilter.remove(1);
                }
                accuracyFilter.add(new Option('Accurate', 'Accurate'));
                accuracyFilter.add(new Option('Inaccurate', 'Inaccurate'));
            };
            
            const ae_fetchData = async () => {
                const originalUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRT3kZ4vvPbc6XIsOlmhLE-jGL0o5Ut4VtTE2Z3SAh1FZAmKc8uW39DNAyr33GuwGJfxW0U7SPN9Blz/pub?gid=2114931346&single=true&output=csv';

                try {
                    const response = await fetch(originalUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const text = await response.text();
                    
                    const rows = text.split('\n').map(row => row.trim()).filter(row => row);
                    const headers = rows[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(header => header.trim().replace(/"/g, ''));
                    const data = rows.slice(1).map(row => {
                        const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(value => value.trim().replace(/"/g, ''));
                        let obj = {};
                        headers.forEach((header, i) => {
                            obj[header] = values[i] || '';
                        });
                        return obj;
                    });
                    ae_allEvents = data;
                    ae_filteredEvents = ae_allEvents;
                    ae_populateFilters();
                    ae_renderTable();
                } catch (error) {
                    console.error('Could not fetch the data for All Events tab:', error);
                    ae_dom.dataTableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-red-500">Failed to load data. Please try again later.</td></tr>`;
                }
            };

            const ae_renderTable = () => {
                ae_dom.dataTableBody.innerHTML = '';
                const startIndex = (ae_currentPage - 1) * ae_eventsPerPage;
                const endIndex = startIndex + ae_eventsPerPage;
                const eventsToShow = ae_filteredEvents.slice(startIndex, endIndex);
                
                ae_updateCards(ae_filteredEvents);

                if (eventsToShow.length === 0) {
                    ae_dom.dataTableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-slate-400">No events found matching the filters.</td></tr>`;
                    ae_dom.pageInfo.innerText = '';
                    ae_dom.prevBtn.disabled = true;
                    ae_dom.nextBtn.disabled = true;
                    return;
                }

                eventsToShow.forEach((item, index) => {
                    const resultText = item.Result || '';
                    const getResultColor = (result) => {
                        if (result.toLowerCase() === 'won') return 'bg-emerald-500/10 text-emerald-400';
                        if (result.toLowerCase() === 'lost') return 'bg-rose-500/10 text-rose-400';
                        if (result.toLowerCase() === 'draw') return 'bg-yellow-500/10 text-yellow-400';
                        return 'bg-slate-600 text-slate-300';
                    };
                    const resultClass = getResultColor(resultText);
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-700 cursor-pointer transition-colors duration-200';
                    
                    row.onclick = () => ae_openModal(item);

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-200">${item.Date || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${item.Home || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${item.Away || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400 hidden md:table-cell">${item['Level of Confidence'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400 hidden md:table-cell">${item['Winning Margin'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400 hidden md:table-cell">${item['Total Goals'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400 hidden lg:table-cell">${item['Prediction'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400 hidden lg:table-cell">${item['FT Outcome'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${resultClass}">${resultText}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button class="text-cyan-400 hover:text-cyan-300 font-medium transition-colors duration-200" onclick="event.stopPropagation();">View</button>
                        </td>`;
                    ae_dom.dataTableBody.appendChild(row);
                });
                ae_updatePaginationControls();
            };

            const ae_updatePaginationControls = () => {
                const totalPages = Math.ceil(ae_filteredEvents.length / ae_eventsPerPage);
                ae_dom.pageInfo.innerText = `Page ${ae_currentPage} of ${totalPages}`;
                ae_dom.prevBtn.disabled = ae_currentPage === 1;
                ae_dom.nextBtn.disabled = ae_currentPage >= totalPages;
            };

            const ae_goToPreviousPage = () => {
                if (ae_currentPage > 1) {
                    ae_currentPage--;
                    ae_renderTable();
                }
            };

            const ae_goToNextPage = () => {
                const totalPages = Math.ceil(ae_filteredEvents.length / ae_eventsPerPage);
                if (ae_currentPage < totalPages) {
                    ae_currentPage++;
                    ae_renderTable();
                }
            };

            const ae_resetFilters = () => {
                ae_dom.dateFilter.value = '';
                ae_dom.goalsTipFilter.value = '';
                ae_dom.accuracyFilter.value = '';
                ae_dom.predictionFilter.value = '';
                ae_dom.analyzedPredictionFilter.value = '';
                ae_dom.winningMarginFilter.value = '';
                ae_dom.teamSearch.value = '';
                ae_applyFilters();
            };

            const ae_applyFilters = () => {
                const dateFilter = ae_dom.dateFilter.value;
                const goalsTipFilter = ae_dom.goalsTipFilter.value;
                const accuracyFilter = ae_dom.accuracyFilter.value;
                const predictionFilter = ae_dom.predictionFilter.value;
                const analyzedPredictionFilter = ae_dom.analyzedPredictionFilter.value;
                const winningMarginFilter = ae_dom.winningMarginFilter.value;
                const teamSearch = ae_dom.teamSearch.value.toLowerCase();

                ae_filteredEvents = ae_allEvents.filter(item => {
                    const matchDate = !dateFilter || item.Date === dateFilter;
                    const matchGoalsTip = !goalsTipFilter || (item['Goals Tip'] || '') === goalsTipFilter;
                    const result = item.Result || '';
                    const matchAccuracy = !accuracyFilter || (accuracyFilter === 'Accurate' && result.toLowerCase() === 'won') || (accuracyFilter === 'Inaccurate' && (result.toLowerCase() === 'lost' || result.toLowerCase() === 'draw'));
                    const matchPrediction = !predictionFilter || (item['Prediction'] || '') === predictionFilter;
                    const matchAnalyzedPrediction = !analyzedPredictionFilter || (item['Analyzed Prediction'] || '') === analyzedPredictionFilter;
                    const matchWinningMargin = !winningMarginFilter || (item['Winning Margin'] || '') === winningMarginFilter;
                    const matchTeam = !teamSearch || (item.Home || '').toLowerCase().includes(teamSearch) || (item.Away || '').toLowerCase().includes(teamSearch);
                    return matchDate && matchGoalsTip && matchAccuracy && matchPrediction && matchWinningMargin && matchTeam && matchAnalyzedPrediction;
                });
                ae_currentPage = 1;
                ae_renderTable();
            };

            const ae_openModal = (data) => {
                ae_dom.modalFinalScore.innerText = data['Final Score / Time'] || '';
                ae_dom.modalAPrScore.innerText = data['A_Pr_Score'] || '';
                ae_dom.modalHPrScore.innerText = data['H_Pr_Score'] || '';
                ae_dom.modalAFinal.innerText = data['A_Final'] || '';
                ae_dom.modalHFinal.innerText = data['H_Final'] || '';
                ae_dom.modalOddsH.innerText = data['Odds_H'] || '';
                ae_dom.modalOddsD.innerText = data['Odds_D'] || '';
                ae_dom.modalOddsA.innerText = data['Odds_A'] || '';
                ae_dom.modalConfidence.innerText = data['Confidence'] || '';
                ae_dom.modalPrediction.innerText = data['Prediction'] || '';
                ae_dom.modalMatchURL.href = data['MatchURL'] || '#';
                ae_dom.modal.style.display = 'flex';
            };

            const ae_closeModal = () => {
                 ae_dom.modal.style.display = 'none';
            };

            // --- Event Listeners for this tab ---
            const allFilters = [
                ae_dom.dateFilter, 
                ae_dom.goalsTipFilter, 
                ae_dom.accuracyFilter, 
                ae_dom.predictionFilter, 
                ae_dom.winningMarginFilter, 
                ae_dom.teamSearch,
                ae_dom.analyzedPredictionFilter
            ];
            allFilters.forEach(el => {
                el.addEventListener('input', ae_applyFilters);
                el.addEventListener('change', ae_applyFilters);
            });
            ae_dom.resetBtn.addEventListener('click', ae_resetFilters);
            ae_dom.prevBtn.addEventListener('click', ae_goToPreviousPage);
            ae_dom.nextBtn.addEventListener('click', ae_goToNextPage);
            ae_dom.closeModalBtn.addEventListener('click', ae_closeModal);
            ae_dom.modal.addEventListener('click', (event) => {
                if (event.target === ae_dom.modal) {
                    ae_closeModal();
                }
            });

            // --- Initial call ---
            ae_fetchData();
            allEventsInitialized = true;
        }

        // --- BEST ANALYSIS TAB FUNCTIONS ---
        function initializeBestAnalysis() {
            // State for this tab
            let ba_rawData = [];
            let ba_filteredData = [];
            let ba_currentSortColumn = 'Confidence';
            let ba_currentSortDirection = 'desc';
            let ba_currentPage = 1;
            const ba_rowsPerPage = 20;
            let ba_currentTab = 'bestTips';
            let ba_accuracyPieChart, ba_confidenceBarChart, ba_accuracyLineChart, ba_analyzedPredictionChart;

            // DOM elements for this tab
            const ba_dom = {
                dateFilter: document.getElementById('ba-dateFilter'),
                leagueFilter: document.getElementById('ba-leagueFilter'),
                analyzedPredictionFilter: document.getElementById('ba-analyzedPredictionFilter'),
                goalTipFilter: document.getElementById('ba-goalTipFilter'),
                refreshButton: document.getElementById('ba-refreshButton'),
                teamSearch: document.getElementById('ba-teamSearch'),
                statusFilter: document.getElementById('ba-statusFilter'),
                tableTabBtn: document.getElementById('ba-tableTabBtn'),
                bestTipsTabBtn: document.getElementById('ba-bestTipsTabBtn'),
                analyticsTabBtn: document.getElementById('ba-analyticsTabBtn'),
                tableContent: document.getElementById('ba-tableContent'),
                bestTipsContent: document.getElementById('ba-bestTipsContent'),
                analyticsContent: document.getElementById('ba-analyticsContent'),
                matchTableBody: document.getElementById('ba-matchTableBody'),
                bestTipsTableBody: document.getElementById('ba-bestTipsTableBody'),
                tablePagination: document.getElementById('ba-tablePagination'),
                bestTipsPagination: document.getElementById('ba-bestTipsPagination'),
                matchModal: document.getElementById('ba-matchModal'),
                closeModalBtn: document.getElementById('ba-closeModal'),
                modalContent: document.getElementById('ba-modalContent'),
                modalTitle: document.getElementById('ba-modalTitle'),
            };

            // Functions for this tab
            async function ba_fetchData() {
                try {
                    const GOOGLE_SHEET_URL_BA = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vStqwpsns8hisGU7fbDbTh5I-yuho4Xxf1KGFDS1GtG6ewELvVzQYpmqpJnnsoUoLMd-g3iH1QIQ9EU/pub?gid=1066037497&single=true&output=csv';
                    const response = await fetch(`${GOOGLE_SHEET_URL_BA}&t=${new Date().getTime()}`);
                    const csvText = await response.text();
                    const parsedData = ba_parseCSV(csvText);

                    ba_rawData = parsedData.map(row => ({
                        Date: row.Date,
                        League: row.League,
                        HomeTeam: row['Home Team'],
                        AwayTeam: row['Away Team'],
                        OddsH: row['Home Odds'],
                        OddsD: row['Draw Odds'],
                        OddsA: row['Away Odds'],
                        Confidence: parseFloat(row['Confidence %']?.replace('%', '')) || 0,
                        AnalyzedPrediction: row['Analyzed Prediction'],
                        MatchResult: row['Match Result'],
                        PredictionStatus: row['Prediction Status'],
                        HomeForm: row['Home Form'],
                        HomeFormRate: row['Home Form Rate'],
                        AwayForm: row['Away Form'],
                        AwayFormRate: row['Away Form Rate'],
                        GoalsTip: row['Goals Tip'],
                        HomeTips: row['Home Tips'],
                        AwayTips: row['Away Tips'],
                        DrawTips: row['Draw Tips']
                    }));
                    
                    ba_filteredData = [...ba_rawData];
                    ba_populateFilters();
                    ba_updateUI();
                } catch (error) {
                    console.error('Best Analysis Fetch Error:', error);
                }
            }

            function ba_parseCSV(csv) {
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) return [];
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                return lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                    let obj = {};
                    headers.forEach((header, i) => obj[header] = values[i] || '');
                    return obj;
                });
            }

            function ba_populateFilters() {
                const dates = [...new Set(ba_rawData.map(item => item.Date))].filter(Boolean);
                dates.sort((a,b) => new Date(b) - new Date(a));
                ba_dom.dateFilter.innerHTML = '<option value="">All Dates</option>' + dates.map(d => `<option value="${d}">${d}</option>`).join('');

                const leagues = [...new Set(ba_rawData.map(item => item.League))].filter(Boolean);
                ba_dom.leagueFilter.innerHTML = '<option value="">All Leagues</option>' + leagues.map(l => `<option value="${l}">${l}</option>`).join('');

                const predictions = [...new Set(ba_rawData.map(item => item.AnalyzedPrediction))].filter(Boolean);
                ba_dom.analyzedPredictionFilter.innerHTML = '<option value="">All Predictions</option>' + predictions.map(p => `<option value="${p}">${p}</option>`).join('');

                const goalTips = [...new Set(ba_rawData.map(item => item.GoalsTip))].filter(Boolean);
                ba_dom.goalTipFilter.innerHTML = '<option value="">All Goal Tips</option>' + goalTips.map(t => `<option value="${t}">${t}</option>`).join('');
            }
            
            function ba_applyFiltersAndSort() {
                let temp = [...ba_rawData];
                const dateValue = ba_dom.dateFilter.value;
                
                if (dateValue) temp = temp.filter(item => item.Date === dateValue);
                if (ba_dom.leagueFilter.value) temp = temp.filter(item => item.League === ba_dom.leagueFilter.value);
                if (ba_dom.analyzedPredictionFilter.value) temp = temp.filter(item => item.AnalyzedPrediction === ba_dom.analyzedPredictionFilter.value);
                if (ba_dom.goalTipFilter.value) temp = temp.filter(item => item.GoalsTip === ba_dom.goalTipFilter.value);
                
                const searchTermInput = document.getElementById('ba-teamSearch');
                if (searchTermInput) {
                    const searchTerm = searchTermInput.value.toLowerCase();
                    if (searchTerm) temp = temp.filter(item => item.HomeTeam.toLowerCase().includes(searchTerm) || item.AwayTeam.toLowerCase().includes(searchTerm));
                }
                
                const statusFilterInput = document.getElementById('ba-statusFilter');
                if (statusFilterInput && statusFilterInput.value) {
                     temp = temp.filter(item => item.PredictionStatus === statusFilterInput.value);
                }
                
                if (ba_currentSortColumn) {
                    temp.sort((a, b) => {
                        let valA = a[ba_currentSortColumn];
                        let valB = b[ba_currentSortColumn];

                        // Convert to number if the value is numeric, for correct sorting
                        const numA = parseFloat(valA);
                        const numB = parseFloat(valB);
                        
                        if (!isNaN(numA) && !isNaN(numB)) {
                            valA = numA;
                            valB = numB;
                        } else if (ba_currentSortColumn === 'Date') {
                            valA = new Date(valA);
                            valB = new Date(valB);
                        }


                        if (valA < valB) return ba_currentSortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return ba_currentSortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                ba_filteredData = temp;
                ba_currentPage = 1;
                ba_updateUI();
            }

            function ba_updateUI() {
                ba_renderDashboard();
                if (ba_currentTab === 'table') ba_renderTable();
                else if (ba_currentTab === 'bestTips') ba_renderBestTipsTable();
                else ba_renderCharts();
                ba_updateTabDisplay();
                ba_updateSortHeaders();
            }
            
            function ba_renderTable(isBestTips = false) {
                const tableBody = isBestTips ? ba_dom.bestTipsTableBody : ba_dom.matchTableBody;
                const paginationContainer = isBestTips ? ba_dom.bestTipsPagination : ba_dom.tablePagination;
                tableBody.innerHTML = '';
                
                let dataToRender = isBestTips
                    ? ba_filteredData.filter(match => ['Home Tip', 'Home Best Tip', 'Best Away Tip'].includes(match.AnalyzedPrediction))
                    : ba_filteredData;

                const totalPages = Math.ceil(dataToRender.length / ba_rowsPerPage);
                ba_currentPage = Math.min(ba_currentPage, totalPages || 1);
                const start = (ba_currentPage - 1) * ba_rowsPerPage;
                const paginatedData = dataToRender.slice(start, start + ba_rowsPerPage);

                paginatedData.forEach(match => {
                    const row = document.createElement('tr');
                    let statusColor = 'text-slate-300';
                    if (match.PredictionStatus === 'Won') statusColor = 'text-green-400';
                    if (match.PredictionStatus === 'Lost') statusColor = 'text-red-400';

                    row.className = `hover:bg-slate-700 cursor-pointer transition-colors duration-200 ${statusColor}`;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${match.Date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${match.HomeTeam}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${parseInt(match.HomeFormRate)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${match.AwayTeam}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${parseInt(match.AwayFormRate)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${match.OddsH}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${match.OddsD}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${match.OddsA}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${match.Confidence}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${match.AnalyzedPrediction}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${match.MatchResult}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">${match.PredictionStatus}</td>
                    `;
                    row.addEventListener('click', () => ba_showMatchModal(match));
                    tableBody.appendChild(row);
                });
                
                paginationContainer.innerHTML = `
                    <button class="p-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 transition-colors duration-200 ${ba_currentPage === 1 ? 'opacity-50' : ''}" ${ba_currentPage === 1 ? 'disabled' : ''} data-page-nav="prev">Previous</button>
                    <span class="text-sm text-slate-400">Page ${ba_currentPage} of ${totalPages || 1}</span>
                    <button class="p-2 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 transition-colors duration-200 ${ba_currentPage === totalPages || totalPages === 0 ? 'opacity-50' : ''}" ${ba_currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} data-page-nav="next">Next</button>
                `;

                paginationContainer.querySelector('[data-page-nav="prev"]').addEventListener('click', () => { ba_currentPage--; ba_renderTable(isBestTips); });
                paginationContainer.querySelector('[data-page-nav="next"]').addEventListener('click', () => { ba_currentPage++; ba_renderTable(isBestTips); });
            }


            function ba_renderBestTipsTable() { ba_renderTable(true); }
            
            function ba_renderDashboard() {
                const totalMatchesCount = ba_filteredData.length;
                const wonCount = ba_filteredData.filter(m => m.PredictionStatus === 'Won').length;
                const lostCount = ba_filteredData.filter(m => m.PredictionStatus === 'Lost').length;
                const pendingCount = ba_filteredData.filter(m => m.PredictionStatus === 'Awaiting Results').length;
                const wonPercentage = totalMatchesCount > 0 ? ((wonCount / totalMatchesCount) * 100).toFixed(1) : 0;
                const avgConfidence = ba_filteredData.reduce((sum, m) => sum + (m.Confidence || 0), 0) / (totalMatchesCount || 1);

                document.getElementById('ba-totalMatches').textContent = totalMatchesCount;
                document.getElementById('ba-wonStatus').textContent = wonCount;
                document.getElementById('ba-lostStatus').textContent = lostCount;
                document.getElementById('ba-pendingStatus').textContent = pendingCount;
                document.getElementById('ba-wonPercentage').textContent = `${wonPercentage}% Won`;
                document.getElementById('ba-avgConfidence').textContent = `${avgConfidence.toFixed(1)}%`;

                const oddsTips = { 'Home': 0, 'Draw': 0, 'Away': 0 };
                ba_filteredData.forEach(match => {
                    const homeOdds = parseFloat(match.OddsH);
                    const drawOdds = parseFloat(match.OddsD);
                    const awayOdds = parseFloat(match.OddsA);
                    if (!isNaN(homeOdds) && !isNaN(drawOdds) && !isNaN(awayOdds)) {
                        const minOdds = Math.min(homeOdds, drawOdds, awayOdds);
                        if (minOdds === homeOdds) oddsTips['Home']++;
                        else if (minOdds === drawOdds) oddsTips['Draw']++;
                        else if (minOdds === awayOdds) oddsTips['Away']++;
                    }
                });

                const tipsHtml = Object.entries(oddsTips).map(([tip, count]) => `
                    <div class="text-center">
                        <span class="text-xl font-bold text-slate-200">${count}</span>
                        <p class="text-sm text-slate-400">${tip}</p>
                    </div>`).join('');
                document.getElementById('ba-tipsDistribution').innerHTML = tipsHtml;
            }


            function ba_renderCharts() { /* ... implementation adapted for dark theme ... */ }
            function ba_showMatchModal(match) { /* ... implementation adapted for dark theme ... */ }

            function ba_handleSortClick(e) {
                const header = e.target.closest('.sort-header');
                if (!header) return;

                const sortKey = header.dataset.sortKey;

                if (ba_currentSortColumn === sortKey) {
                    ba_currentSortDirection = ba_currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    ba_currentSortColumn = sortKey;
                    ba_currentSortDirection = 'asc';
                }
                
                ba_applyFiltersAndSort(); 
            }

            function ba_updateSortHeaders() {
                const headers = document.querySelectorAll('#content-best-analysis .sort-header');
                headers.forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                    if (header.dataset.sortKey === ba_currentSortColumn) {
                        header.classList.add(ba_currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            }


            // Event Listeners for this tab
            ba_dom.refreshButton.addEventListener('click', ba_fetchData);
            [ba_dom.dateFilter, ba_dom.leagueFilter, ba_dom.analyzedPredictionFilter, ba_dom.goalTipFilter, ba_dom.teamSearch, ba_dom.statusFilter].forEach(el => {
                if(el) {
                    el.addEventListener('change', ba_applyFiltersAndSort);
                    if (el.type === 'text') el.addEventListener('input', ba_applyFiltersAndSort);
                }
            });
             ba_dom.bestTipsTabBtn.addEventListener('click', () => { ba_currentTab = 'bestTips'; ba_updateUI(); });
             ba_dom.tableTabBtn.addEventListener('click', () => { ba_currentTab = 'table'; ba_updateUI(); });
             ba_dom.analyticsTabBtn.addEventListener('click', () => { ba_currentTab = 'analytics'; ba_updateUI();});
             ba_dom.closeModalBtn.addEventListener('click', () => ba_dom.matchModal.style.display = 'none');

             document.querySelector('#ba-bestTipsTable thead').addEventListener('click', ba_handleSortClick);
             document.querySelector('#ba-matchTable thead').addEventListener('click', ba_handleSortClick);

             function ba_updateTabDisplay() {
                ba_dom.tableContent.classList.toggle('hidden', ba_currentTab !== 'table');
                ba_dom.bestTipsContent.classList.toggle('hidden', ba_currentTab !== 'bestTips');
                ba_dom.analyticsContent.classList.toggle('hidden', ba_currentTab !== 'analytics');

                const allTabButtons = [ba_dom.tableTabBtn, ba_dom.bestTipsTabBtn, ba_dom.analyticsTabBtn];
                allTabButtons.forEach(btn => {
                    btn.classList.remove('bg-green-600', 'text-white');
                    btn.classList.add('text-slate-400', 'hover:text-slate-300');
                });

                const activeBtn = document.getElementById(`ba-${ba_currentTab}TabBtn`);
                if (activeBtn) {
                     activeBtn.classList.remove('text-slate-400', 'hover:text-slate-300');
                     activeBtn.classList.add('bg-green-600', 'text-white');
                }
            }


            // Initial Call
            ba_fetchData();
            bestAnalysisInitialized = true;
            // ADDED: Auto-refresh data every 60 seconds
            setInterval(ba_fetchData, 60000); 
        }

        // --- EVENT LISTENERS ---

        dom.showSignup.addEventListener('click', (e) => { e.preventDefault(); switchView('signup'); });
        dom.showLogin.addEventListener('click', (e) => { e.preventDefault(); switchView('login'); });
        dom.loginForm.addEventListener('submit', handleLogin);
        dom.signupForm.addEventListener('submit', handleSignup);
        dom.logoutBtn.addEventListener('click', handleLogout);
        dom.sidebarNav.addEventListener('click', handleSidebarClick);
        
        dom.dashboardFilterInputs.forEach(input => {
            input.addEventListener('input', handleDashboardFilterChange);
            input.addEventListener('change', handleDashboardFilterChange);
        });

        dom.resetFiltersBtn.addEventListener('click', resetDashboardFilters);

        dom.analyticsDateFilter.addEventListener('change', updateAnalytics);
        dom.analyticsTotalGoalsFilter.addEventListener('change', updateAnalytics);
        dom.tableHeader.addEventListener('click', handleDashboardSort);
        dom.tableBody.addEventListener('click', handleMainTableRowClick);
        dom.prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderMainTablePage(); }});
        dom.nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(dashboardFilteredData.length / ROWS_PER_PAGE);
            if (currentPage < totalPages) { currentPage++; renderMainTablePage(); }
        });
        
        dom.modalCloseBtn.addEventListener('click', closeModal);
        dom.modalOverlay.addEventListener('click', closeModal);
        document.addEventListener('keydown', (e) => { if (e.key === "Escape" && !dom.modal.classList.contains('hidden')) closeModal(); });
        dom.saveColumnsBtn.addEventListener('click', saveColumnConfiguration);
        dom.resetColumnsBtn.addEventListener('click', resetColumnConfiguration);
        dom.syncDataBtn.addEventListener('click', handleSyncClick);

        // --- INITIALIZATION ---
        if (localStorage.getItem('loggedInUser')) {
            showDashboard();
        } else {
            showAuth();
        }
    });
    </script>
</body>
</html>
